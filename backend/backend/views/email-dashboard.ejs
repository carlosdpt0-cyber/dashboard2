<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Chat Interno - B7Uno Casino' %></title>
    
    <style>
        :root[data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-tertiary: #888888;
            --accent-primary: #D4AF37;
            --accent-secondary: #FFD700;
            --accent-hover: #f5d042;
            --border-color: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.05);
            --card-bg: rgba(30, 30, 30, 0.8);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --hover-bg: rgba(255, 255, 255, 0.05);
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --success: #28a745;
            --success-light: rgba(40, 167, 69, 0.1);
            --warning: #ffc107;
            --warning-light: rgba(255, 193, 7, 0.1);
            --danger: #dc3545;
            --danger-light: rgba(220, 53, 69, 0.1);
            --info: #17a2b8;
            --info-light: rgba(23, 162, 184, 0.1);
            --photo-gradient: linear-gradient(135deg, #D4AF37, #FFD700);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; height: 100vh; overflow: hidden; }
        
        .chat-container { display: flex; height: 100vh; }
        .contacts-sidebar { width: 300px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; }
        .chat-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .chat-header h2 { font-size: 20px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .contacts-search { padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
        .search-input { width: 100%; padding: 10px 15px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; }
        .search-input:focus { outline: none; border-color: var(--accent-primary); }
        .contacts-list { flex: 1; overflow-y: auto; }
        
        .contact-item { display: flex; align-items: center; gap: 12px; padding: 15px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: all 0.3s; }
        .contact-item:hover { background: var(--hover-bg); }
        .contact-item.active { background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--accent-primary); }
        .contact-avatar { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; flex-shrink: 0; }
        .contact-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .contact-avatar.default { background: var(--photo-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; display: flex; align-items: center; justify-content: space-between; }
        .contact-role { font-size: 12px; color: var(--text-secondary); }
        .contact-last-message { font-size: 12px; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px; }
        .contact-unread { background: var(--accent-primary); color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; font-weight: 600; }
        
        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); }
        .chat-header-main { padding: 20px; border-bottom: 1px solid var(--border-color); background: var(--bg-secondary); display: flex; align-items: center; justify-content: space-between; }
        .chat-contact-info { display: flex; align-items: center; gap: 12px; }
        .chat-status { font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
        .status-online { color: var(--success); }
        .chat-actions { display: flex; gap: 10px; }
        
        .btn-icon { background: none; border: none; color: var(--text-secondary); font-size: 16px; cursor: pointer; padding: 8px; border-radius: 4px; transition: all 0.3s; }
        .btn-icon:hover { background: var(--hover-bg); color: var(--text-primary); }
        
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { display: flex; max-width: 70%; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.sent { align-self: flex-end; flex-direction: row-reverse; }
        .message.received { align-self: flex-start; }
        
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; overflow: hidden; flex-shrink: 0; margin-top: 5px; }
        .message.sent .message-avatar { margin-left: 10px; }
        .message.received .message-avatar { margin-right: 10px; }
        .message-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .message-avatar.default { background: var(--photo-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px; }
        
        .message-content { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 15px; position: relative; }
        .message.sent .message-content { background: rgba(212, 175, 55, 0.2); border-color: rgba(212, 175, 55, 0.3); }
        .message-text { font-size: 14px; line-height: 1.4; white-space: pre-wrap; word-break: break-word; }
        .message-time { font-size: 11px; color: var(--text-tertiary); margin-top: 5px; text-align: right; }
        .message.sent .message-time { color: var(--accent-primary); }
        
        .chat-input-container { padding: 20px; border-top: 1px solid var(--border-color); background: var(--bg-secondary); }
        .chat-input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
        .message-input { flex: 1; padding: 12px 15px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: none; min-height: 44px; max-height: 120px; font-family: inherit; }
        .message-input:focus { outline: none; border-color: var(--accent-primary); }
        
        .btn-send { background: var(--accent-primary); color: white; border: none; width: 44px; height: 44px; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .btn-send:hover { background: var(--accent-hover); }
        .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .empty-chat { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); text-align: center; padding: 40px; }
        .empty-chat i { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
        
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--border-color); border-radius: 50%; border-top-color: var(--accent-primary); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .no-conversation { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); font-size: 16px; }
        
        @media (max-width: 768px) {
            .contacts-sidebar { width: 100%; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; display: none; }
            .contacts-sidebar.active { display: flex; }
            .chat-main { width: 100%; }
            .btn-mobile-toggle { display: block; }
        }
        
        .btn-mobile-toggle { display: none; background: none; border: none; color: var(--text-primary); font-size: 20px; cursor: pointer; padding: 8px; }
        
        .back-button { display: flex; align-items: center; gap: 8px; color: var(--accent-primary); text-decoration: none; font-size: 14px; margin-top: 10px; }
        .back-button:hover { text-decoration: underline; }
    </style>
</head>
<body data-theme="dark">
    <div class="chat-container">
        <!-- Sidebar de contatos -->
        <div class="contacts-sidebar" id="contactsSidebar">
            <div class="chat-header">
                <h2><i class="fas fa-comments"></i> Chat Interno</h2>
                <p>Comunica√ß√£o privada com a equipa do B7Uno</p>
                <a href="/email" class="back-button">
                    <i class="fas fa-arrow-left"></i> Voltar para Email
                </a>
            </div>
            
            <div class="contacts-search">
                <input type="text" class="search-input" placeholder="Pesquisar membros da equipa..." id="searchContacts">
            </div>
            
            <div class="contacts-list" id="contactsList">
                <% if (conversations && conversations.length > 0) { %>
                    <% conversations.forEach(conv => { %>
                        <div class="contact-item" data-user-id="<%= conv.contact._id %>" onclick="openConversation('<%= conv.contact._id %>')">
                            <div class="contact-avatar <%= conv.contact.photo ? 'has-photo' : 'default' %>">
                                <% if (conv.contact.photo) { %>
                                    <img src="/uploads/<%= conv.contact.photo %>" alt="<%= conv.contact.name %>">
                                <% } else { %>
                                    <%= conv.contact.name.split(' ').map(n => n[0]).join('').toUpperCase() %>
                                <% } %>
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">
                                    <span><%= conv.contact.name %></span>
                                    <% if (conv.unreadCount > 0) { %>
                                        <span class="contact-unread"><%= conv.unreadCount %></span>
                                    <% } %>
                                </div>
                                <div class="contact-role"><%= conv.contact.role %></div>
                                <div class="contact-last-message" title="<%= conv.lastMessage.message %>">
                                    <%= conv.lastMessage.message.substring(0, 30) %>...
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } %>
                
                <!-- Todos os membros -->
                <div style="padding: 15px 20px; border-bottom: 1px solid var(--border-color);">
                    <h3 style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">
                        <i class="fas fa-user-tie"></i> Todos os Membros
                    </h3>
                </div>
                
                <% if (staffMembers && staffMembers.length > 0) { %>
                    <% staffMembers.forEach(staff => { %>
                        <div class="contact-item" data-user-id="<%= staff._id %>" onclick="openConversation('<%= staff._id %>')">
                            <div class="contact-avatar <%= staff.photo ? 'has-photo' : 'default' %>">
                                <% if (staff.photo) { %>
                                    <img src="/uploads/<%= staff.photo %>" alt="<%= staff.name %>">
                                <% } else { %>
                                    <%= staff.name.split(' ').map(n => n[0]).join('').toUpperCase() %>
                                <% } %>
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">
                                    <span><%= staff.name %></span>
                                </div>
                                <div class="contact-role"><%= staff.role %></div>
                                <div class="contact-last-message" style="font-style: italic; color: var(--text-tertiary);">
                                    <%= staff.department || 'Sem departamento' %>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } %>
            </div>
        </div>
        
        <!-- √Årea principal do chat -->
        <div class="chat-main" id="chatMain">
            <div class="chat-header-main">
                <button class="btn-mobile-toggle" id="mobileToggle" onclick="toggleContacts()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="chat-contact-info" id="currentContactInfo">
                    <div class="empty-chat" id="emptyChatState">
                        <div>
                            <i class="fas fa-comments fa-3x mb-4"></i>
                            <h3>Selecione uma conversa</h3>
                            <p>Escolha um membro da equipa para come√ßar a conversar</p>
                        </div>
                    </div>
                    
                    <div id="activeContactInfo" style="display: none; flex: 1;">
                        <div class="contact-avatar default" id="activeContactAvatar"></div>
                        <div>
                            <div class="contact-name" id="activeContactName"></div>
                            <div class="chat-status" id="activeContactStatus">
                                <span class="status-online">‚óè</span> Online
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-actions" id="chatActions" style="display: none;">
                    <button class="btn-icon" title="Informa√ß√µes" onclick="showContactInfo()">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="btn-icon" title="Limpar conversa" onclick="clearConversation()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Mensagens carregadas via JS -->
            </div>
            
            <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                <div class="chat-input-wrapper">
                    <textarea class="message-input" id="messageInput" 
                              placeholder="Escreva uma mensagem..."
                              rows="1"
                              oninput="autoResize(this)"
                              onkeydown="handleKeyDown(event)"></textarea>
                    <button class="btn-send" id="sendButton" onclick="sendMessage()" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const currentUser = {
            id: '<%= user.id %>',
            name: '<%= user.name %>',
            email: '<%= user.email %>',
            role: '<%= user.role %>',
            photo: '<%= user.photo %>'
        };
        
        let currentConversation = null;
        let conversations = <%= JSON.stringify(conversations) %> || [];
        let staffMembers = <%= JSON.stringify(staffMembers) %> || [];
        let ws = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üí¨ Chat Interno inicializado para:', currentUser.name);
            
            initTheme();
            initWebSocket();
            setupChatEvents();
            
            // Verificar se h√° um chat espec√≠fico na URL
            const urlParams = new URLSearchParams(window.location.search);
            const chatId = urlParams.get('chat');
            if (chatId) {
                openConversation(chatId);
            }
        });
        
        function initTheme() {
            const savedTheme = localStorage.getItem('casinoX-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        
        function setupChatEvents() {
            document.getElementById('searchContacts').addEventListener('input', function(e) {
                filterContacts(e.target.value);
            });
            
            document.getElementById('messageInput').addEventListener('input', function() {
                document.getElementById('sendButton').disabled = this.value.trim() === '';
            });
        }
        
        function initWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}`);
            
            ws.onopen = () => {
                console.log('WebSocket conectado para chat');
                ws.send(JSON.stringify({ 
                    type: 'subscribe_chat',
                    userId: currentUser.id 
                }));
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'internal_message') {
                        handleIncomingMessage(data.data);
                    }
                } catch (error) {
                    console.error('Erro ao processar mensagem WebSocket:', error);
                }
            };
        }
        
        function openConversation(userId) {
            const contact = [...conversations, ...staffMembers].find(c => c._id === userId || c.contact?._id === userId);
            if (!contact) return;
            
            currentConversation = contact.contact || contact;
            
            document.getElementById('emptyChatState').style.display = 'none';
            document.getElementById('activeContactInfo').style.display = 'flex';
            document.getElementById('chatActions').style.display = 'flex';
            document.getElementById('chatInputContainer').style.display = 'block';
            
            document.getElementById('activeContactName').textContent = currentConversation.name;
            
            const avatar = document.getElementById('activeContactAvatar');
            if (currentConversation.photo) {
                avatar.className = 'contact-avatar has-photo';
                avatar.innerHTML = `<img src="/uploads/${currentConversation.photo}" alt="${currentConversation.name}">`;
            } else {
                avatar.className = 'contact-avatar default';
                avatar.textContent = currentConversation.name.split(' ').map(n => n[0]).join('').toUpperCase();
            }
            
            // Marcar contacto como ativo
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-user-id') === userId) {
                    item.classList.add('active');
                }
            });
            
            loadMessages(userId);
        }
        
        async function loadMessages(userId) {
            try {
                const response = await fetch(`/api/email/internal/conversation/${userId}`);
                const data = await response.json();
                
                if (data.success && data.messages) {
                    displayMessages(data.messages);
                }
                scrollToBottom();
            } catch (error) {
                console.error('Erro ao carregar mensagens:', error);
            }
        }
        
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            messages.forEach(msg => {
                const messageElement = createMessageElement(msg);
                container.appendChild(messageElement);
            });
        }
        
        function createMessageElement(msg) {
            const isSent = msg.from._id === currentUser.id;
            const sender = isSent ? currentUser : msg.from;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            
            if (sender.photo) {
                avatarDiv.innerHTML = `<img src="/uploads/${sender.photo}" alt="${sender.name}">`;
            } else {
                avatarDiv.className = 'message-avatar default';
                avatarDiv.textContent = sender.name.split(' ').map(n => n[0]).join('').toUpperCase();
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = msg.message;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date(msg.sentAt).toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit'});
            
            contentDiv.appendChild(textDiv);
            contentDiv.appendChild(timeDiv);
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            return messageDiv;
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentConversation) return;
            
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.innerHTML = '<span class="loading"></span>';
            
            try {
                const response = await fetch('/api/email/internal/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: currentConversation._id,
                        message: message
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const newMessage = {
                        _id: result.messageId,
                        from: currentUser,
                        to: currentConversation,
                        message: message,
                        sentAt: new Date().toISOString(),
                        read: false
                    };
                    
                    const messageElement = createMessageElement(newMessage);
                    document.getElementById('messagesContainer').appendChild(messageElement);
                    
                    input.value = '';
                    input.style.height = 'auto';
                    scrollToBottom();
                    
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'send_message',
                            to: currentConversation._id,
                            message: message,
                            from: currentUser
                        }));
                    }
                }
            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }
        
        function handleIncomingMessage(data) {
            if (currentConversation && data.fromId === currentConversation._id) {
                const newMessage = {
                    _id: data.messageId,
                    from: { _id: data.fromId, name: data.fromName },
                    to: currentUser,
                    message: data.message,
                    sentAt: new Date().toISOString(),
                    read: true
                };
                
                const messageElement = createMessageElement(newMessage);
                document.getElementById('messagesContainer').appendChild(messageElement);
                scrollToBottom();
            }
        }
        
        function filterContacts(searchTerm) {
            const contacts = document.querySelectorAll('.contact-item');
            searchTerm = searchTerm.toLowerCase();
            
            contacts.forEach(contact => {
                const name = contact.querySelector('.contact-name span').textContent.toLowerCase();
                const role = contact.querySelector('.contact-role').textContent.toLowerCase();
                contact.style.display = name.includes(searchTerm) || role.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        function toggleContacts() {
            document.getElementById('contactsSidebar').classList.toggle('active');
        }
        
        function showContactInfo() {
            if (!currentConversation) return;
            
            alert(`
                Nome: ${currentConversation.name}
                Email: ${currentConversation.email}
                Cargo: ${currentConversation.role}
                Departamento: ${currentConversation.department || 'N√£o definido'}
            `);
        }
        
        function clearConversation() {
            if (!currentConversation || !confirm('Tem certeza que deseja limpar esta conversa?')) return;
            
            document.getElementById('messagesContainer').innerHTML = '';
        }
    </script>
</body>
</html>