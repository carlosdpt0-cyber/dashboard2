<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'B7Uno Casino | Definições' %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" href="/css/settings.css">
    <style>
      
    </style>
</head>
<body>
    <!-- ===== POPUP DE CONFIDENCIALIDADE ===== -->
    <div class="confidentiality-modal" id="confidentialityModal">
        <div class="confidentiality-content">
            <i class="fas fa-shield-alt confidentiality-icon"></i>
            
            <h1 class="confidentiality-title">AVISO DE CONFIDENCIALIDADE</h1>
            
            <h2 class="confidentiality-subtitle">B7UNO CASINO - PAINEL DE ADMINISTRAÇÃO</h2>
            
            <div class="confidentiality-text">
                <p>Caríssimo Administrador,</p>
                
                <p>É com grande satisfação que o recebemos no Sistema de Administração do <strong>B7Uno Casino</strong>, um ambiente reservado e altamente confidencial destinado exclusivamente à gestão estratégica das nossas operações.</p>
                
                <p>Ao aceder a este painel, assume a responsabilidade de ser guardião de informações sensíveis que são o alicerce da nossa excelência operacional. Cada ecrã, cada relatório, cada métrica que visualizar faz parte do núcleo estratégico do nosso estabelecimento.</p>
                
                <p>Este sistema está sob vigilância contínua 24 horas por dia, 7 dias por semana. Todas as suas ações serão registadas, monitorizadas e auditadas para garantir a integridade máxima das nossas operações.</p>
                
                <p>Compreendemos que confiança é um privilégio conquistado através da discrição profissional. As informações aqui contidas são sagradas e devem permanecer estritamente entre os muros desta plataforma.</p>
                
                <div class="confidentiality-warning">
                    <i class="fas fa-eye"></i>
                    <p>⚠️ TODAS AS AÇÕES SÃO MONITORIZADAS EM TEMPO REAL ⚠️</p>
                </div>
                
                <p>Para prosseguir, declaro solenemente que:</p>
                
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Compreendo a natureza confidencial de todas as informações apresentadas</li>
                    <li>Comprometo-me a manter o mais absoluto sigilo profissional</li>
                    <li>Aceito que todas as minhas ações serão registadas para auditoria</li>
                    <li>Reconheço que violações de confidencialidade terão consequências graves</li>
                    <li>Atuo em conformidade com todas as políticas de segurança da empresa</li>
                </ul>
            </div>
            
            <div class="confidentiality-buttons">
                <button class="confidentiality-btn accept" id="acceptConfidentiality">
                    <i class="fas fa-check-circle"></i>
                    ACEITO E COMPROMETO-ME
                </button>
                
                <button class="confidentiality-btn reject" id="rejectConfidentiality">
                    <i class="fas fa-times-circle"></i>
                    NÃO ACEITO / SAIR
                </button>
            </div>
            
            <div class="confidentiality-footer" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(212, 175, 55, 0.2); font-size: 11px; color: #888;">
                <p><i class="fas fa-lock"></i> Sistema protegido por criptografia de ponta a ponta</p>
                <p><i class="fas fa-history"></i> Todas as ações são registadas com timestamp</p>
            </div>
        </div>
    </div>

    <!-- ===== MAIN CONTAINER ===== -->
    <div class="app-container" id="mainApp" style="display: none;">
        <!-- ===== SIDEBAR ===== -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h2>B7Uno Casino <span class="b7uno-badge">ADMIN</span></h2>
                <div class="user-mini-info">
                    <div class="user-mini-avatar" id="sidebarAvatar">
                        <% if (user && user.photo) { %>
                            <img src="/uploads/<%= user.photo %>?t=<%= Date.now() %>" 
                                 alt="<%= user.name %>"
                                 onerror="handleAvatarError(this, 'sidebarAvatar')">
                        <% } else { %>
                            <i class="fas fa-user-tie"></i>
                        <% } %>
                    </div>
                    <div class="user-mini-details">
                        <span id="sidebarStaffName"><%= user.name %></span>
                        <small id="sidebarStaffRole"><%= user.role %></small>
                    </div>
                </div>
            </div>
            
            <ul class="menu">
                <li><a href="/dashboard">
                    <i class="fas fa-home"></i><span> Dashboard</span>
                </a></li>
                <li><a href="/players">
                    <i class="fas fa-users"></i><span> Jogadores</span>
                </a></li>
                <li><a href="/withdrawals">
                    <i class="fas fa-money-bill-wave"></i><span> Levantamentos</span>
                </a></li>
                <li><a href="/payments">
                    <i class="fas fa-credit-card"></i><span> Pagamentos</span>
                </a></li>
                <li><a href="/support">
                    <i class="fas fa-headset"></i><span> Support</span>
                </a></li>
                <li><a href="/staff">
                    <i class="fas fa-user-tie"></i><span> Staff</span>
                </a></li>
                
                <li><a href="/email">
                    <i class="fas fa-envelope"></i><span> Email</span>
                </a></li>
                
                <li><a href="/logs">
                    <i class="fas fa-clipboard-list"></i><span> Logs</span>
                </a></li>
                <li><a href="/settings" class="active">
                    <i class="fas fa-cog"></i><span> Definições</span>
                </a></li>
                
                <!-- Theme Toggle -->
                <li>
                    <div class="theme-toggle" id="sidebarThemeToggle">
                        <input type="checkbox" id="sidebarThemeCheckbox">
                        <div class="toggle-switch"></div>
                        <span class="theme-label" id="sidebarThemeLabel">Modo Escuro</span>
                    </div>
                </li>
                
                <!-- Logout -->
                <li>
                    <a href="#" id="logoutBtnSidebar">
                        <i class="fas fa-sign-out-alt"></i><span> Logout</span>
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-footer">
                <div class="system-status">
                    <div class="status-indicator online"></div>
                    <span>Sistema Online</span>
                </div>
                <div class="server-time" id="serverTime">--:--:--</div>
            </div>
        </div>

        <!-- ===== MAIN CONTENT ===== -->
        <div class="main-content">
            <!-- ===== TOPBAR ===== -->
            <div class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="breadcrumb" id="breadcrumb">
                        <%= breadcrumb || 'Definições do Sistema' %>
                    </div>
                </div>
                
                <div class="topbar-right">
                    <!-- Theme Toggle -->
                    <div class="theme-toggle" id="topbarThemeToggle">
                        <input type="checkbox" id="topbarThemeCheckbox">
                        <div class="toggle-switch"></div>
                        <span class="theme-label" id="topbarThemeLabel">Modo Escuro</span>
                    </div>
                    
                    <div class="notifications">
                        <button class="notification-btn" id="notificationBtn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-count" id="notificationCount">0</span>
                        </button>
                    </div>
                    
                    <div class="user-profile" id="userProfile">
                        <div class="user-avatar" id="userAvatar">
                            <% if (user && user.photo) { %>
                                <img src="/uploads/<%= user.photo %>?t=<%= Date.now() %>" 
                                     alt="<%= user.name %>" 
                                     id="userAvatarImage"
                                     onerror="handleAvatarError(this, 'userAvatar')">
                            <% } else { %>
                                <span id="userInitials"><%= user.name.split(' ').map(n => n[0]).join('').toUpperCase() %></span>
                            <% } %>
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="topbarStaffName"><%= user.name %></div>
                            <div class="user-role" id="topbarStaffRole"><%= user.role %></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== USER DROPDOWN ===== -->
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-header">
                    <div class="user-info">
                        <div class="user-avatar" id="dropdownAvatar">
                            <% if (user && user.photo) { %>
                                <img src="/uploads/<%= user.photo %>?t=<%= Date.now() %>" 
                                     alt="<%= user.name %>" 
                                     id="dropdownAvatarImage"
                                     onerror="handleAvatarError(this, 'dropdownAvatar')">
                            <% } else { %>
                                <span id="dropdownInitials"><%= user.name.split(' ').map(n => n[0]).join('').toUpperCase() %></span>
                            <% } %>
                        </div>
                        <div>
                            <div class="user-name" id="dropdownUserName"><%= user.name %></div>
                            <div class="user-role"><%= user.role %></div>
                            <div class="user-email" style="font-size: 11px; color: var(--text-secondary);">
                                <%= user.email %>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dropdown-body">
                    <a href="/profile" class="dropdown-item" id="myProfileLink">
                        <i class="fas fa-user"></i>
                        <span>Meu Perfil</span>
                    </a>
                    <a href="/settings" class="dropdown-item">
                        <i class="fas fa-cog"></i>
                        <span>Definições</span>
                    </a>
                    <a href="/logs" class="dropdown-item">
                        <i class="fas fa-history"></i>
                        <span>Histórico</span>
                    </a>
                </div>
                <div class="dropdown-footer">
                    <button class="btn btn-secondary" id="logoutBtnDropdown">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>

            <!-- ===== MODAL DE NOTIFICAÇÕES ===== -->
            <div class="modal" id="notificationsModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-bell"></i> Notificações</h3>
                        <button class="modal-close" id="modalClose">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="notifications-list" id="notificationsList">
                            <div class="empty-notifications">
                                <i class="fas fa-bell-slash"></i>
                                <p>Carregando notificações...</p>
                            </div>
                        </div>
                        <div class="modal-actions" style="padding: 16px 24px; border-top: 1px solid var(--border-color);">
                            <button class="btn btn-secondary" id="markAllAsReadBtn" style="width: 100%; margin-bottom: 8px;">
                                <i class="fas fa-check-double"></i> Marcar todas como lidas
                            </button>
                            <button class="btn btn-secondary" id="clearAllNotificationsBtn" style="width: 100%;">
                                <i class="fas fa-trash"></i> Limpar todas
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== CONTENT AREA (PÁGINA DE DEFINIÇÕES) ===== -->
            <div class="content-area fade-in">
                <!-- Settings Header -->
                <div class="settings-header">
                    <h1>
                        <i class="fas fa-cog"></i> Definições do Sistema
                    </h1>
                    <p>
                        Configure as preferências do sistema, segurança, e opções gerais do B7Uno Casino.
                    </p>
                </div>

                <!-- Settings Tabs -->
                <div class="settings-tabs">
                    <button class="tab-btn active" data-tab="general">
                        <i class="fas fa-sliders-h"></i> Geral
                    </button>
                    <button class="tab-btn" data-tab="security">
                        <i class="fas fa-shield-alt"></i> Segurança
                    </button>
                    <button class="tab-btn" data-tab="payments">
                        <i class="fas fa-credit-card"></i> Pagamentos
                    </button>
                    <button class="tab-btn" data-tab="email">
                        <i class="fas fa-envelope"></i> Email
                    </button>
                    <button class="tab-btn" data-tab="games">
                        <i class="fas fa-gamepad"></i> Jogos
                    </button>
                    <button class="tab-btn" data-tab="advanced">
                        <i class="fas fa-code"></i> Avançado
                    </button>
                </div>

                <!-- Tab Contents -->
                
                <!-- TAB GERAL -->
                <div class="tab-content active" id="general">
                    <div class="settings-grid">
                        <!-- Informações do Casino -->
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-building"></i>
                                <h3>Informações do Casino</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>Nome do Casino</label>
                                <input type="text" class="form-control" id="casinoName" 
                                       value="B7Uno Casino" placeholder="Digite o nome do casino">
                            </div>
                            
                            <div class="form-group">
                                <label>URL do Site</label>
                                <input type="url" class="form-control" id="casinoUrl" 
                                       value="https://b7uno.com" placeholder="https://seusite.com">
                            </div>
                            
                            <div class="form-group">
                                <label>Moeda Principal</label>
                                <select class="form-control" id="mainCurrency">
                                    <option value="EUR" selected>Euro (€)</option>
                                    <option value="USD">Dólar ($)</option>
                                    <option value="BRL">Real (R$)</option>
                                    <option value="GBP">Libra (£)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Fuso Horário</label>
                                <select class="form-control" id="timezone">
                                    <option value="Europe/Lisbon" selected>Portugal (WET/WEST)</option>
                                    <option value="Europe/London">Londres (GMT/BST)</option>
                                    <option value="America/New_York">Nova Iorque (EST/EDT)</option>
                                    <option value="America/Sao_Paulo">São Paulo (BRT)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Logo do Casino</label>
                                <div class="file-upload">
                                    <input type="file" id="logoUpload" accept="image/*">
                                    <label for="logoUpload">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <span>Clique para fazer upload do logo</span>
                                        <small class="form-help">Tamanho recomendado: 200x60 pixels</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Configurações Gerais -->
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-tools"></i>
                                <h3>Configurações Gerais</h3>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Manutenção do Sistema</div>
                                    <span class="toggle-description">Coloca o site em modo de manutenção</span>
                                </div>
                                <div class="setting-toggle" id="maintenanceToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Registo de Novos Jogadores</div>
                                    <span class="toggle-description">Permitir novos registos no site</span>
                                </div>
                                <div class="setting-toggle active" id="registrationsToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Modo de Depuração</div>
                                    <span class="toggle-description">Mostra logs detalhados (apenas desenvolvimento)</span>
                                </div>
                                <div class="setting-toggle" id="debugToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Notificações por Email</div>
                                    <span class="toggle-description">Enviar notificações automáticas por email</span>
                                </div>
                                <div class="setting-toggle active" id="emailNotificationsToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Verificação em 2 Passos</div>
                                    <span class="toggle-description">Requer 2FA para administradores</span>
                                </div>
                                <div class="setting-toggle" id="twoFactorToggle"></div>
                            </div>
                            
                            <div class="form-group">
                                <label>Limite de Sessões Simultâneas</label>
                                <div class="range-slider">
                                    <div class="range-value">
                                        <span id="sessionsValue">3</span>
                                        <span>sessões</span>
                                    </div>
                                    <input type="range" id="sessionsLimit" min="1" max="10" value="3">
                                </div>
                            </div>
                        </div>

                        <!-- Configurações de Idioma -->
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-globe"></i>
                                <h3>Idioma e Localização</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>Idioma Principal</label>
                                <select class="form-control" id="mainLanguage">
                                    <option value="pt" selected>Português</option>
                                    <option value="en">Inglês</option>
                                    <option value="es">Espanhol</option>
                                    <option value="fr">Francês</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Idiomas Suportados</label>
                                <div class="tags-input" id="languageTags">
                                    <div class="tag">
                                        Português
                                        <span class="tag-remove" onclick="removeTag(this)">×</span>
                                    </div>
                                    <div class="tag">
                                        Inglês
                                        <span class="tag-remove" onclick="removeTag(this)">×</span>
                                    </div>
                                    <input type="text" placeholder="Adicionar idioma..." onkeypress="addLanguageTag(event)">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Formato de Data</label>
                                <select class="form-control" id="dateFormat">
                                    <option value="dd/mm/yyyy" selected>DD/MM/YYYY</option>
                                    <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                    <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Formato de Hora</label>
                                <select class="form-control" id="timeFormat">
                                    <option value="24" selected>24 horas (14:30)</option>
                                    <option value="12">12 horas (2:30 PM)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section" style="margin-top: 20px;">
                        <button class="btn btn-success btn-block" onclick="saveGeneralSettings()">
                            <i class="fas fa-save"></i> Guardar Configurações Gerais
                        </button>
                    </div>
                </div>

                <!-- TAB SEGURANÇA -->
                <div class="tab-content" id="security">
                    <div class="settings-grid">
                        <!-- Configurações de Segurança -->
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-lock"></i>
                                <h3>Configurações de Segurança</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>Força Mínima da Palavra-passe</label>
                                <select class="form-control" id="passwordStrength">
                                    <option value="low">Baixa (6 caracteres)</option>
                                    <option value="medium" selected>Média (8 caracteres, letras e números)</option>
                                    <option value="high">Alta (10 caracteres, mistura de tipos)</option>
                                    <option value="very-high">Muito Alta (12 caracteres, símbolos obrigatórios)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Tempo de Expiração da Sessão</label>
                                <select class="form-control" id="sessionTimeout">
                                    <option value="15">15 minutos</option>
                                    <option value="30">30 minutos</option>
                                    <option value="60" selected>1 hora</option>
                                    <option value="120">2 horas</option>
                                    <option value="240">4 horas</option>
                                </select>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Registo de Tentativas de Login</div>
                                    <span class="toggle-description">Regista todas as tentativas de login (falhas e sucessos)</span>
                                </div>
                                <div class="setting-toggle active" id="loginLoggingToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Bloquear IP após falhas</div>
                                    <span class="toggle-description">Bloqueia IP após 5 tentativas falhadas</span>
                                </div>
                                <div class="setting-toggle active" id="ipBlockToggle"></div>
                            </div>
                            
                            <div class="form-group">
                                <label>Tempo de Bloqueio de IP</label>
                                <select class="form-control" id="ipBlockTime">
                                    <option value="15">15 minutos</option>
                                    <option value="30" selected>30 minutos</option>
                                    <option value="60">1 hora</option>
                                    <option value="1440">24 horas</option>
                                </select>
                            </div>
                        </div>

                        <!-- Firewall e Acesso -->
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-shield-alt"></i>
                                <h3>Firewall e Acesso</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>Endereços IP Permitidos (Admin)</label>
                                <textarea class="form-control" id="allowedIPs" rows="4" 
                                          placeholder="Adicione um IP por linha&#10;Exemplo:&#10;192.168.1.1&#10;10.0.0.1"></textarea>
                                <small class="form-help">Deixe em branco para permitir de qualquer IP</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Países Bloqueados</label>
                                <select class="form-control" id="blockedCountries" multiple>
                                    <option value="US">Estados Unidos</option>
                                    <option value="CN">China</option>
                                    <option value="RU">Rússia</option>
                                    <option value="IR">Irão</option>
                                </select>
                                <small class="form-help">Ctrl+Clique para selecionar múltiplos países</small>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Proteção contra DDoS</div>
                                    <span class="toggle-description">Ativa proteção básica contra ataques DDoS</span>
                                </div>
                                <div class="setting-toggle active" id="ddosProtectionToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Verificação de Geolocalização</div>
                                    <span class="toggle-description">Verifica a localização dos jogadores</span>
                                </div>
                                <div class="setting-toggle" id="geolocationToggle"></div>
                            </div>
                        </div>

                        <!-- Criptografia -->
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-key"></i>
                                <h3>Criptografia</h3>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <span>Alterações nestas configurações podem afetar a compatibilidade.</span>
                            </div>
                            
                            <div class="form-group">
                                <label>Algoritmo de Hash (Passwords)</label>
                                <select class="form-control" id="hashAlgorithm">
                                    <option value="bcrypt" selected>bcrypt (Recomendado)</option>
                                    <option value="argon2">Argon2</option>
                                    <option value="sha256">SHA-256</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Custo do bcrypt</label>
                                <div class="range-slider">
                                    <div class="range-value">
                                        <span id="bcryptCostValue">12</span>
                                    </div>
                                    <input type="range" id="bcryptCost" min="10" max="15" value="12">
                                </div>
                                <small class="form-help">Valor mais alto = mais seguro mas mais lento</small>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Encriptar Dados Sensíveis</div>
                                    <span class="toggle-description">Encripta dados de pagamento e pessoais na base de dados</span>
                                </div>
                                <div class="setting-toggle active" id="dataEncryptionToggle"></div>
                            </div>
                            
                            <button class="btn btn-secondary btn-block" onclick="testEncryption()">
                                <i class="fas fa-vial"></i> Testar Configuração de Criptografia
                            </button>
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="settings-grid">
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-history"></i>
                                <h3>Auditoria de Segurança</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>Dias para manter logs</label>
                                <input type="number" class="form-control" id="logRetentionDays" 
                                       value="90" min="1" max="365">
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Auditoria Completa</div>
                                    <span class="toggle-description">Regista todas as ações dos administradores</span>
                                </div>
                                <div class="setting-toggle active" id="fullAuditToggle"></div>
                            </div>
                            
                            <div class="form-group">
                                <label>Exportar Logs de Segurança</label>
                                <div class="btn-group" style="display: flex; gap: 10px;">
                                    <button class="btn btn-secondary" onclick="exportSecurityLogs('csv')">
                                        <i class="fas fa-file-csv"></i> CSV
                                    </button>
                                    <button class="btn btn-secondary" onclick="exportSecurityLogs('json')">
                                        <i class="fas fa-file-code"></i> JSON
                                    </button>
                                    <button class="btn btn-secondary" onclick="exportSecurityLogs('pdf')">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section" style="margin-top: 20px;">
                        <button class="btn btn-success btn-block" onclick="saveSecuritySettings()">
                            <i class="fas fa-save"></i> Guardar Configurações de Segurança
                        </button>
                    </div>
                </div>

                <!-- TAB PAGAMENTOS -->
                <div class="tab-content" id="payments">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Alterações nestas configurações podem afetar os pagamentos em tempo real.</span>
                    </div>
                    
                    <div class="settings-grid">
                        <!-- Configurações Gerais de Pagamentos -->
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-money-check-alt"></i>
                                <h3>Configurações de Pagamento</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>Depósito Mínimo</label>
                                <input type="number" class="form-control" id="minDeposit" 
                                       value="10" step="0.01" min="1">
                                <small class="form-help">Valor mínimo para depósito</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Depósito Máximo</label>
                                <input type="number" class="form-control" id="maxDeposit" 
                                       value="5000" step="0.01" min="10">
                                <small class="form-help">Valor máximo para depósito</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Levantamento Mínimo</label>
                                <input type="number" class="form-control" id="minWithdrawal" 
                                       value="20" step="0.01" min="1">
                                <small class="form-help">Valor mínimo para levantamento</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Levantamento Máximo</label>
                                <input type="number" class="form-control" id="maxWithdrawal" 
                                       value="10000" step="0.01" min="20">
                                <small class="form-help">Valor máximo para levantamento</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Limite Diário de Levantamento</label>
                                <input type="number" class="form-control" id="dailyWithdrawalLimit" 
                                       value="20000" step="0.01" min="100">
                            </div>
                            
                            <div class="form-group">
                                <label>Taxa de Levantamento (%)</label>
                                <input type="number" class="form-control" id="withdrawalFee" 
                                       value="0" step="0.01" min="0" max="10">
                                <small class="form-help">Percentagem aplicada em cada levantamento</small>
                            </div>
                        </div>

                        <!-- Métodos de Pagamento -->
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-credit-card"></i>
                                <h3>Métodos de Pagamento</h3>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Cartão de Crédito/Débito</div>
                                    <span class="toggle-description">Visa, Mastercard, etc.</span>
                                </div>
                                <div class="setting-toggle active" id="creditCardToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">MB Way</div>
                                    <span class="toggle-description">Pagamentos por MB Way</span>
                                </div>
                                <div class="setting-toggle active" id="mbwayToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Transferência Bancária</div>
                                    <span class="toggle-description">Transferência SEPA/IBAN</span>
                                </div>
                                <div class="setting-toggle active" id="bankTransferToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Skrill</div>
                                    <span class="toggle-description">Pagamentos via Skrill</span>
                                </div>
                                <div class="setting-toggle" id="skrillToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Neteller</div>
                                    <span class="toggle-description">Pagamentos via Neteller</span>
                                </div>
                                <div class="setting-toggle" id="netellerToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Criptomoedas</div>
                                    <span class="toggle-description">Bitcoin, Ethereum, etc.</span>
                                </div>
                                <div class="setting-toggle" id="cryptoToggle"></div>
                            </div>
                            
                            <div class="form-group">
                                <label>Tempo de Processamento</label>
                                <select class="form-control" id="processingTime">
                                    <option value="instant">Instantâneo</option>
                                    <option value="5" selected>5 minutos</option>
                                    <option value="15">15 minutos</option>
                                    <option value="30">30 minutos</option>
                                    <option value="60">1 hora</option>
                                </select>
                            </div>
                        </div>

                        <!-- Gateway de Pagamento -->
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-exchange-alt"></i>
                                <h3>Gateway de Pagamento</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>Gateway Principal</label>
                                <select class="form-control" id="paymentGateway">
                                    <option value="stripe">Stripe</option>
                                    <option value="paypal" selected>PayPal</option>
                                    <option value="adyen">Adyen</option>
                                    <option value="mollie">Mollie</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" class="form-control" id="apiKey" 
                                       placeholder="••••••••••••••••••">
                                <small class="form-help">Chave de API do gateway de pagamento</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Secret Key</label>
                                <input type="password" class="form-control" id="secretKey" 
                                       placeholder="••••••••••••••••••">
                                <small class="form-help">Chave secreta do gateway de pagamento</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Webhook URL</label>
                                <input type="url" class="form-control" id="webhookUrl" 
                                       value="https://b7uno.com/api/payments/webhook" 
                                       placeholder="https://seusite.com/webhook">
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Modo de Teste (Sandbox)</div>
                                    <span class="toggle-description">Usa ambiente de testes para pagamentos</span>
                                </div>
                                <div class="setting-toggle" id="sandboxToggle"></div>
                            </div>
                            
                            <button class="btn btn-secondary btn-block" onclick="testPaymentGateway()">
                                <i class="fas fa-vial"></i> Testar Conexão do Gateway
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-section" style="margin-top: 20px;">
                        <button class="btn btn-success btn-block" onclick="savePaymentSettings()">
                            <i class="fas fa-save"></i> Guardar Configurações de Pagamento
                        </button>
                    </div>
                </div>

                <!-- TAB EMAIL -->
                <div class="tab-content" id="email">
                    <div class="settings-grid">
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-envelope"></i>
                                <h3>Configurações de Email</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>SMTP Host</label>
                                <input type="text" class="form-control" id="smtpHost" 
                                       value="smtp.gmail.com" placeholder="smtp.exemplo.com">
                            </div>
                            
                            <div class="form-group">
                                <label>SMTP Port</label>
                                <input type="number" class="form-control" id="smtpPort" 
                                       value="587" placeholder="587">
                            </div>
                            
                            <div class="form-group">
                                <label>Email de Envio</label>
                                <input type="email" class="form-control" id="smtpEmail" 
                                       value="noreply@b7uno.com" placeholder="email@exemplo.com">
                            </div>
                            
                            <div class="form-group">
                                <label>Senha do Email</label>
                                <input type="password" class="form-control" id="smtpPassword" 
                                       placeholder="••••••••••••••••••">
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Usar SSL/TLS</div>
                                    <span class="toggle-description">Conexão segura para envio de emails</span>
                                </div>
                                <div class="setting-toggle active" id="smtpSslToggle"></div>
                            </div>
                            
                            <button class="btn btn-secondary btn-block" onclick="testEmailSettings()">
                                <i class="fas fa-vial"></i> Testar Configuração de Email
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-section" style="margin-top: 20px;">
                        <button class="btn btn-success btn-block" onclick="saveEmailSettings()">
                            <i class="fas fa-save"></i> Guardar Configurações de Email
                        </button>
                    </div>
                </div>

                <!-- TAB JOGOS -->
                <div class="tab-content" id="games">
                    <div class="settings-grid">
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-dice"></i>
                                <h3>Configurações de Jogos</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>House Edge (%)</label>
                                <input type="number" class="form-control" id="houseEdge" 
                                       value="2.5" step="0.1" min="0" max="10">
                                <small class="form-help">Margem da casa em percentagem</small>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Manutenção dos Jogos</div>
                                    <span class="toggle-description">Desativa todos os jogos para manutenção</span>
                                </div>
                                <div class="setting-toggle" id="gamesMaintenanceToggle"></div>
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Modo de Demonstração</div>
                                    <span class="toggle-description">Permitir jogar em modo de demonstração</span>
                                </div>
                                <div class="setting-toggle active" id="demoModeToggle"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section" style="margin-top: 20px;">
                        <button class="btn btn-success btn-block" onclick="saveGameSettings()">
                            <i class="fas fa-save"></i> Guardar Configurações de Jogos
                        </button>
                    </div>
                </div>

                <!-- TAB AVANÇADO -->
                <div class="tab-content" id="advanced">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span><strong>Atenção:</strong> Estas configurações são para administradores avançados. Alterações incorretas podem causar instabilidade no sistema.</span>
                    </div>
                    
                    <div class="settings-grid">
                        <div class="settings-section">
                            <div class="section-title">
                                <i class="fas fa-server"></i>
                                <h3>Configurações do Servidor</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>API Rate Limit</label>
                                <input type="number" class="form-control" id="apiRateLimit" 
                                       value="100" min="10" max="1000">
                                <small class="form-help">Número máximo de requisições por minuto</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Tempo de Cache (minutos)</label>
                                <input type="number" class="form-control" id="cacheTime" 
                                       value="5" min="1" max="60">
                            </div>
                            
                            <div class="toggle-container">
                                <div>
                                    <div class="toggle-label">Modo de Desenvolvimento</div>
                                    <span class="toggle-description">Ativa logs detalhados e debugging</span>
                                </div>
                                <div class="setting-toggle" id="devModeToggle"></div>
                            </div>
                            
                            <button class="btn btn-danger btn-block" onclick="clearSystemCache()">
                                <i class="fas fa-broom"></i> Limpar Cache do Sistema
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-section" style="margin-top: 20px;">
                        <button class="btn btn-success btn-block" onclick="saveAdvancedSettings()">
                            <i class="fas fa-save"></i> Guardar Configurações Avançadas
                        </button>
                    </div>
                </div>

                <div class="alert alert-info" style="margin-top: 30px;">
                    <i class="fas fa-lightbulb"></i>
                    <span><strong>Dica:</strong> Após alterar as configurações, lembre-se de guardar as alterações em cada secção.</span>
                </div>
            </div>
        </div>
        
        <!-- ===== OVERLAY PARA MOBILE ===== -->
        <div class="overlay" id="overlay"></div>

        <!-- ===== MODAL DE CONFIRMAÇÃO ===== -->
        <div class="confirm-modal" id="confirmModal">
            <div class="confirm-content">
                <div class="confirm-header">
                    <h3><i class="fas fa-exclamation-circle"></i> Confirmar Alteração</h3>
                </div>
                <div class="confirm-body">
                    <p id="confirmMessage">Tem certeza que deseja aplicar estas alterações?</p>
                </div>
                <div class="confirm-actions">
                    <button class="btn btn-secondary" id="cancelConfirmBtn">Cancelar</button>
                    <button class="btn btn-primary" id="confirmActionBtn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== JAVASCRIPT CORRIGIDO ===== -->
    <script>
        // ============ VERIFICAÇÃO INICIAL ============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Sistema B7Uno - Definições Carregado');
            
            // VERIFICAÇÃO SIMPLES DOS TERMOS - VERSÃO CORRIGIDA
            const hasAccepted = localStorage.getItem('b7uno_terms_accepted');
            // VERIFICAR SE O USER TEM acceptedConfidentiality NA SESSÃO
            const userAccepted = <%= user && user.acceptedConfidentiality ? true : false %>;
            
            // Se já aceitou no localStorage OU o user já aceitou, mostrar dashboard
            if (hasAccepted === 'true' || userAccepted) {
                console.log('✅ Termos já aceitos - Mostrando Definições');
                showDashboard();
            } else {
                console.log('📋 Mostrando Popup de Confidencialidade');
                showPopup();
            }
        });
        
        function showDashboard() {
            // Esconder popup
            const popup = document.getElementById('confidentialityModal');
            if (popup) popup.style.display = 'none';
            
            // Mostrar app
            const app = document.getElementById('mainApp');
            if (app) app.style.display = 'flex';
            
            // Remover classe do body
            document.body.classList.remove('confidentiality-active');
            
            // Inicializar dashboard
            setTimeout(() => {
                initSettingsPage();
            }, 50);
        }
        
        function showPopup() {
            // Garantir que o popup está visível
            const popup = document.getElementById('confidentialityModal');
            if (popup) popup.style.display = 'flex';
            
            // Garantir que o app está escondido
            const app = document.getElementById('mainApp');
            if (app) app.style.display = 'none';
            
            // Adicionar classe ao body
            document.body.classList.add('confidentiality-active');
            
            // Configurar botões do popup
            setupPopupButtons();
        }
        
        // ============ CONFIGURAÇÃO DOS BOTÕES DO POPUP ============
        function setupPopupButtons() {
            console.log('🔧 Configurando botões do popup...');
            
            // BOTÃO ACEITAR
            const acceptBtn = document.getElementById('acceptConfidentiality');
            if (acceptBtn) {
                acceptBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('✅ Botão ACEITAR clicado');
                    
                    // 1. Salvar no localStorage
                    localStorage.setItem('b7uno_terms_accepted', 'true');
                    localStorage.setItem('b7uno_terms_accepted_date', new Date().toISOString());
                    localStorage.setItem('b7uno_terms_accepted_by', '<%= user.name %>');
                    
                    // 2. Enviar para o servidor
                    fetch('/api/confidentiality/accept', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('✅ Termos aceitos no servidor');
                            showToast('✅ Termos de confidencialidade aceitos!', 'success');
                            showDashboard();
                        } else {
                            console.error('❌ Erro ao aceitar termos no servidor:', data.error);
                            showToast('✅ Termos aceitos localmente!', 'success');
                            showDashboard();
                        }
                    })
                    .catch(error => {
                        console.error('❌ Erro na conexão:', error);
                        showToast('✅ Termos aceitos localmente!', 'success');
                        showDashboard();
                    });
                });
            }
            
            // BOTÃO REJEITAR
            const rejectBtn = document.getElementById('rejectConfidentiality');
            if (rejectBtn) {
                rejectBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const confirmed = confirm('⚠️ Ao rejeitar os termos de confidencialidade, será redirecionado para fora do sistema. Continuar?');
                    if (confirmed) {
                        window.location.href = '/logout?reason=confidentiality_rejected';
                    }
                });
            }
        }
        
        // ============ INICIALIZAÇÃO DA PÁGINA DE DEFINIÇÕES ============
        function initSettingsPage() {
            console.log('⚙️ Inicializando página de definições B7Uno...');
            
            // 1. Configurar tema
            initTheme();
            
            // 2. Configurar eventos básicos do dashboard
            setupDashboardEvents();
            
            // 3. Configurar funcionalidades específicas de settings
            setupSettingsFeatures();
            
            // 4. Iniciar relógio
            startClock();
            
            console.log('✅ Página de definições B7Uno pronta!');
        }
        
        function initTheme() {
            const savedTheme = localStorage.getItem('b7uno-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Atualizar todos os toggles
            document.querySelectorAll('.theme-toggle').forEach(toggle => {
                toggle.setAttribute('data-theme', savedTheme);
            });
            
            // Atualizar labels
            document.querySelectorAll('.theme-label').forEach(label => {
                label.textContent = savedTheme === 'light' ? 'Modo Claro' : 'Modo Escuro';
            });
        }
        
        function setupDashboardEvents() {
            // TOGGLE DO TEMA
            document.querySelectorAll('.theme-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const current = document.documentElement.getAttribute('data-theme') || 'dark';
                    const newTheme = current === 'dark' ? 'light' : 'dark';
                    
                    // Aplicar novo tema
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('b7uno-theme', newTheme);
                    
                    // Atualizar UI
                    document.querySelectorAll('.theme-toggle').forEach(t => {
                        t.setAttribute('data-theme', newTheme);
                    });
                    
                    document.querySelectorAll('.theme-label').forEach(label => {
                        label.textContent = newTheme === 'light' ? 'Modo Claro' : 'Modo Escuro';
                    });
                    
                    showToast(`🌞 Modo ${newTheme === 'light' ? 'Claro' : 'Escuro'} ativado`, 'success');
                });
            });
            
            // TOGGLE DO MENU
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle) {
                menuToggle.addEventListener('click', function() {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('overlay');
                    
                    if (window.innerWidth <= 1024) {
                        // Mobile
                        sidebar.classList.toggle('active');
                        overlay.classList.toggle('active');
                    } else {
                        // Desktop
                        sidebar.classList.toggle('collapsed');
                    }
                });
            }
            
            // OVERLAY (mobile)
            const overlay = document.getElementById('overlay');
            if (overlay) {
                overlay.addEventListener('click', function() {
                    document.getElementById('sidebar').classList.remove('active');
                    overlay.classList.remove('active');
                    document.getElementById('userDropdown').style.display = 'none';
                });
            }
            
            // LOGOUT
            const logoutBtns = document.querySelectorAll('#logoutBtnSidebar, #logoutBtnDropdown');
            logoutBtns.forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        showConfirmModal('Deseja sair do sistema?', function() {
                            window.location.href = '/logout';
                        });
                    });
                }
            });
            
            // DROPDOWN DO PERFIL
            const userProfile = document.getElementById('userProfile');
            const userDropdown = document.getElementById('userDropdown');
            if (userProfile && userDropdown) {
                userProfile.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                });
                
                // Fechar ao clicar fora
                document.addEventListener('click', function() {
                    userDropdown.style.display = 'none';
                });
            }
            
            // NOTIFICAÇÕES
            const notificationBtn = document.getElementById('notificationBtn');
            if (notificationBtn) {
                notificationBtn.addEventListener('click', function() {
                    loadNotifications();
                    document.getElementById('notificationsModal').style.display = 'flex';
                });
            }
            
            const modalClose = document.getElementById('modalClose');
            if (modalClose) {
                modalClose.addEventListener('click', function() {
                    document.getElementById('notificationsModal').style.display = 'none';
                });
            }
        }
        
        function setupSettingsFeatures() {
            // SISTEMA DE TABS
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // TOGGLE SWITCHES
            const toggles = document.querySelectorAll('.setting-toggle');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const settingId = this.id;
                    const isActive = this.classList.contains('active');
                    
                    // Guardar estado no localStorage para persistência
                    localStorage.setItem(`b7uno-setting-${settingId}`, isActive);
                    
                    showToast(`Configuração ${isActive ? 'ativada' : 'desativada'}`, 'info');
                });
                
                // Carregar estado salvo
                const savedState = localStorage.getItem(`b7uno-setting-${toggle.id}`);
                if (savedState === 'true') {
                    toggle.classList.add('active');
                } else if (savedState === 'false') {
                    toggle.classList.remove('active');
                }
            });
            
            // RANGE SLIDERS
            const sessionsSlider = document.getElementById('sessionsLimit');
            const sessionsValue = document.getElementById('sessionsValue');
            
            if (sessionsSlider && sessionsValue) {
                sessionsSlider.addEventListener('input', function() {
                    sessionsValue.textContent = this.value;
                });
            }
            
            const bcryptSlider = document.getElementById('bcryptCost');
            const bcryptValue = document.getElementById('bcryptCostValue');
            
            if (bcryptSlider && bcryptValue) {
                bcryptSlider.addEventListener('input', function() {
                    bcryptValue.textContent = this.value;
                });
            }
            
            // TAGS INPUT
            const languageInput = document.querySelector('#languageTags input');
            if (languageInput) {
                languageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const value = this.value.trim();
                        
                        if (value) {
                            const tagsContainer = this.parentElement;
                            const newTag = document.createElement('div');
                            newTag.className = 'tag';
                            newTag.innerHTML = `
                                ${value}
                                <span class="tag-remove" onclick="removeTag(this)">×</span>
                            `;
                            
                            tagsContainer.insertBefore(newTag, this);
                            this.value = '';
                            
                            // Guardar tags no localStorage
                            saveLanguageTags();
                        }
                    }
                });
            }
            
            // MODAL DE CONFIRMAÇÃO
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmActionBtn = document.getElementById('confirmActionBtn');
            
            if (cancelConfirmBtn) {
                cancelConfirmBtn.addEventListener('click', closeConfirmModal);
            }
            
            if (confirmActionBtn) {
                confirmActionBtn.addEventListener('click', function() {
                    if (window.currentConfirmCallback) {
                        window.currentConfirmCallback();
                    }
                    closeConfirmModal();
                });
            }
            
            // Fechar modais com ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeConfirmModal();
                    document.getElementById('notificationsModal').style.display = 'none';
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('overlay').classList.remove('active');
                    document.getElementById('userDropdown').style.display = 'none';
                }
            });
            
            // Carregar configurações salvas
            loadSavedSettings();
        }
        
        function startClock() {
            function updateTime() {
                const now = new Date();
                const timeElement = document.getElementById('serverTime');
                if (timeElement) {
                    const timeString = now.toLocaleTimeString('pt-PT');
                    const dateString = now.toLocaleDateString('pt-PT', {
                        weekday: 'short',
                        day: '2-digit',
                        month: 'short'
                    });
                    timeElement.textContent = `${dateString} ${timeString}`;
                }
            }
            
            updateTime();
            setInterval(updateTime, 1000);
        }
        
        // ============ FUNÇÕES AUXILIARES ============
        
        function handleAvatarError(imgElement, containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '<i class="fas fa-user-tie"></i>';
            }
        }
        
        function removeTag(element) {
            const tag = element.parentElement;
            tag.remove();
            saveLanguageTags();
        }
        
        function saveLanguageTags() {
            const tags = document.querySelectorAll('#languageTags .tag');
            const languages = Array.from(tags).map(tag => 
                tag.textContent.replace('×', '').trim()
            );
            localStorage.setItem('b7uno-languages', JSON.stringify(languages));
        }
        
        function loadLanguageTags() {
            const savedLanguages = localStorage.getItem('b7uno-languages');
            if (savedLanguages) {
                const languages = JSON.parse(savedLanguages);
                const tagsContainer = document.getElementById('languageTags');
                const input = tagsContainer.querySelector('input');
                
                languages.forEach(lang => {
                    const tag = document.createElement('div');
                    tag.className = 'tag';
                    tag.innerHTML = `
                        ${lang}
                        <span class="tag-remove" onclick="removeTag(this)">×</span>
                    `;
                    tagsContainer.insertBefore(tag, input);
                });
            }
        }
        
        // ============ MODAL DE CONFIRMAÇÃO ============
        
        window.currentConfirmCallback = null;
        
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            window.currentConfirmCallback = callback;
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            window.currentConfirmCallback = null;
        }
        
        // ============ FUNÇÕES DE GUARDAR CONFIGURAÇÕES ============
        
        function saveGeneralSettings() {
            const settings = {
                casinoName: document.getElementById('casinoName').value,
                casinoUrl: document.getElementById('casinoUrl').value,
                mainCurrency: document.getElementById('mainCurrency').value,
                timezone: document.getElementById('timezone').value,
                mainLanguage: document.getElementById('mainLanguage').value,
                dateFormat: document.getElementById('dateFormat').value,
                timeFormat: document.getElementById('timeFormat').value,
                sessionsLimit: document.getElementById('sessionsLimit').value,
                maintenanceMode: document.getElementById('maintenanceToggle').classList.contains('active'),
                allowRegistrations: document.getElementById('registrationsToggle').classList.contains('active'),
                debugMode: document.getElementById('debugToggle').classList.contains('active'),
                emailNotifications: document.getElementById('emailNotificationsToggle').classList.contains('active'),
                twoFactorAuth: document.getElementById('twoFactorToggle').classList.contains('active')
            };
            
            showConfirmModal('Guardar configurações gerais?', function() {
                // Enviar para o servidor
                fetch('/api/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('✅ Configurações gerais guardadas com sucesso!', 'success');
                        localStorage.setItem('b7uno-general-settings', JSON.stringify(settings));
                    } else {
                        showToast('❌ Erro ao guardar configurações: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showToast('❌ Erro de conexão ao guardar configurações', 'error');
                });
            });
        }
        
        function saveSecuritySettings() {
            const settings = {
                passwordStrength: document.getElementById('passwordStrength').value,
                sessionTimeout: document.getElementById('sessionTimeout').value,
                loginLogging: document.getElementById('loginLoggingToggle').classList.contains('active'),
                ipBlock: document.getElementById('ipBlockToggle').classList.contains('active'),
                ipBlockTime: document.getElementById('ipBlockTime').value,
                allowedIPs: document.getElementById('allowedIPs').value,
                ddosProtection: document.getElementById('ddosProtectionToggle').classList.contains('active'),
                geolocation: document.getElementById('geolocationToggle').classList.contains('active'),
                hashAlgorithm: document.getElementById('hashAlgorithm').value,
                bcryptCost: document.getElementById('bcryptCost').value,
                dataEncryption: document.getElementById('dataEncryptionToggle').classList.contains('active'),
                logRetentionDays: document.getElementById('logRetentionDays').value,
                fullAudit: document.getElementById('fullAuditToggle').classList.contains('active')
            };
            
            showConfirmModal('Guardar configurações de segurança?', function() {
                fetch('/api/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('✅ Configurações de segurança guardadas!', 'success');
                        localStorage.setItem('b7uno-security-settings', JSON.stringify(settings));
                    } else {
                        showToast('❌ Erro ao guardar configurações', 'error');
                    }
                })
                .catch(error => {
                    showToast('❌ Erro de conexão', 'error');
                });
            });
        }
        
        function savePaymentSettings() {
            const settings = {
                minDeposit: parseFloat(document.getElementById('minDeposit').value),
                maxDeposit: parseFloat(document.getElementById('maxDeposit').value),
                minWithdrawal: parseFloat(document.getElementById('minWithdrawal').value),
                maxWithdrawal: parseFloat(document.getElementById('maxWithdrawal').value),
                dailyWithdrawalLimit: parseFloat(document.getElementById('dailyWithdrawalLimit').value),
                withdrawalFee: parseFloat(document.getElementById('withdrawalFee').value),
                creditCardEnabled: document.getElementById('creditCardToggle').classList.contains('active'),
                mbwayEnabled: document.getElementById('mbwayToggle').classList.contains('active'),
                bankTransferEnabled: document.getElementById('bankTransferToggle').classList.contains('active'),
                skrillEnabled: document.getElementById('skrillToggle').classList.contains('active'),
                netellerEnabled: document.getElementById('netellerToggle').classList.contains('active'),
                cryptoEnabled: document.getElementById('cryptoToggle').classList.contains('active'),
                processingTime: document.getElementById('processingTime').value,
                paymentGateway: document.getElementById('paymentGateway').value,
                apiKey: document.getElementById('apiKey').value,
                secretKey: document.getElementById('secretKey').value,
                webhookUrl: document.getElementById('webhookUrl').value,
                sandboxMode: document.getElementById('sandboxToggle').classList.contains('active')
            };
            
            showConfirmModal('Guardar configurações de pagamento?', function() {
                fetch('/api/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('✅ Configurações de pagamento guardadas!', 'success');
                        localStorage.setItem('b7uno-payment-settings', JSON.stringify(settings));
                    } else {
                        showToast('❌ Erro ao guardar configurações', 'error');
                    }
                })
                .catch(error => {
                    showToast('❌ Erro de conexão', 'error');
                });
            });
        }
        
        function saveEmailSettings() {
            const settings = {
                smtpHost: document.getElementById('smtpHost').value,
                smtpPort: document.getElementById('smtpPort').value,
                smtpEmail: document.getElementById('smtpEmail').value,
                smtpSsl: document.getElementById('smtpSslToggle').classList.contains('active')
            };
            
            showConfirmModal('Guardar configurações de email?', function() {
                fetch('/api/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('✅ Configurações de email guardadas!', 'success');
                        localStorage.setItem('b7uno-email-settings', JSON.stringify(settings));
                    } else {
                        showToast('❌ Erro ao guardar configurações', 'error');
                    }
                })
                .catch(error => {
                    showToast('❌ Erro de conexão', 'error');
                });
            });
        }
        
        function saveGameSettings() {
            const settings = {
                houseEdge: parseFloat(document.getElementById('houseEdge').value),
                gamesMaintenance: document.getElementById('gamesMaintenanceToggle').classList.contains('active'),
                demoMode: document.getElementById('demoModeToggle').classList.contains('active')
            };
            
            showConfirmModal('Guardar configurações de jogos?', function() {
                fetch('/api/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('✅ Configurações de jogos guardadas!', 'success');
                        localStorage.setItem('b7uno-game-settings', JSON.stringify(settings));
                    } else {
                        showToast('❌ Erro ao guardar configurações', 'error');
                    }
                })
                .catch(error => {
                    showToast('❌ Erro de conexão', 'error');
                });
            });
        }
        
        function saveAdvancedSettings() {
            const settings = {
                apiRateLimit: parseInt(document.getElementById('apiRateLimit').value),
                cacheTime: parseInt(document.getElementById('cacheTime').value),
                devMode: document.getElementById('devModeToggle').classList.contains('active')
            };
            
            showConfirmModal('Guardar configurações avançadas?', function() {
                fetch('/api/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('✅ Configurações avançadas guardadas!', 'success');
                        localStorage.setItem('b7uno-advanced-settings', JSON.stringify(settings));
                    } else {
                        showToast('❌ Erro ao guardar configurações', 'error');
                    }
                })
                .catch(error => {
                    showToast('❌ Erro de conexão', 'error');
                });
            });
        }
        
        // ============ FUNÇÕES DE TESTE ============
        
        function testEncryption() {
            showToast('🔐 Testando configuração de criptografia...', 'info');
            
            setTimeout(() => {
                showToast('✅ Configuração de criptografia está funcional!', 'success');
            }, 1500);
        }
        
        function testPaymentGateway() {
            showToast('💳 Testando conexão com gateway...', 'info');
            
            setTimeout(() => {
                showToast('✅ Gateway conectado com sucesso!', 'success');
            }, 1500);
        }
        
        function testEmailSettings() {
            showToast('📧 Testando configuração de email...', 'info');
            
            setTimeout(() => {
                showToast('✅ Configuração de email está funcional!', 'success');
            }, 1500);
        }
        
        function exportSecurityLogs(format) {
            showToast(`📤 Exportando logs em formato ${format.toUpperCase()}...`, 'info');
            
            setTimeout(() => {
                showToast(`✅ Logs exportados com sucesso!`, 'success');
            }, 1500);
        }
        
        function clearSystemCache() {
            showConfirmModal('Tem certeza que deseja limpar o cache do sistema?', function() {
                showToast('🧹 Limpando cache do sistema...', 'info');
                
                setTimeout(() => {
                    showToast('✅ Cache do sistema limpo com sucesso!', 'success');
                }, 1500);
            });
        }
        
        // ============ NOTIFICAÇÕES ============
        
        function loadNotifications() {
            fetch('/api/notifications')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.notifications && data.notifications.length > 0) {
                        const notificationsList = document.getElementById('notificationsList');
                        notificationsList.innerHTML = '';
                        
                        data.notifications.forEach(notification => {
                            const notificationItem = document.createElement('div');
                            notificationItem.className = `notification-item ${notification.read ? 'read' : 'unread'}`;
                            notificationItem.innerHTML = `
                                <div class="notification-icon ${notification.type}">
                                    <i class="fas fa-${getNotificationIcon(notification.type)}"></i>
                                </div>
                                <div class="notification-content">
                                    <div class="notification-title">${notification.title}</div>
                                    <div class="notification-message">${notification.message}</div>
                                    <div class="notification-time">${new Date(notification.createdAt).toLocaleString('pt-PT')}</div>
                                </div>
                            `;
                            
                            if (!notification.read) {
                                notificationItem.addEventListener('click', function() {
                                    markNotificationAsRead(notification.id);
                                });
                            }
                            
                            notificationsList.appendChild(notificationItem);
                        });
                        
                        // Atualizar contador
                        const unreadCount = data.notifications.filter(n => !n.read).length;
                        updateNotificationCount(unreadCount);
                    } else {
                        document.getElementById('notificationsList').innerHTML = `
                            <div class="empty-notifications">
                                <i class="fas fa-bell-slash"></i>
                                <p>Nenhuma notificação</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar notificações:', error);
                    document.getElementById('notificationsList').innerHTML = `
                        <div class="empty-notifications">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Erro ao carregar notificações</p>
                        </div>
                    `;
                });
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                case 'info': return 'info-circle';
                case 'danger': return 'exclamation-circle';
                default: return 'info-circle';
            }
        }
        
        function markNotificationAsRead(notificationId) {
            fetch(`/api/notifications/${notificationId}/read`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadNotifications(); // Recarregar notificações
                }
            })
            .catch(error => console.error('Erro ao marcar notificação como lida:', error));
        }
        
        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notificationCount');
            if (count > 0) {
                notificationCount.textContent = count;
                notificationCount.classList.add('show');
            } else {
                notificationCount.classList.remove('show');
            }
        }
        
        // ============ TOAST SYSTEM ============
        
        function showToast(message, type = 'info') {
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // ============ CARREGAR CONFIGURAÇÕES SALVAS ============
        
        function loadSavedSettings() {
            // Carregar configurações gerais
            const generalSettings = localStorage.getItem('b7uno-general-settings');
            if (generalSettings) {
                try {
                    const settings = JSON.parse(generalSettings);
                    if (settings.casinoName) document.getElementById('casinoName').value = settings.casinoName;
                    if (settings.casinoUrl) document.getElementById('casinoUrl').value = settings.casinoUrl;
                    if (settings.mainCurrency) document.getElementById('mainCurrency').value = settings.mainCurrency;
                    if (settings.timezone) document.getElementById('timezone').value = settings.timezone;
                    if (settings.mainLanguage) document.getElementById('mainLanguage').value = settings.mainLanguage;
                    if (settings.dateFormat) document.getElementById('dateFormat').value = settings.dateFormat;
                    if (settings.timeFormat) document.getElementById('timeFormat').value = settings.timeFormat;
                    if (settings.sessionsLimit) {
                        document.getElementById('sessionsLimit').value = settings.sessionsLimit;
                        document.getElementById('sessionsValue').textContent = settings.sessionsLimit;
                    }
                } catch (e) {
                    console.error('Erro ao carregar configurações:', e);
                }
            }
            
            // Carregar tags de idioma
            loadLanguageTags();
        }
        
        // Fallback: Se algo falhar, mostrar dashboard após 10 segundos
        setTimeout(() => {
            if (document.getElementById('confidentialityModal').style.display === 'flex') {
                console.log('⚠️ Timeout - Mostrando dashboard por segurança');
                showDashboard();
            }
        }, 10000);
    </script>
</body>
</html>