<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof title !== 'undefined' ? title : 'B7Uno Casino | Dashboard' %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* ESTILOS ESPECÍFICOS PARA O NOVO DASHBOARD */
        .dashboard-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .overview-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .overview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            border-color: var(--accent-primary);
        }
        
        .overview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .overview-icon {
            width: 48px;
            height: 48px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--accent-primary);
        }
        
        .overview-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .overview-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .overview-trend {
            font-size: 12px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .overview-trend.negative {
            color: var(--danger);
        }
        
        /* MAIN CONTENT LAYOUT */
        .dashboard-main {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* RECENT ACTIVITY */
        .recent-activity {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
        }
        
        .activity-list {
            margin-top: 15px;
        }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .activity-details {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .activity-time {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }
        
        /* QUICK ACTIONS */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .quick-action-btn {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .quick-action-btn:hover {
            background: var(--accent-primary);
            color: white;
            transform: translateY(-2px);
        }
        
        /* QUICK EMAIL COMPACT - PARA STAFF INTERNO */
        .quick-email {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
        }
        
        .email-toggle {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 10px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .email-toggle:hover {
            background: rgba(212, 175, 55, 0.15);
        }
        
        .email-toggle.active {
            background: rgba(212, 175, 55, 0.2);
        }
        
        .email-form {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .email-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--accent-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .email-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-send {
            flex: 1;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(212, 175, 55, 0.3);
        }
        
        .btn-draft {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-draft:hover {
            background: var(--hover-bg);
        }
        
        /* RECENT EMAILS COMPACT */
        .recent-emails-compact {
            margin-top: 20px;
        }
        
        .email-item-compact {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }
        
        .email-item-compact:hover {
            background: var(--hover-bg);
        }
        
        .email-item-icon {
            width: 32px;
            height: 32px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .email-item-content {
            flex: 1;
            min-width: 0;
        }
        
        .email-item-subject {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .email-item-details {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            margin-top: 2px;
        }
        
        /* STATISTICS ROW - AGORA COM DADOS REAIS */
        .statistics-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .stat-title {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .stat-progress {
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .stat-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
        }
        
        /* PERMISSION CHECK STYLES - REMOVIDOS */
        .menu-item-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .menu-item-disabled:hover {
            background-color: transparent !important;
            color: var(--text-tertiary) !important;
        }
        
        /* ANIMATIONS */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .dashboard-overview {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-main {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-overview {
                grid-template-columns: 1fr;
            }
            
            .statistics-row {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
        
        /* TOAST STYLES */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--danger);
        }
        
        .toast.warning {
            border-left: 4px solid var(--warning);
        }
        
        .toast.info {
            border-left: 4px solid var(--info);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <% 
    // DECLARAÇÃO DE VARIÁVEIS COM DADOS REAIS
    const localRecentPlayers = typeof recentPlayers !== 'undefined' ? recentPlayers : [];
    const localRecentWithdrawals = typeof recentWithdrawals !== 'undefined' ? recentWithdrawals : [];
    const localRecentTickets = typeof recentTickets !== 'undefined' ? recentTickets : [];
    const localRecentEmails = typeof recentEmails !== 'undefined' ? recentEmails : [];
    const localRecentLogs = typeof recentLogs !== 'undefined' ? recentLogs : [];
    const staffMembers = typeof staffList !== 'undefined' ? staffList : [];
    const localAcceptedConfidentiality = typeof acceptedConfidentiality !== 'undefined' ? acceptedConfidentiality : false;

    // Stats com dados reais
    const localStats = stats || {};
    const safeStats = {
        pendingWithdrawals: localStats.pendingWithdrawals || 0,
        onlinePlayers: localStats.onlinePlayers || 0,
        totalPlayers: localStats.totalPlayers || 0,
        unresolvedAlerts: localStats.unresolvedAlerts || 0,
        withdrawalsAmount: localStats.withdrawalsAmount || 0,
        playerPercentage: localStats.playerPercentage || 0,
        openTickets: localStats.openTickets || 0,
        assignedTickets: localStats.assignedTickets || 0,
        recentEmails: localStats.recentEmails || 0,
        unreadLogs: localStats.unreadLogs || 0,
        totalDeposits: localStats.totalDeposits || 0,
        avgDeposit: localStats.avgDeposit || 0,
        conversionRate: localStats.conversionRate || 0,
        betVolume: localStats.betVolume || 0,
        playerSatisfaction: localStats.playerSatisfaction || 0
    };
    
    // Calcular tendências baseadas em dados reais
    const withdrawalTrend = localStats.withdrawalTrend || 0;
    const playerTrend = localStats.playerTrend || 0;
    const ticketTrend = localStats.ticketTrend || 0;
    const emailTrend = localStats.emailTrend || 0;
    
    // Verificar permissões - BASEADO NO server.js
    // Admin tem todas as permissões
    const isAdmin = user && user.role === 'admin';
    
    // Definir permissões baseadas no role do usuário
    let userPermissions = [];
    if (isAdmin) {
        userPermissions = ['all'];
    } else {
        switch(user.role) {
            case 'support_manager':
                userPermissions = ['view_dashboard', 'view_players', 'view_withdrawals', 'view_payments', 'view_support', 'view_staff', 'view_email', 'view_logs', 'view_settings', 'process_withdrawals', 'process_payments', 'assign_tickets', 'send_emails', 'manage_staff', 'manage_settings'];
                break;
            case 'support':
                userPermissions = ['view_dashboard', 'view_players', 'view_withdrawals', 'view_payments', 'view_support', 'view_email'];
                break;
            case 'finance':
                userPermissions = ['view_dashboard', 'view_players', 'view_withdrawals', 'view_payments', 'process_withdrawals', 'process_payments'];
                break;
            case 'moderator':
                userPermissions = ['view_dashboard', 'view_players', 'view_support'];
                break;
            case 'viewer':
                userPermissions = ['view_dashboard', 'view_players'];
                break;
            default:
                userPermissions = ['view_dashboard'];
        }
    }
    
    // Função para verificar permissões
    const hasPermission = (permission) => {
        return isAdmin || userPermissions.includes(permission) || userPermissions.includes('all');
    };
    
    // Determinar quais links de menu devem estar ativos
    const canViewPlayers = hasPermission('view_players');
    const canViewWithdrawals = hasPermission('view_withdrawals');
    const canViewPayments = hasPermission('view_payments');
    const canViewSupport = hasPermission('view_support');
    const canViewEmail = hasPermission('view_email');
    const canViewStaff = hasPermission('view_staff');
    const canViewLogs = hasPermission('view_logs');
    const canViewSettings = hasPermission('view_settings');
    const canProcessWithdrawals = hasPermission('process_withdrawals');
    const canProcessPayments = hasPermission('process_payments');
    %>
    
    <!-- ===== POPUP DE CONFIDENCIALIDADE ===== -->
    <% if (!localAcceptedConfidentiality) { %>
    <div class="confidentiality-modal" id="confidentialityModal">
        <div class="confidentiality-content">
            <i class="fas fa-shield-alt confidentiality-icon"></i>
            <h1 class="confidentiality-title">AVISO DE CONFIDENCIALIDADE</h1>
            <h2 class="confidentiality-subtitle">B7UNO CASINO - PAINEL DE ADMINISTRAÇÃO</h2>
            <div class="confidentiality-text">
                <p>Caríssimo Administrador,</p>
                <p>É com grande satisfação que o recebemos no Sistema de Administração do <strong>B7Uno Casino</strong>.</p>
                <div class="confidentiality-warning">
                    <i class="fas fa-eye"></i>
                    <p>⚠️ TODAS AS AÇÕES SÃO MONITORIZADAS ⚠️</p>
                </div>
            </div>
            <div class="confidentiality-buttons">
                <button class="confidentiality-btn accept" id="acceptConfidentiality">
                    <i class="fas fa-check-circle"></i>
                    ACEITO
                </button>
                <button class="confidentiality-btn reject" id="rejectConfidentiality">
                    <i class="fas fa-times-circle"></i>
                    SAIR
                </button>
            </div>
        </div>
    </div>
    <% } %>

    <!-- Main Container -->
    <div class="app-container" id="mainApp" style="<%= !localAcceptedConfidentiality ? 'display: none;' : 'display: flex;' %>">
        <!-- Sidebar com notificações reais -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h2>B7Uno <span class="b7uno-badge">ADMIN</span></h2>
                <div class="user-mini-info">
                    <div class="user-mini-avatar" id="sidebarAvatar">
                        <% if (user && user.photo) { %>
                            <img src="/uploads/<%= user.photo %>?t=<%= Date.now() %>" 
                                 alt="<%= user.name %>"
                                 onerror="handleAvatarError(this, 'sidebarAvatar')">
                        <% } else { %>
                            <i class="fas fa-user-tie"></i>
                        <% } %>
                    </div>
                    <div class="user-mini-details">
                        <span id="sidebarStaffName"><%= user.name %></span>
                        <small id="sidebarStaffRole"><%= user.role.toUpperCase() %></small>
                    </div>
                </div>
            </div>
            
            <ul class="menu">
                <li><a href="/dashboard" class="active">
                    <i class="fas fa-home"></i><span> Dashboard</span>
                </a></li>
                
                <!-- Jogadores -->
                <% if (canViewPlayers) { %>
                <li><a href="/players">
                    <i class="fas fa-users"></i><span> Jogadores</span>
                    <% if (safeStats.totalPlayers > 0) { %>
                        <span class="badge"><%= safeStats.totalPlayers > 99 ? '99+' : safeStats.totalPlayers %></span>
                    <% } %>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão para ver jogadores">
                    <i class="fas fa-users"></i><span> Jogadores</span>
                </a></li>
                <% } %>
                
                <!-- Levantamentos -->
                <% if (canViewWithdrawals) { %>
                <li><a href="/withdrawals">
                    <i class="fas fa-money-bill-wave"></i><span> Levantamentos</span>
                    <% if (safeStats.pendingWithdrawals > 0) { %>
                        <span class="badge"><%= safeStats.pendingWithdrawals %></span>
                    <% } %>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão para ver levantamentos">
                    <i class="fas fa-money-bill-wave"></i><span> Levantamentos</span>
                </a></li>
                <% } %>
                
                <!-- Suporte -->
                <% if (canViewSupport) { %>
                <li><a href="/support">
                    <i class="fas fa-headset"></i><span> Support</span>
                    <% if (safeStats.openTickets > 0) { %>
                        <span class="badge"><%= safeStats.openTickets %></span>
                    <% } %>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão para ver suporte">
                    <i class="fas fa-headset"></i><span> Support</span>
                </a></li>
                <% } %>
                
                <!-- Email -->
                <% if (canViewEmail) { %>
                <li><a href="/email">
                    <i class="fas fa-envelope"></i><span> Email</span>
                    <% if (safeStats.recentEmails > 0) { %>
                        <span class="badge"><%= safeStats.recentEmails %></span>
                    <% } %>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão para ver email">
                    <i class="fas fa-envelope"></i><span> Email</span>
                </a></li>
                <% } %>
                
                <!-- Staff -->
                <% if (canViewStaff) { %>
                <li><a href="/staff">
                    <i class="fas fa-user-tie"></i><span> Staff</span>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão para ver staff">
                    <i class="fas fa-user-tie"></i><span> Staff</span>
                </a></li>
                <% } %>
                
                <!-- Logs -->
                <% if (canViewLogs) { %>
                <li><a href="/logs">
                    <i class="fas fa-clipboard-list"></i><span> Logs</span>
                    <% if (safeStats.unreadLogs > 0) { %>
                        <span class="badge"><%= safeStats.unreadLogs > 9 ? '9+' : safeStats.unreadLogs %></span>
                    <% } %>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão para ver logs">
                    <i class="fas fa-clipboard-list"></i><span> Logs</span>
                </a></li>
                <% } %>
                
                <!-- Definições -->
                <% if (canViewSettings) { %>
                <li><a href="/settings">
                    <i class="fas fa-cog"></i><span> Definições</span>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão para ver definições">
                    <i class="fas fa-cog"></i><span> Definições</span>
                </a></li>
                <% } %>
                
                <!-- Tema -->
                <li>
                    <div class="theme-toggle" id="sidebarThemeToggle">
                        <input type="checkbox" id="sidebarThemeCheckbox">
                        <div class="toggle-switch"></div>
                        <span class="theme-label" id="sidebarThemeLabel">Modo Escuro</span>
                    </div>
                </li>
                
                <!-- Logout -->
                <li>
                    <a href="#" id="logoutBtnSidebar">
                        <i class="fas fa-sign-out-alt"></i><span> Logout</span>
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-footer">
                <div class="system-status">
                    <div class="status-indicator online"></div>
                    <span>Sistema Online</span>
                </div>
                <div class="server-time" id="serverTime">--:--:--</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Topbar com notificações reais -->
            <div class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="breadcrumb" id="breadcrumb">
                        Dashboard Principal
                    </div>
                </div>
                
                <div class="topbar-right">
                    <!-- Theme Toggle -->
                    <div class="theme-toggle" id="topbarThemeToggle">
                        <input type="checkbox" id="topbarThemeCheckbox">
                        <div class="toggle-switch"></div>
                        <span class="theme-label" id="topbarThemeLabel">Modo Escuro</span>
                    </div>
                    
                    <div class="notifications">
                        <button class="notification-btn" id="notificationBtn">
                            <i class="fas fa-bell"></i>
                            <% 
                                const totalAlerts = safeStats.unresolvedAlerts + safeStats.unreadLogs;
                                if (totalAlerts > 0) { 
                            %>
                                <span class="notification-count show">
                                    <%= totalAlerts > 9 ? '9+' : totalAlerts %>
                                </span>
                            <% } %>
                        </button>
                    </div>
                    
                    <div class="user-profile" id="userProfile">
                        <div class="user-avatar" id="userAvatar">
                            <% if (user && user.photo) { %>
                                <img src="/uploads/<%= user.photo %>?t=<%= Date.now() %>" 
                                     alt="<%= user.name %>" 
                                     id="userAvatarImage"
                                     onerror="handleAvatarError(this, 'userAvatar')">
                            <% } else { %>
                                <span id="userInitials"><%= user.name.split(' ').map(n => n[0]).join('').toUpperCase() %></span>
                            <% } %>
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="topbarStaffName"><%= user.name %></div>
                            <div class="user-role" id="topbarStaffRole"><%= user.role.toUpperCase() %></div>
                            <i class="fas fa-chevron-down" style="font-size: 12px; color: var(--text-secondary); margin-left: 5px;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Dropdown -->
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-header">
                    <div class="user-info">
                        <div class="user-avatar" id="dropdownAvatar">
                            <% if (user && user.photo) { %>
                                <img src="/uploads/<%= user.photo %>?t=<%= Date.now() %>" 
                                     alt="<%= user.name %>" 
                                     id="dropdownAvatarImage"
                                     onerror="handleAvatarError(this, 'dropdownAvatar')">
                            <% } else { %>
                                <span id="dropdownInitials"><%= user.name.split(' ').map(n => n[0]).join('').toUpperCase() %></span>
                            <% } %>
                        </div>
                        <div>
                            <div class="user-name" id="dropdownUserName"><%= user.name %></div>
                            <div class="user-role"><%= user.role.toUpperCase() %></div>
                            <div class="user-email" style="font-size: 11px; color: var(--text-secondary);">
                                <%= user.email %>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dropdown-body">
                    <a href="/profile" class="dropdown-item" id="myProfileLink">
                        <i class="fas fa-user"></i>
                        <span>Meu Perfil</span>
                    </a>
                    <% if (canViewSettings) { %>
                        <a href="/settings" class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            <span>Definições</span>
                        </a>
                    <% } %>
                    <% if (canViewLogs) { %>
                        <a href="/logs" class="dropdown-item">
                            <i class="fas fa-history"></i>
                            <span>Histórico</span>
                        </a>
                    <% } %>
                </div>
                <div class="dropdown-footer">
                    <button class="btn btn-secondary" id="logoutBtnDropdown">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>

            <!-- Modal de Notificações -->
            <div class="modal" id="notificationsModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-bell"></i> Notificações</h3>
                        <button class="modal-close" id="modalClose">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="notifications-list" id="notificationsList">
                            <div class="empty-notifications">
                                <i class="fas fa-bell-slash"></i>
                                <p>Carregando notificações...</p>
                            </div>
                        </div>
                        <div class="modal-actions" style="padding: 16px 24px; border-top: 1px solid var(--border-color);">
                            <button class="btn btn-secondary" id="markAllAsReadBtn" style="width: 100%; margin-bottom: 8px;">
                                <i class="fas fa-check-double"></i> Marcar todas como lidas
                            </button>
                            <button class="btn btn-secondary" id="clearAllNotificationsBtn" style="width: 100%;">
                                <i class="fas fa-trash"></i> Limpar todas
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Header -->
                <div class="dashboard-header" style="margin-bottom: 30px;">
                    <h1 style="font-size: 24px; margin-bottom: 8px;">
                        <i class="fas fa-tachometer-alt"></i> Visão Geral
                    </h1>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        Bem-vindo, <strong><%= user.name %></strong>. Aqui está um resumo das operações.
                        <% if (user.lastLogin) { %>
                            <br><small style="font-size: 12px;">Último login: <%= new Date(user.lastLogin).toLocaleString('pt-PT') %></small>
                        <% } %>
                    </p>
                </div>
                
                <!-- ===== OVERVIEW CARDS COM DADOS REAIS ===== -->
                <div class="dashboard-overview">
                    <!-- Levantamentos -->
                    <% if (canViewWithdrawals) { %>
                    <div class="overview-card" onclick="window.location.href='/withdrawals'">
                        <div class="overview-header">
                            <div class="overview-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div style="text-align: right;">
                                <div class="overview-trend <%= withdrawalTrend < 0 ? 'negative' : '' %>">
                                    <i class="fas fa-arrow-<%= withdrawalTrend >= 0 ? 'up' : 'down' %>"></i>
                                    <span><%= Math.abs(withdrawalTrend) %>%</span>
                                </div>
                            </div>
                        </div>
                        <div class="overview-title">Levantamentos Pendentes</div>
                        <div class="overview-value"><%= safeStats.pendingWithdrawals %></div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">
                            €<%= safeStats.withdrawalsAmount?.toFixed(2) || '0.00' %>
                        </div>
                    </div>
                    <% } else { %>
                    <div class="overview-card" style="opacity: 0.5; cursor: not-allowed;" title="Sem permissão para ver levantamentos">
                        <div class="overview-header">
                            <div class="overview-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                        </div>
                        <div class="overview-title">Levantamentos Pendentes</div>
                        <div class="overview-value">--</div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">
                            Sem permissão
                        </div>
                    </div>
                    <% } %>
                    
                    <!-- Jogadores -->
                    <% if (canViewPlayers) { %>
                    <div class="overview-card" onclick="window.location.href='/players?status=online'">
                        <div class="overview-header">
                            <div class="overview-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div style="text-align: right;">
                                <div class="overview-trend <%= playerTrend < 0 ? 'negative' : '' %>">
                                    <i class="fas fa-arrow-<%= playerTrend >= 0 ? 'up' : 'down' %>"></i>
                                    <span><%= Math.abs(playerTrend) %>%</span>
                                </div>
                            </div>
                        </div>
                        <div class="overview-title">Jogadores Ativos</div>
                        <div class="overview-value"><%= safeStats.totalPlayers %></div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">
                            <%= safeStats.onlinePlayers %> online
                        </div>
                    </div>
                    <% } else { %>
                    <div class="overview-card" style="opacity: 0.5; cursor: not-allowed;" title="Sem permissão para ver jogadores">
                        <div class="overview-header">
                            <div class="overview-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="overview-title">Jogadores Ativos</div>
                        <div class="overview-value">--</div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">
                            Sem permissão
                        </div>
                    </div>
                    <% } %>
                    
                    <!-- Suporte -->
                    <% if (canViewSupport) { %>
                    <div class="overview-card" onclick="window.location.href='/support'">
                        <div class="overview-header">
                            <div class="overview-icon">
                                <i class="fas fa-headset"></i>
                            </div>
                            <div style="text-align: right;">
                                <div class="overview-trend <%= ticketTrend < 0 ? 'negative' : '' %>">
                                    <i class="fas fa-arrow-<%= ticketTrend >= 0 ? 'up' : 'down' %>"></i>
                                    <span><%= Math.abs(ticketTrend) %>%</span>
                                </div>
                            </div>
                        </div>
                        <div class="overview-title">Tickets de Suporte</div>
                        <div class="overview-value"><%= safeStats.openTickets %></div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">
                            <%= safeStats.assignedTickets %> atribuídos
                        </div>
                    </div>
                    <% } else { %>
                    <div class="overview-card" style="opacity: 0.5; cursor: not-allowed;" title="Sem permissão para ver suporte">
                        <div class="overview-header">
                            <div class="overview-icon">
                                <i class="fas fa-headset"></i>
                            </div>
                        </div>
                        <div class="overview-title">Tickets de Suporte</div>
                        <div class="overview-value">--</div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">
                            Sem permissão
                        </div>
                    </div>
                    <% } %>
                    
                    <!-- Email -->
                    <% if (canViewEmail) { %>
                    <div class="overview-card" onclick="window.location.href='/email'">
                        <div class="overview-header">
                            <div class="overview-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div style="text-align: right;">
                                <div class="overview-trend <%= emailTrend < 0 ? 'negative' : '' %>">
                                    <i class="fas fa-arrow-<%= emailTrend >= 0 ? 'up' : 'down' %>"></i>
                                    <span><%= Math.abs(emailTrend) %>%</span>
                                </div>
                            </div>
                        </div>
                        <div class="overview-title">Comunicação</div>
                        <div class="overview-value"><%= safeStats.recentEmails %></div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">
                            Últimas 24h
                        </div>
                    </div>
                    <% } else { %>
                    <div class="overview-card" style="opacity: 0.5; cursor: not-allowed;" title="Sem permissão para ver email">
                        <div class="overview-header">
                            <div class="overview-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                        </div>
                        <div class="overview-title">Comunicação</div>
                        <div class="overview-value">--</div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">
                            Sem permissão
                        </div>
                    </div>
                    <% } %>
                </div>
                
                <!-- ===== ESTATÍSTICAS COM DADOS REAIS ===== -->
                <div class="statistics-row">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Taxa de Conversão</div>
                            <i class="fas fa-percentage" style="color: var(--accent-primary);"></i>
                        </div>
                        <div class="stat-value"><%= safeStats.conversionRate?.toFixed(1) || '0.0' %>%</div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">Média diária</div>
                        <div class="stat-progress">
                            <div class="stat-progress-bar" style="width: <%= Math.min(safeStats.conversionRate || 0, 100) %>%;"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Volume de Apostas</div>
                            <i class="fas fa-chart-line" style="color: var(--accent-primary);"></i>
                        </div>
                        <div class="stat-value">€<%= (safeStats.betVolume || 0).toLocaleString('pt-PT', {minimumFractionDigits: 0}) %></div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">Hoje</div>
                        <div class="stat-progress">
                            <div class="stat-progress-bar" style="width: <%= Math.min((safeStats.betVolume || 0) / 10000 * 100, 100) %>%;"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Satisfação Clientes</div>
                            <i class="fas fa-star" style="color: var(--accent-primary);"></i>
                        </div>
                        <div class="stat-value"><%= safeStats.playerSatisfaction?.toFixed(1) || '0.0' %></div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">/10 pontos</div>
                        <div class="stat-progress">
                            <div class="stat-progress-bar" style="width: <%= (safeStats.playerSatisfaction || 0) * 10 %>%;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ===== MAIN CONTENT + EMAIL INTERNO ===== -->
                <div class="dashboard-main">
                    <!-- Coluna Principal -->
                    <div>
                        <!-- Atividade Recente -->
                        <div class="recent-activity">
                            <div class="section-header">
                                <h3><i class="fas fa-history"></i> Atividade Recente</h3>
                                <% if (canViewLogs) { %>
                                <button class="btn-view-all" onclick="window.location.href='/logs'">
                                    Ver Logs
                                </button>
                                <% } %>
                            </div>
                            
                            <div class="activity-list">
                                <% 
                                    // Combinar todas as atividades recentes de diferentes fontes
                                    const recentActivities = [];
                                    
                                    // Adicionar logs recentes (se existirem)
                                    if (localRecentLogs && localRecentLogs.length > 0 && canViewLogs) {
                                        localRecentLogs.slice(0, 3).forEach(log => {
                                            recentActivities.push({
                                                type: 'log',
                                                icon: 'fa-clipboard-list',
                                                title: 'Registo de Sistema',
                                                details: log.action || 'Ação do sistema',
                                                time: log.timestamp || new Date()
                                            });
                                        });
                                    }
                                    
                                    // Adicionar jogadores recentes (se tiver permissão)
                                    if (canViewPlayers) {
                                        localRecentPlayers.slice(0, 2).forEach(player => {
                                            recentActivities.push({
                                                type: 'player',
                                                icon: 'fa-user',
                                                title: player.status === 'online' ? 'Jogador Online' : 'Novo Jogador',
                                                details: `${player.name} (${player.email})`,
                                                time: player.lastLogin || player.createdAt || new Date()
                                            });
                                        });
                                    }
                                    
                                    // Adicionar levantamentos recentes (se tiver permissão)
                                    if (canViewWithdrawals) {
                                        localRecentWithdrawals.slice(0, 2).forEach(withdrawal => {
                                            recentActivities.push({
                                                type: 'withdrawal',
                                                icon: 'fa-money-bill',
                                                title: 'Levantamento Solicitado',
                                                details: `${withdrawal.playerName} - €${withdrawal.amount?.toFixed(2) || '0.00'}`,
                                                time: withdrawal.requestedAt || new Date()
                                            });
                                        });
                                    }
                                    
                                    // Ordenar por data (mais recente primeiro)
                                    recentActivities.sort((a, b) => new Date(b.time) - new Date(a.time));
                                    
                                    // Mostrar apenas 5 atividades
                                    const activitiesToShow = recentActivities.slice(0, 5);
                                %>
                                
                                <% if (activitiesToShow.length > 0) { %>
                                    <% activitiesToShow.forEach(activity => { %>
                                        <div class="activity-item">
                                            <div class="activity-icon">
                                                <i class="fas <%= activity.icon %>"></i>
                                            </div>
                                            <div class="activity-content">
                                                <div class="activity-title"><%= activity.title %></div>
                                                <div class="activity-details"><%= activity.details %></div>
                                                <div class="activity-time">
                                                    <%= new Date(activity.time).toLocaleString('pt-PT', { 
                                                        day: '2-digit',
                                                        month: '2-digit',
                                                        hour: '2-digit',
                                                        minute: '2-digit'
                                                    }) %>
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <div class="empty-state" style="padding: 30px 20px;">
                                        <i class="fas fa-history" style="font-size: 32px;"></i>
                                        <p>Sem atividade recente</p>
                                    </div>
                                <% } %>
                            </div>
                            
                            <!-- Ações Rápidas FUNCIONAIS -->
                            <div class="quick-actions">
                                <% if (canViewPlayers) { %>
                                <button class="quick-action-btn" onclick="window.location.href='/players?view=new'">
                                    <i class="fas fa-user-plus"></i>
                                    Ver Jogadores
                                </button>
                                <% } %>
                                
                                <% if (canProcessWithdrawals) { %>
                                <button class="quick-action-btn" onclick="window.location.href='/withdrawals?filter=pending'">
                                    <i class="fas fa-check-circle"></i>
                                    Aprovar Levantamentos
                                </button>
                                <% } else if (canViewWithdrawals) { %>
                                <button class="quick-action-btn" onclick="window.location.href='/withdrawals?filter=pending'">
                                    <i class="fas fa-eye"></i>
                                    Ver Levantamentos
                                </button>
                                <% } %>
                                
                                <% if (canViewSupport) { %>
                                <button class="quick-action-btn" onclick="window.location.href='/support?status=open'">
                                    <i class="fas fa-ticket-alt"></i>
                                    Ver Tickets
                                </button>
                                <% } %>
                                
                                <% if (canViewEmail) { %>
                                <button class="quick-action-btn" onclick="window.location.href='/email'">
                                    <i class="fas fa-envelope"></i>
                                    Mensagens
                                </button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ===== COLUNA LATERAL - EMAIL INTERNO PARA STAFF ===== -->
                    <% if (canViewEmail) { %>
                    <div class="quick-email">
                        <!-- Toggle do Email Interno -->
                        <div class="email-toggle" id="emailToggle">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-users" style="color: var(--accent-primary);"></i>
                                <div>
                                    <div style="font-weight: 600; font-size: 14px;">Mensagem Interna</div>
                                    <div style="font-size: 11px; color: var(--text-tertiary);">Enviar para membros da staff</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-down" id="emailToggleIcon"></i>
                        </div>
                        
                        <!-- Formulário de Email INTERNO -->
                        <div class="email-form" id="emailForm">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-user-tie"></i> Para (Staff)
                                </label>
                                <select class="form-select" id="emailRecipients">
                                    <option value="all_staff">Toda a Equipa</option>
                                    <option value="admins">Apenas Administradores</option>
                                    <option value="support">Apenas Suporte</option>
                                    <option value="finance">Apenas Financeiro</option>
                                    <% if (staffMembers && staffMembers.length > 0) { %>
                                        <optgroup label="Membros Específicos">
                                        <% staffMembers.forEach(staff => { 
                                            if (staff._id.toString() !== user.id) { // Não incluir o próprio utilizador
                                        %>
                                            <option value="<%= staff._id %>">
                                                <%= staff.name %> (<%= staff.role %>)
                                            </option>
                                        <% } %>
                                        <% }) %>
                                        </optgroup>
                                    <% } %>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-tag"></i> Assunto
                                </label>
                                <input type="text" class="form-input" id="emailSubject" 
                                       placeholder="Ex: Reunião de equipa ou Informação importante">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-envelope"></i> Mensagem
                                </label>
                                <textarea class="form-textarea" id="emailMessage" 
                                          placeholder="Escreva a sua mensagem interna..."></textarea>
                            </div>
                            
                            <div class="email-actions">
                                <button class="btn-send" id="sendInternalEmailBtn">
                                    <i class="fas fa-paper-plane"></i>
                                    Enviar Internamente
                                </button>
                                <button class="btn-draft" id="saveDraftBtn">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Mensagens Internas Recentes -->
                        <div class="recent-emails-compact">
                            <div style="margin-bottom: 15px; font-size: 14px; font-weight: 600; color: var(--text-primary);">
                                <i class="fas fa-comments" style="margin-right: 8px;"></i>
                                Comunicação Interna
                            </div>
                            
                            <% if (localRecentEmails && localRecentEmails.length > 0) { 
                                // Filtrar apenas emails internos (se existir flag isInternal)
                                const internalEmails = localRecentEmails.filter(email => email.isInternal).slice(0, 3);
                            %>
                                <% if (internalEmails.length > 0) { %>
                                    <% internalEmails.forEach(email => { %>
                                        <div class="email-item-compact" onclick="window.location.href='/email/view/<%= email._id %>'">
                                            <div class="email-item-icon">
                                                <i class="fas fa-user-tie"></i>
                                            </div>
                                            <div class="email-item-content">
                                                <div class="email-item-subject"><%= email.subject %></div>
                                                <div class="email-item-details">
                                                    <span><%= email.recipientCount || 1 %> destinatário(s)</span>
                                                    <span><%= new Date(email.sentAt).toLocaleDateString('pt-PT') %></span>
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <div style="text-align: center; padding: 15px; color: var(--text-tertiary); font-size: 13px;">
                                        <i class="fas fa-comments" style="font-size: 20px; margin-bottom: 8px; opacity: 0.5;"></i>
                                        <p>Sem mensagens internas recentes</p>
                                    </div>
                                <% } %>
                            <% } else { %>
                                <div style="text-align: center; padding: 15px; color: var(--text-tertiary); font-size: 13px;">
                                    <i class="fas fa-comments" style="font-size: 20px; margin-bottom: 8px; opacity: 0.5;"></i>
                                    <p>Sem mensagens internas recentes</p>
                                </div>
                            <% } %>
                            
                            <div style="text-align: center; margin-top: 10px;">
                                <button class="btn-view-all" onclick="window.location.href='/email?filter=internal'" 
                                        style="width: 100%; padding: 8px;">
                                    Ver todas as mensagens
                                </button>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>
        
        <!-- Overlay para mobile -->
        <div class="overlay" id="overlay"></div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Sistema B7Uno Carregado');
            console.log('👤 Usuário:', '<%= user.name %>');
            console.log('🎭 Role:', '<%= user.role %>');
            
            // VERIFICAÇÃO DOS TERMOS
            const hasAccepted = localStorage.getItem('b7uno_terms_accepted');
            const serverAccepted = <%= localAcceptedConfidentiality %>;
            
            if (hasAccepted === 'true' || serverAccepted) {
                showDashboard();
            } else {
                showPopup();
            }
        });
        
        function showDashboard() {
            const popup = document.getElementById('confidentialityModal');
            const app = document.getElementById('mainApp');
            
            if (popup) popup.style.display = 'none';
            if (app) app.style.display = 'flex';
            
            document.body.classList.remove('confidentiality-active');
            
            setTimeout(() => {
                initDashboard();
            }, 50);
        }
        
        function showPopup() {
            const popup = document.getElementById('confidentialityModal');
            const app = document.getElementById('mainApp');
            
            if (popup) popup.style.display = 'flex';
            if (app) app.style.display = 'none';
            
            document.body.classList.add('confidentiality-active');
            setupPopupButtons();
        }
        
        function setupPopupButtons() {
            const acceptBtn = document.getElementById('acceptConfidentiality');
            const rejectBtn = document.getElementById('rejectConfidentiality');
            
            if (acceptBtn) {
                acceptBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('✅ Botão ACEITAR clicado');
                    
                    // Salvar no localStorage
                    localStorage.setItem('b7uno_terms_accepted', 'true');
                    localStorage.setItem('b7uno_terms_accepted_date', new Date().toISOString());
                    localStorage.setItem('b7uno_terms_accepted_by', '<%= user.name %>');
                    
                    // Tentar salvar no servidor
                    tryToSaveToServer();
                    
                    // Mostrar dashboard
                    showDashboard();
                    
                    // Feedback visual
                    showToast('✅ Termos de confidencialidade aceitos! Bem-vindo ao Dashboard B7Uno.', 'success');
                });
            }
            
            if (rejectBtn) {
                rejectBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const confirmed = confirm('⚠️ Ao rejeitar os termos de confidencialidade, será redirecionado para fora do sistema. Continuar?');
                    if (confirmed) {
                        window.location.href = '/logout?reason=confidentiality_rejected';
                    }
                });
            }
        }
        
        function tryToSaveToServer() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            fetch('/api/confidentiality/accept', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (response.ok) {
                    console.log('✅ Aceitação salva no servidor');
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.log('⚠️ Não foi possível contactar o servidor, mas os termos foram aceitos localmente');
            });
        }
        
        function initDashboard() {
            console.log('🎰 Inicializando dashboard B7Uno...');
            
            initTheme();
            setupBasicEvents();
            setupNotifications();
            initInternalEmailSystem();
            startClock();
            setupAnimations();
        }
        
        function initTheme() {
            const savedTheme = localStorage.getItem('casinoX-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            document.querySelectorAll('.theme-toggle').forEach(toggle => {
                toggle.setAttribute('data-theme', savedTheme);
            });
            
            document.querySelectorAll('.theme-label').forEach(label => {
                label.textContent = savedTheme === 'light' ? 'Modo Claro' : 'Modo Escuro';
            });
            
            // Configurar checkbox inicial
            document.querySelectorAll('#sidebarThemeCheckbox, #topbarThemeCheckbox').forEach(checkbox => {
                checkbox.checked = savedTheme === 'light';
            });
        }
        
        function setupBasicEvents() {
            // TOGGLE DO TEMA - FIXADO
            document.querySelectorAll('.theme-toggle').forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('🎨 Tema clicado');
                    const current = document.documentElement.getAttribute('data-theme') || 'dark';
                    const newTheme = current === 'dark' ? 'light' : 'dark';
                    
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('casinoX-theme', newTheme);
                    
                    document.querySelectorAll('.theme-toggle').forEach(t => {
                        t.setAttribute('data-theme', newTheme);
                    });
                    
                    document.querySelectorAll('.theme-label').forEach(label => {
                        label.textContent = newTheme === 'light' ? 'Modo Claro' : 'Modo Escuro';
                    });
                    
                    // Atualizar checkboxes
                    document.querySelectorAll('#sidebarThemeCheckbox, #topbarThemeCheckbox').forEach(checkbox => {
                        checkbox.checked = newTheme === 'light';
                    });
                    
                    showToast(`Modo ${newTheme === 'light' ? 'Claro' : 'Escuro'} ativado`, 'info');
                });
            });
            
            // TOGGLE DO MENU
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle) {
                menuToggle.addEventListener('click', function() {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('overlay');
                    
                    if (window.innerWidth <= 1024) {
                        sidebar.classList.toggle('active');
                        overlay.classList.toggle('active');
                    } else {
                        sidebar.classList.toggle('collapsed');
                    }
                });
            }
            
            // OVERLAY
            const overlay = document.getElementById('overlay');
            if (overlay) {
                overlay.addEventListener('click', function() {
                    document.getElementById('sidebar').classList.remove('active');
                    overlay.classList.remove('active');
                });
            }
            
            // DROPDOWN DO PERFIL - FIXADO
            const userProfile = document.getElementById('userProfile');
            const userDropdown = document.getElementById('userDropdown');
            if (userProfile && userDropdown) {
                userProfile.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('👤 Perfil clicado');
                    userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                });
                
                // Fechar ao clicar fora
                document.addEventListener('click', function(e) {
                    if (!userProfile.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.style.display = 'none';
                    }
                });
            }
            
            // LOGOUT
            const logoutBtns = document.querySelectorAll('#logoutBtnSidebar, #logoutBtnDropdown');
            logoutBtns.forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (confirm('Deseja sair do sistema?')) {
                            window.location.href = '/logout';
                        }
                    });
                }
            });
            
            // PREVENIR CLICK NOS ITEMS DESABILITADOS
            document.querySelectorAll('.menu-item-disabled').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showToast('⚠️ Não tem permissão para aceder a esta secção.', 'warning');
                });
            });
            
            // PREVENIR CLICK NOS CARDS DESABILITADOS
            document.querySelectorAll('.overview-card[style*="cursor: not-allowed"]').forEach(card => {
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showToast('⚠️ Não tem permissão para ver esta informação.', 'warning');
                });
            });
        }
        
        function setupNotifications() {
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationsModal = document.getElementById('notificationsModal');
            const modalClose = document.getElementById('modalClose');
            const markAllAsReadBtn = document.getElementById('markAllAsReadBtn');
            const clearAllNotificationsBtn = document.getElementById('clearAllNotificationsBtn');
            
            // Abrir modal de notificações
            if (notificationBtn && notificationsModal) {
                notificationBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('🔔 Notificações clicado');
                    notificationsModal.style.display = 'flex';
                    loadNotifications();
                });
            }
            
            // Fechar modal
            if (modalClose) {
                modalClose.addEventListener('click', function() {
                    notificationsModal.style.display = 'none';
                });
            }
            
            // Fechar modal ao clicar fora
            if (notificationsModal) {
                notificationsModal.addEventListener('click', function(e) {
                    if (e.target === notificationsModal) {
                        notificationsModal.style.display = 'none';
                    }
                });
            }
            
            // Marcar todas como lidas
            if (markAllAsReadBtn) {
                markAllAsReadBtn.addEventListener('click', markAllAsRead);
            }
            
            // Limpar todas as notificações
            if (clearAllNotificationsBtn) {
                clearAllNotificationsBtn.addEventListener('click', clearAllNotifications);
            }
            
            // Carregar notificações periodicamente
            loadNotifications();
            setInterval(loadNotifications, 60000);
        }
        
        function loadNotifications() {
            fetch('/api/notifications')
                .then(response => {
                    if (!response.ok) throw new Error('Erro ao carregar notificações');
                    return response.json();
                })
                .then(data => {
                    updateNotificationCount(data.unreadCount || 0);
                    renderNotifications(data.notifications || []);
                })
                .catch(error => {
                    console.error('Erro ao carregar notificações:', error);
                    renderMockNotifications();
                });
        }
        
        function updateNotificationCount(count) {
            const notificationCount = document.querySelector('.notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count > 99 ? '99+' : count;
                    notificationCount.classList.add('show');
                } else {
                    notificationCount.classList.remove('show');
                }
            }
        }
        
        function renderNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');
            if (!notificationsList) return;
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="empty-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <p>Sem notificações no momento</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            notifications.forEach(notification => {
                const timeAgo = getTimeAgo(notification.createdAt);
                const iconClass = getNotificationIconClass(notification.type);
                const unreadClass = notification.read ? '' : 'unread';
                
                html += `
                    <div class="notification-item ${unreadClass}" data-id="${notification._id}">
                        <div class="notification-icon ${iconClass}">
                            <i class="${getNotificationIcon(notification.type)}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">${notification.title}</div>
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${timeAgo}</div>
                        </div>
                        ${!notification.read ? `
                            <div class="notification-actions">
                                <button class="notification-mark-read" title="Marcar como lida">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            notificationsList.innerHTML = html;
            
            // Adicionar eventos
            document.querySelectorAll('.notification-mark-read').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const notificationId = this.closest('.notification-item').dataset.id;
                    markAsRead(notificationId);
                });
            });
            
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', function() {
                    const notificationId = this.dataset.id;
                    openNotification(notificationId);
                });
            });
        }
        
        function renderMockNotifications() {
            const mockNotifications = [
                {
                    _id: '1',
                    title: 'Novo Staff Registado',
                    message: 'João Silva foi adicionado como membro da equipa de suporte.',
                    type: 'info',
                    read: false,
                    createdAt: new Date(Date.now() - 300000).toISOString()
                },
                {
                    _id: '2',
                    title: 'Acesso Suspeito',
                    message: 'Tentativa de login falhada da conta de administrador.',
                    type: 'warning',
                    read: true,
                    createdAt: new Date(Date.now() - 3600000).toISOString()
                },
                {
                    _id: '3',
                    title: 'Levantamento Aprovado',
                    message: 'Levantamento de €500 aprovado para o jogador Miguel Santos.',
                    type: 'success',
                    read: false,
                    createdAt: new Date(Date.now() - 7200000).toISOString()
                }
            ];
            
            const unreadCount = mockNotifications.filter(n => !n.read).length;
            updateNotificationCount(unreadCount);
            renderNotifications(mockNotifications);
        }
        
        function markAsRead(notificationId) {
            fetch(`/api/notifications/${notificationId}/read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    loadNotifications();
                }
            })
            .catch(error => {
                console.error('Erro ao marcar notificação como lida:', error);
            });
        }
        
        function markAllAsRead() {
            fetch('/api/notifications/read-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('Todas as notificações marcadas como lidas', 'success');
                    loadNotifications();
                } else {
                    showToast('Erro ao marcar notificações como lidas', 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao marcar todas como lidas:', error);
                showToast('Erro ao comunicar com o servidor', 'error');
            });
        }
        
        function clearAllNotifications() {
            if (confirm('Tem certeza que deseja limpar todas as notificações? As notificações lidas e com mais de 30 dias serão permanentemente eliminadas.')) {
                fetch('/api/notifications/clear-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ confirm: 'true' })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showToast(result.message, 'success');
                        loadNotifications();
                    } else {
                        showToast(result.error || 'Erro ao limpar notificações', 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro ao limpar notificações:', error);
                    showToast('Erro ao comunicar com o servidor', 'error');
                });
            }
        }
        
        function openNotification(notificationId) {
            console.log('Abrir notificação:', notificationId);
            markAsRead(notificationId);
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'warning': return 'fas fa-exclamation-triangle';
                case 'success': return 'fas fa-check-circle';
                case 'danger': return 'fas fa-exclamation-circle';
                case 'info': 
                default: return 'fas fa-info-circle';
            }
        }
        
        function getNotificationIconClass(type) {
            switch(type) {
                case 'warning': return 'warning';
                case 'success': return 'success';
                case 'danger': return 'danger';
                case 'info': 
                default: return 'info';
            }
        }
        
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Agora mesmo';
            if (diffMins < 60) return `Há ${diffMins} min`;
            if (diffHours < 24) return `Há ${diffHours} h`;
            if (diffDays < 7) return `Há ${diffDays} d`;
            return date.toLocaleDateString('pt-PT');
        }
        
        function initInternalEmailSystem() {
            const emailToggle = document.getElementById('emailToggle');
            const emailForm = document.getElementById('emailForm');
            const toggleIcon = document.getElementById('emailToggleIcon');
            
            if (emailToggle && emailForm) {
                emailToggle.addEventListener('click', function() {
                    emailForm.classList.toggle('active');
                    emailToggle.classList.toggle('active');
                    toggleIcon.classList.toggle('fa-chevron-down');
                    toggleIcon.classList.toggle('fa-chevron-up');
                });
            }
            
            // Sistema de envio de email INTERNO
            const sendEmailBtn = document.getElementById('sendInternalEmailBtn');
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            
            if (sendEmailBtn) {
                sendEmailBtn.addEventListener('click', async function() {
                    const subject = document.getElementById('emailSubject').value.trim();
                    const message = document.getElementById('emailMessage').value.trim();
                    const recipientType = document.getElementById('emailRecipients').value;
                    
                    if (!subject || !message) {
                        showToast('⚠️ Preencha o assunto e a mensagem!', 'warning');
                        return;
                    }
                    
                    // Mostrar loading
                    const originalText = sendEmailBtn.innerHTML;
                    sendEmailBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    sendEmailBtn.disabled = true;
                    
                    try {
                        // Enviar email interno via API
                        const response = await fetch('/api/email/send', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                subject: subject,
                                message: message,
                                recipients: recipientType,
                                clientMessageId: Date.now().toString()
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showToast('✅ Mensagem interna enviada!', 'success');
                            document.getElementById('emailSubject').value = '';
                            document.getElementById('emailMessage').value = '';
                            
                            // Fechar formulário
                            if (emailForm) {
                                emailForm.classList.remove('active');
                                emailToggle.classList.remove('active');
                                toggleIcon.classList.remove('fa-chevron-up');
                                toggleIcon.classList.add('fa-chevron-down');
                            }
                            
                            // Recarregar a página para atualizar a lista
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            showToast('❌ Erro: ' + (result.error || 'Falha ao enviar'), 'error');
                        }
                    } catch (error) {
                        showToast('❌ Erro de conexão!', 'error');
                        console.error('Erro:', error);
                    } finally {
                        // Restaurar botão
                        sendEmailBtn.innerHTML = originalText;
                        sendEmailBtn.disabled = false;
                    }
                });
            }
            
            if (saveDraftBtn) {
                saveDraftBtn.addEventListener('click', function() {
                    const subject = document.getElementById('emailSubject').value;
                    const message = document.getElementById('emailMessage').value;
                    const recipientType = document.getElementById('emailRecipients').value;
                    
                    if (subject || message) {
                        localStorage.setItem('internal_email_draft', JSON.stringify({
                            subject: subject,
                            message: message,
                            recipientType: recipientType,
                            savedAt: new Date().toISOString()
                        }));
                        showToast('📝 Rascunho guardado!', 'info');
                    }
                });
            }
            
            // Carregar rascunho
            loadInternalEmailDraft();
        }
        
        function loadInternalEmailDraft() {
            try {
                const draft = localStorage.getItem('internal_email_draft');
                if (draft) {
                    const data = JSON.parse(draft);
                    // Carregar se tiver menos de 24 horas
                    if (Date.now() - new Date(data.savedAt).getTime() < 86400000) {
                        document.getElementById('emailSubject').value = data.subject || '';
                        document.getElementById('emailMessage').value = data.message || '';
                        document.getElementById('emailRecipients').value = data.recipientType || 'all_staff';
                    }
                }
            } catch (e) {
                console.log('Erro ao carregar rascunho:', e);
            }
        }
        
        function setupAnimations() {
            // Animar cards ao carregar
            const cards = document.querySelectorAll('.overview-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100 * index);
            });
        }
        
        function startClock() {
            function updateTime() {
                const now = new Date();
                const timeElement = document.getElementById('serverTime');
                if (timeElement) {
                    timeElement.textContent = now.toLocaleTimeString('pt-PT');
                }
            }
            
            updateTime();
            setInterval(updateTime, 1000);
        }
        
        function showToast(message, type) {
            // Remover toast anterior se existir
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Criar novo toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                  type === 'error' ? 'exclamation-circle' : 
                                  type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Remover após 5 segundos
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }
        
        function handleAvatarError(imgElement, containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '<i class="fas fa-user-tie"></i>';
            }
        }
        
        // Auto-refresh dos dados a cada 30 segundos
        setInterval(() => {
            // Atualizar apenas os valores dos cards via API
            fetch('/api/dashboard/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.stats) {
                        // Atualizar valores dos cards
                        const pendingWithdrawalsEl = document.querySelector('.overview-card:nth-child(1) .overview-value');
                        const totalPlayersEl = document.querySelector('.overview-card:nth-child(2) .overview-value');
                        const onlinePlayersEl = document.querySelector('.overview-card:nth-child(2) div:nth-child(4)');
                        const openTicketsEl = document.querySelector('.overview-card:nth-child(3) .overview-value');
                        const recentEmailsEl = document.querySelector('.overview-card:nth-child(4) .overview-value');
                        
                        if (pendingWithdrawalsEl && pendingWithdrawalsEl.textContent !== '--') {
                            pendingWithdrawalsEl.textContent = data.stats.pendingWithdrawals || 0;
                        }
                        if (totalPlayersEl && totalPlayersEl.textContent !== '--') {
                            totalPlayersEl.textContent = data.stats.totalPlayers || 0;
                        }
                        if (onlinePlayersEl && onlinePlayersEl.textContent !== 'Sem permissão') {
                            onlinePlayersEl.textContent = (data.stats.onlinePlayers || 0) + ' online';
                        }
                        if (openTicketsEl && openTicketsEl.textContent !== '--') {
                            openTicketsEl.textContent = data.stats.openTickets || 0;
                        }
                        if (recentEmailsEl && recentEmailsEl.textContent !== '--') {
                            recentEmailsEl.textContent = data.stats.recentEmails || 0;
                        }
                    }
                })
                .catch(error => console.log('Erro ao atualizar stats:', error));
        }, 30000);
        
        // Fallback de segurança
        setTimeout(() => {
            const popup = document.getElementById('confidentialityModal');
            if (popup && popup.style.display === 'flex') {
                showDashboard();
            }
        }, 10000);
    </script>
</body>
</html>