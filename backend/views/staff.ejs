<!DOCTYPE html>
<html lang="pt">
<head>
<%
// ===== VARIÁVEIS SEGURAS =====
const safeUser = user || {
    id: 'unknown',
    name: 'Utilizador',
    email: '',
    role: 'viewer',
    photo: null,
    acceptedConfidentiality: false
};

const safeStats = stats || {
    total: 0,
    active: 0,
    admins: 0,
    support: 0,
    finance: 0,
    moderator: 0,
    viewer: 0
};

const safeStaffMembers = staffMembers || [];
const safeRoleOptions = roleOptions || [];
const safeCurrentPage = currentPage || 1;
const safeTotalPages = totalPages || 1;
const safeTotal = total || 0;
const safeSearch = search || '';
const safeRole = role || 'all';
const safeStatus = status || 'all';
const safeSort = sort || 'name';
const safeOrder = order || 'desc';

// Definir permissões conforme server.js
const isAdmin = safeUser.role === 'admin';
const isSupportManager = safeUser.role === 'support_manager';

// Função para verificar permissões
function hasPermission(permission) {
    if (isAdmin) return true;
    if (!safeUser.permissions) return false;
    return safeUser.permissions.includes(permission) || safeUser.permissions.includes('all');
}

// Permissões específicas para esta página
const canManageStaff = hasPermission('manage_staff');
const canViewStaff = hasPermission('view_staff');

// Role mapping para display
const roleLabels = {
    'admin': 'Administrador',
    'support_manager': 'Gestor de Suporte',
    'support': 'Suporte',
    'finance': 'Financeiro',
    'moderator': 'Moderador',
    'viewer': 'Visualizador'
};

// Role colors para badges
const roleColors = {
    'admin': { bg: 'rgba(212, 175, 55, 0.1)', color: '#D4AF37', border: 'rgba(212, 175, 55, 0.3)' },
    'support_manager': { bg: 'rgba(23, 162, 184, 0.1)', color: '#17a2b8', border: 'rgba(23, 162, 184, 0.3)' },
    'support': { bg: 'rgba(23, 162, 184, 0.1)', color: '#17a2b8', border: 'rgba(23, 162, 184, 0.3)' },
    'finance': { bg: 'rgba(40, 167, 69, 0.1)', color: '#28a745', border: 'rgba(40, 167, 69, 0.3)' },
    'moderator': { bg: 'rgba(255, 193, 7, 0.1)', color: '#ffc107', border: 'rgba(255, 193, 7, 0.3)' },
    'viewer': { bg: 'rgba(108, 117, 125, 0.1)', color: '#6c757d', border: 'rgba(108, 117, 125, 0.3)' }
};

// Preparar notificações
let safeNotifications = [];
let safeUnreadCount = 0;

if (notifications && notifications.notifications) {
    safeNotifications = notifications.notifications;
}
if (notifications && notifications.unreadCount !== undefined) {
    safeUnreadCount = notifications.unreadCount;
}
%>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof title !== 'undefined' ? title : 'VelvetWin | Gestão de Staff' %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/staff.css">
    <style>
        /* Estilos adicionais para notificações */
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item.unread {
            background-color: rgba(23, 162, 184, 0.05);
            border-left: 3px solid var(--accent-primary);
        }

        .notification-item:hover {
            background-color: var(--hover-bg);
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 14px;
        }

        .notification-message {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 5px;
        }

        .notification-time {
            color: var(--text-tertiary);
            font-size: 11px;
            text-align: right;
        }

        .notification-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 8px;
        }

        .notification-type.success { background: rgba(40, 167, 69, 0.1); color: #28a745; }
        .notification-type.warning { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
        .notification-type.danger { background: rgba(220, 53, 69, 0.1); color: #dc3545; }
        .notification-type.info { background: rgba(23, 162, 184, 0.1); color: #17a2b8; }
        .notification-type.system { background: rgba(108, 117, 125, 0.1); color: #6c757d; }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast.info {
            border-left: 4px solid var(--accent-primary);
        }

        .toast i {
            font-size: 20px;
        }

        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
        .toast.info i { color: var(--accent-primary); }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Estilos para modais */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Estilos para formulários */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        /* Estilos para botões de ação */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .btn-action {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--text-secondary);
        }

        .btn-action:hover {
            background: var(--hover-bg);
        }

        .btn-action-edit:hover {
            color: var(--accent-primary);
            background: rgba(212, 175, 55, 0.1);
        }

        .btn-action-activate:hover {
            color: var(--success);
            background: rgba(40, 167, 69, 0.1);
        }

        .btn-action-deactivate:hover {
            color: var(--warning);
            background: rgba(255, 193, 7, 0.1);
        }

        .btn-action-delete:hover {
            color: var(--danger);
            background: rgba(220, 53, 69, 0.1);
        }

        /* Estilos para badges */
        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .status-inactive {
            background: rgba(108, 117, 125, 0.1);
            color: var(--text-secondary);
            border: 1px solid rgba(108, 117, 125, 0.3);
        }

        /* Ajustes para responsividade */
        @media (max-width: 1024px) {
            .controls-bar .filter-group {
                flex-wrap: wrap;
            }
            
            .filter-select {
                min-width: 150px;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .btn-action {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-bar {
                flex-direction: column;
                gap: 15px;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .filter-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="app-container" id="mainApp">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h2>VelvetWin <span class="b7uno-badge">ADMIN</span></h2>
                <div class="user-mini-info">
                    <div class="user-mini-avatar" id="sidebarAvatar">
                        <% if (safeUser.photo) { %>
                            <img src="/profile-photos/<%= safeUser.photo %>?t=<%= Date.now() %>" 
                                 alt="<%= safeUser.name %>"
                                 onerror="handleAvatarError(this, 'sidebarAvatar')">
                        <% } else { %>
                            <i class="fas fa-user-tie"></i>
                        <% } %>
                    </div>
                    <div class="user-mini-details">
                        <span id="sidebarStaffName"><%= safeUser.name %></span>
                        <small id="sidebarStaffRole"><%= safeUser.role.toUpperCase() %></small>
                    </div>
                </div>
            </div>
            
            <ul class="menu">
                <li><a href="/dashboard">
                    <i class="fas fa-tachometer-alt"></i><span> Dashboard</span>
                </a></li>
                
                <% if (hasPermission('view_players')) { %>
                <li><a href="/players">
                    <i class="fas fa-users"></i><span> Jogadores</span>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão">
                    <i class="fas fa-users"></i><span> Jogadores</span>
                </a></li>
                <% } %>
                
                <% if (hasPermission('view_withdrawals')) { %>
                <li><a href="/withdrawals">
                    <i class="fas fa-money-bill-wave"></i><span> Levantamentos</span>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão">
                    <i class="fas fa-money-bill-wave"></i><span> Levantamentos</span>
                </a></li>
                <% } %>
                
                <% if (hasPermission('view_payments')) { %>
                <li><a href="/payments">
                    <i class="fas fa-credit-card"></i><span> Pagamentos</span>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão">
                    <i class="fas fa-credit-card"></i><span> Pagamentos</span>
                </a></li>
                <% } %>
                
                <% if (hasPermission('view_support')) { %>
                <li><a href="/support">
                    <i class="fas fa-headset"></i><span> Suporte</span>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão">
                    <i class="fas fa-headset"></i><span> Suporte</span>
                </a></li>
                <% } %>
                
                <li><a href="/staff" class="active">
                    <i class="fas fa-user-tie"></i><span> Staff</span>
                </a></li>
                
                <% if (hasPermission('view_email')) { %>
                <li><a href="/email">
                    <i class="fas fa-envelope"></i><span> Email</span>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão">
                    <i class="fas fa-envelope"></i><span> Email</span>
                </a></li>
                <% } %>
                
                <% if (hasPermission('view_logs')) { %>
                <li><a href="/logs">
                    <i class="fas fa-history"></i><span> Logs</span>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão">
                    <i class="fas fa-history"></i><span> Logs</span>
                </a></li>
                <% } %>
                
                <% if (hasPermission('view_settings')) { %>
                <li><a href="/settings">
                    <i class="fas fa-cog"></i><span> Definições</span>
                </a></li>
                <% } else { %>
                <li><a href="#" class="menu-item-disabled" title="Sem permissão">
                    <i class="fas fa-cog"></i><span> Definições</span>
                </a></li>
                <% } %>
                
                <!-- Tema -->
                <li>
                    <div class="theme-toggle" id="sidebarThemeToggle">
                        <input type="checkbox" id="sidebarThemeCheckbox">
                        <div class="toggle-switch"></div>
                        <span class="theme-label" id="sidebarThemeLabel">Modo Escuro</span>
                    </div>
                </li>
                
                <!-- Logout -->
                <li>
                    <a href="#" id="logoutBtnSidebar">
                        <i class="fas fa-sign-out-alt"></i><span> Logout</span>
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-footer">
                <div class="system-status">
                    <div class="status-indicator"></div>
                    <span>Sistema Online</span>
                </div>
                <div class="server-time" id="serverTime">--:--:--</div>
            </div>
        </div>

        <!-- Overlay para mobile -->
        <div class="overlay" id="overlay"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Topbar -->
            <div class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="breadcrumb" id="breadcrumb">
                        Staff / Gestão de Equipa
                    </div>
                </div>
                
                <div class="topbar-right">
                    <!-- Theme Toggle -->
                    <div class="theme-toggle" id="topbarThemeToggle">
                        <input type="checkbox" id="topbarThemeCheckbox">
                        <div class="toggle-switch"></div>
                        <span class="theme-label" id="topbarThemeLabel">Modo Escuro</span>
                    </div>
                    
                    <!-- Notificações -->
                    <div class="notifications">
                        <button class="notification-btn" id="notificationBtn">
                            <i class="fas fa-bell"></i>
                            <% if (safeUnreadCount > 0) { %>
                                <span class="notification-count show"><%= safeUnreadCount > 9 ? '9+' : safeUnreadCount %></span>
                            <% } %>
                        </button>
                        
                        <!-- Modal de Notificações -->
                        <div class="notifications-modal" id="notificationsModal">
                            <div class="notifications-header">
                                <h3><i class="fas fa-bell"></i> Notificações</h3>
                                <% if (safeUnreadCount > 0) { %>
                                    <button class="clear-notifications" id="markAllReadBtn">
                                        <i class="fas fa-check-double"></i> Marcar todas como lidas
                                    </button>
                                <% } %>
                            </div>
                            <div class="notifications-body" id="notificationsBody">
                                <% if (safeNotifications && safeNotifications.length > 0) { %>
                                    <% safeNotifications.forEach(notification => { %>
                                        <div class="notification-item <%= notification.read ? '' : 'unread' %>" 
                                             data-id="<%= notification.id || '' %>">
                                            <div class="notification-title">
                                                <span class="notification-type <%= notification.type || 'info' %>">
                                                    <%= notification.type || 'info' %>
                                                </span>
                                                <%= notification.title || 'Notificação' %>
                                            </div>
                                            <div class="notification-message"><%= notification.message || '' %></div>
                                            <div class="notification-time">
                                                <%= notification.createdAt ? new Date(notification.createdAt).toLocaleString('pt-PT') : '' %>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <div style="padding: 40px 20px; text-align: center; color: var(--text-secondary);">
                                        <i class="fas fa-bell-slash" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
                                        <p>Nenhuma notificação</p>
                                    </div>
                                <% } %>
                            </div>
                            <div class="notifications-footer">
                                <a href="#" id="clearAllNotifications" style="color: var(--danger); font-size: 14px; text-decoration: none; margin-right: 15px;">
                                    <i class="fas fa-trash-alt"></i> Limpar todas
                                </a>
                                <a href="#" id="loadMoreNotifications" style="color: var(--accent-primary); font-size: 14px; text-decoration: none;">
                                    Ver mais
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Profile -->
                    <div class="user-profile" id="userProfile">
                        <div class="user-avatar" id="userAvatar">
                            <% if (safeUser.photo) { %>
                                <img src="/profile-photos/<%= safeUser.photo %>?t=<%= Date.now() %>" 
                                     alt="<%= safeUser.name %>" 
                                     id="userAvatarImage"
                                     onerror="handleAvatarError(this, 'userAvatar')">
                            <% } else { %>
                                <span id="userInitials"><%= safeUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) %></span>
                            <% } %>
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="topbarStaffName"><%= safeUser.name %></div>
                            <div class="user-role" id="topbarStaffRole"><%= safeUser.role.toUpperCase() %></div>
                        </div>
                        <i class="fas fa-chevron-down" style="font-size: 12px; color: var(--text-secondary);"></i>
                    </div>
                </div>
            </div>

            <!-- User Dropdown -->
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-header">
                    <div class="user-info">
                        <div class="user-avatar" id="dropdownAvatar">
                            <% if (safeUser.photo) { %>
                                <img src="/profile-photos/<%= safeUser.photo %>?t=<%= Date.now() %>" 
                                     alt="<%= safeUser.name %>" 
                                     id="dropdownAvatarImage"
                                     onerror="handleAvatarError(this, 'dropdownAvatar')">
                            <% } else { %>
                                <span id="dropdownInitials"><%= safeUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) %></span>
                            <% } %>
                        </div>
                        <div>
                            <div class="user-name" id="dropdownUserName"><%= safeUser.name %></div>
                            <div class="user-role"><%= safeUser.role.toUpperCase() %></div>
                            <div class="user-email" style="font-size: 11px; color: var(--text-secondary);">
                                <%= safeUser.email %>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dropdown-body">
                    <a href="/profile" class="dropdown-item" id="myProfileLink">
                        <i class="fas fa-user"></i>
                        <span>Meu Perfil</span>
                    </a>
                    <% if (hasPermission('view_settings')) { %>
                        <a href="/settings" class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            <span>Definições</span>
                        </a>
                    <% } %>
                    <% if (hasPermission('view_logs')) { %>
                        <a href="/logs" class="dropdown-item">
                            <i class="fas fa-history"></i>
                            <span>Histórico</span>
                        </a>
                    <% } %>
                </div>
                <div class="dropdown-footer">
                    <button class="btn btn-secondary" id="logoutBtnDropdown">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Page Header -->
                <div class="page-header">
                    <h1>
                        <i class="fas fa-user-tie"></i> Gestão de Staff
                        <% if (canManageStaff) { %>
                            <button class="btn btn-primary" id="createStaffBtn">
                                <i class="fas fa-user-plus"></i> Novo Staff
                            </button>
                        <% } %>
                    </h1>
                    <p>
                        Gerencie os membros da sua equipe, atribua permissões e monitore atividades.
                        <% if (isAdmin) { %>
                            Como administrador, tem acesso total a todas as funcionalidades.
                        <% } else if (isSupportManager) { %>
                            Como gestor de suporte, pode criar e editar membros da equipa.
                        <% } else { %>
                            Você tem permissão apenas de visualização.
                        <% } %>
                    </p>
                </div>
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value"><%= safeStats.total %></div>
                        <div class="stat-label">Total Staff</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="stat-value"><%= safeStats.active %></div>
                        <div class="stat-label">Ativos</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="stat-value"><%= safeStats.admins %></div>
                        <div class="stat-label">Administradores</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div class="stat-value"><%= safeStats.support %></div>
                        <div class="stat-label">Equipa Suporte</div>
                    </div>
                </div>
                
                <!-- Controls Bar -->
                <div class="controls-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" 
                               placeholder="Pesquisar por nome, email ou departamento..." 
                               value="<%= safeSearch %>">
                    </div>
                    
                    <div class="filter-group">
                        <select id="roleFilter" class="filter-select">
                            <option value="all" <%= safeRole === 'all' ? 'selected' : '' %>>Todos os Cargos</option>
                            <% safeRoleOptions.forEach(option => { %>
                                <option value="<%= option.value %>" 
                                        <%= safeRole === option.value ? 'selected' : '' %>>
                                    <%= option.label %>
                                </option>
                            <% }) %>
                        </select>
                        
                        <select id="statusFilter" class="filter-select">
                            <option value="all" <%= safeStatus === 'all' ? 'selected' : '' %>>Todos os Estados</option>
                            <option value="active" <%= safeStatus === 'active' ? 'selected' : '' %>>Ativos</option>
                            <option value="inactive" <%= safeStatus === 'inactive' ? 'selected' : '' %>>Inativos</option>
                        </select>
                        
                        <select id="sortSelect" class="filter-select">
                            <option value="name" <%= safeSort === 'name' ? 'selected' : '' %>>Ordenar por Nome</option>
                            <option value="createdAt" <%= safeSort === 'createdAt' ? 'selected' : '' %>>Ordenar por Data</option>
                            <option value="lastLogin" <%= safeSort === 'lastLogin' ? 'selected' : '' %>>Ordenar por Último Login</option>
                        </select>
                        
                        <select id="orderSelect" class="filter-select">
                            <option value="desc" <%= safeOrder === 'desc' ? 'selected' : '' %>>Descendente</option>
                            <option value="asc" <%= safeOrder === 'asc' ? 'selected' : '' %>>Ascendente</option>
                        </select>
                        
                        <button class="btn btn-secondary" id="resetFiltersBtn">
                            <i class="fas fa-redo"></i> Limpar
                        </button>
                    </div>
                </div>
                
                <!-- Staff Table -->
                <div class="table-container">
                    <% if (safeStaffMembers && safeStaffMembers.length > 0) { %>
                        <table>
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th>Contacto</th>
                                    <th>Cargo</th>
                                    <th>Departamento</th>
                                    <th>Estado</th>
                                    <th>Último Login</th>
                                    <th>Registado</th>
                                    <% if (canManageStaff) { %>
                                        <th>Ações</th>
                                    <% } %>
                                </tr>
                            </thead>
                            <tbody>
                                <% safeStaffMembers.forEach(staff => { 
                                    const isCurrentUser = staff.id === safeUser.id;
                                    const roleColor = roleColors[staff.role] || roleColors.viewer;
                                %>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div class="staff-avatar">
                                                    <% if (staff.photo) { %>
                                                        <img src="/profile-photos/<%= staff.photo %>?t=<%= Date.now() %>" 
                                                             alt="<%= staff.name %>"
                                                             onerror="handleTableAvatarError(this)">
                                                    <% } else { %>
                                                        <i class="fas fa-user-tie"></i>
                                                    <% } %>
                                                </div>
                                                <div>
                                                    <strong><%= staff.name %></strong>
                                                    <% if (isCurrentUser) { %>
                                                        <span style="font-size: 11px; color: var(--accent-primary); margin-left: 5px;">(Você)</span>
                                                    <% } %>
                                                    <% if (staff.isOnline) { %>
                                                        <div style="font-size: 11px; color: var(--success); display: flex; align-items: center; gap: 4px;">
                                                            <div style="width: 6px; height: 6px; background: var(--success); border-radius: 50%;"></div>
                                                            Online
                                                        </div>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div><%= staff.email %></div>
                                            <% if (staff.department) { %>
                                                <div style="font-size: 12px; color: var(--text-secondary);"><%= staff.department %></div>
                                            <% } %>
                                        </td>
                                        <td>
                                            <span class="role-badge" style="
                                                background: <%= roleColor.bg %>;
                                                color: <%= roleColor.color %>;
                                                border: 1px solid <%= roleColor.border %>;
                                            ">
                                                <%= roleLabels[staff.role] || staff.role %>
                                            </span>
                                        </td>
                                        <td><%= staff.department || 'N/A' %></td>
                                        <td>
                                            <span class="status-badge <%= staff.isActive ? 'status-active' : 'status-inactive' %>">
                                                <%= staff.isActive ? 'Ativo' : 'Inativo' %>
                                            </span>
                                        </td>
                                        <td>
                                            <% if (staff.lastLogin) { %>
                                                <%= new Date(staff.lastLogin).toLocaleDateString('pt-PT') %>
                                                <br>
                                                <small style="color: var(--text-secondary);">
                                                    <%= new Date(staff.lastLogin).toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit'}) %>
                                                </small>
                                            <% } else { %>
                                                <span style="color: var(--text-secondary);">Nunca</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <%= new Date(staff.createdAt).toLocaleDateString('pt-PT') %>
                                            <br>
                                            <small style="color: var(--text-secondary);">
                                                <%= new Date(staff.createdAt).toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit'}) %>
                                            </small>
                                        </td>
                                        <% if (canManageStaff) { %>
                                            <td>
                                                <div class="action-buttons">
                                                    <% if (!isCurrentUser) { %>
                                                        <!-- Editar -->
                                                        <button class="btn-action btn-action-edit" 
                                                                title="Editar"
                                                                data-staff-id="<%= staff.id %>"
                                                                data-staff-name="<%= staff.name %>"
                                                                data-staff-email="<%= staff.email %>"
                                                                data-staff-role="<%= staff.role %>"
                                                                data-staff-department="<%= staff.department %>"
                                                                data-staff-active="<%= staff.isActive %>">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        
                                                        <!-- Ativar/Desativar -->
                                                        <% if (staff.isActive) { %>
                                                            <button class="btn-action btn-action-deactivate" 
                                                                    title="Desativar Conta"
                                                                    data-staff-id="<%= staff.id %>"
                                                                    data-staff-name="<%= staff.name %>">
                                                                <i class="fas fa-user-slash"></i>
                                                            </button>
                                                        <% } else { %>
                                                            <button class="btn-action btn-action-activate" 
                                                                    title="Ativar Conta"
                                                                    data-staff-id="<%= staff.id %>"
                                                                    data-staff-name="<%= staff.name %>">
                                                                <i class="fas fa-user-check"></i>
                                                            </button>
                                                        <% } %>
                                                        
                                                        <!-- Eliminar -->
                                                        <button class="btn-action btn-action-delete" 
                                                                title="Eliminar"
                                                                data-staff-id="<%= staff.id %>"
                                                                data-staff-name="<%= staff.name %>">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    <% } else { %>
                                                        <span style="color: var(--text-secondary); font-size: 12px;">Sua conta</span>
                                                    <% } %>
                                                </div>
                                            </td>
                                        <% } %>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-user-friends" style="font-size: 64px; color: var(--text-secondary); margin-bottom: 20px; opacity: 0.3;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 10px;">Nenhum staff encontrado</h3>
                            <p style="color: var(--text-tertiary); margin-bottom: 30px;">
                                <% if (safeSearch || safeRole !== 'all' || safeStatus !== 'all') { %>
                                    Tente alterar os filtros de pesquisa.
                                <% } else if (canManageStaff) { %>
                                    Ainda não existem membros na equipa. Crie o primeiro staff!
                                <% } else { %>
                                    Não tem membros na equipa disponíveis para visualização.
                                <% } %>
                            </p>
                            <% if (canManageStaff && !safeSearch && safeRole === 'all' && safeStatus === 'all') { %>
                                <button class="btn btn-primary" id="createFirstStaffBtn">
                                    <i class="fas fa-user-plus"></i> Criar Primeiro Staff
                                </button>
                            <% } %>
                        </div>
                    <% } %>
                </div>
                
                <!-- Pagination -->
                <% if (safeTotalPages > 1) { %>
                    <div class="pagination">
                        <button class="pagination-btn" id="firstPage" <%= safeCurrentPage === 1 ? 'disabled' : '' %>>
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="pagination-btn" id="prevPage" <%= safeCurrentPage === 1 ? 'disabled' : '' %>>
                            <i class="fas fa-angle-left"></i>
                        </button>
                        
                        <% 
                            let startPage = Math.max(1, safeCurrentPage - 2);
                            let endPage = Math.min(safeTotalPages, startPage + 4);
                            if (endPage - startPage < 4) {
                                startPage = Math.max(1, endPage - 4);
                            }
                            
                            for (let i = startPage; i <= endPage; i++) { 
                        %>
                            <button class="pagination-btn <%= i === safeCurrentPage ? 'active' : '' %>" 
                                    data-page="<%= i %>">
                                <%= i %>
                            </button>
                        <% } %>
                        
                        <button class="pagination-btn" id="nextPage" <%= safeCurrentPage === safeTotalPages ? 'disabled' : '' %>>
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="pagination-btn" id="lastPage" <%= safeCurrentPage === safeTotalPages ? 'disabled' : '' %>>
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                <% } %>
                
                <!-- Info Footer -->
                <div style="margin-top: 40px; padding: 25px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px;">
                    <h4 style="margin-bottom: 15px; color: var(--accent-primary); display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-info-circle"></i> Informações sobre Permissões
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; font-size: 14px;">
                        <div style="background: rgba(212, 175, 55, 0.05); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                            <strong style="color: var(--accent-primary);">Administrador:</strong>
                            <p style="color: var(--text-secondary); margin-top: 8px; font-size: 13px;">
                                Acesso completo a todas as funcionalidades do sistema.
                            </p>
                        </div>
                        <div style="background: rgba(23, 162, 184, 0.05); padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                            <strong style="color: #17a2b8;">Gestor de Suporte:</strong>
                            <p style="color: var(--text-secondary); margin-top: 8px; font-size: 13px;">
                                Pode gerir staff, tickets, suporte e visualizar todas as áreas.
                            </p>
                        </div>
                        <div style="background: rgba(40, 167, 69, 0.05); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success);">
                            <strong style="color: var(--success);">Financeiro:</strong>
                            <p style="color: var(--text-secondary); margin-top: 8px; font-size: 13px;">
                                Acesso a jogadores, pagamentos, levantamentos e dashboard financeiro.
                            </p>
                        </div>
                        <div style="background: rgba(255, 193, 7, 0.05); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                            <strong style="color: var(--warning);">Moderador:</strong>
                            <p style="color: var(--text-secondary); margin-top: 8px; font-size: 13px;">
                                Acesso a jogadores, suporte e dashboard de monitorização.
                            </p>
                        </div>
                    </div>
                    
                    <% if (canManageStaff) { %>
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <h5 style="margin-bottom: 15px; color: var(--text-secondary); display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-cog"></i> Ações Disponíveis
                        </h5>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="btn-action btn-action-edit" style="pointer-events: none; cursor: default;">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Editar Staff</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="btn-action btn-action-activate" style="pointer-events: none; cursor: default;">
                                    <i class="fas fa-user-check"></i>
                                </div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Ativar Conta</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="btn-action btn-action-deactivate" style="pointer-events: none; cursor: default;">
                                    <i class="fas fa-user-slash"></i>
                                </div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Desativar Conta</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="btn-action btn-action-delete" style="pointer-events: none; cursor: default;">
                                    <i class="fas fa-trash-alt"></i>
                                </div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Eliminar Staff</span>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Criar/Editar Staff -->
    <div class="modal" id="staffModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> <span id="modalTitle">Novo Staff</span></h3>
                <button class="modal-close" id="staffModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId" name="id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name"><i class="fas fa-user"></i> Nome Completo *</label>
                            <input type="text" id="name" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="email"><i class="fas fa-envelope"></i> Email *</label>
                            <input type="email" id="email" name="email" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="role"><i class="fas fa-user-tag"></i> Cargo *</label>
                            <select id="role" name="role" class="form-control" required>
                                <option value="">Selecione um cargo</option>
                                <option value="admin">Administrador</option>
                                <option value="support_manager">Gestor de Suporte</option>
                                <option value="support">Suporte</option>
                                <option value="finance">Financeiro</option>
                                <option value="moderator">Moderador</option>
                                <option value="viewer">Visualizador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="department"><i class="fas fa-building"></i> Departamento</label>
                            <input type="text" id="department" name="department" class="form-control" value="Staff">
                        </div>
                    </div>
                    
                    <div class="form-group" id="passwordGroup">
                        <label for="password"><i class="fas fa-lock"></i> Password *</label>
                        <input type="password" id="password" name="password" class="form-control" required>
                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 5px; display: block;">
                            Mínimo 8 caracteres
                        </small>
                    </div>
                    
                    <div class="form-group" id="confirmPasswordGroup">
                        <label for="confirmPassword"><i class="fas fa-lock"></i> Confirmar Password *</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="isActive" name="isActive" checked style="width: auto;">
                            <label for="isActive" style="margin-bottom: 0; font-weight: normal; cursor: pointer;">Conta ativa</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="staffModalCancel">Cancelar</button>
                <button type="button" class="btn btn-primary" id="staffModalSave">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Ativar/Desativar -->
    <div class="modal" id="activateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-check" id="activateIcon"></i> <span id="activateTitle">Ativar Conta</span></h3>
                <button class="modal-close" id="activateModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p id="activateMessage">Tem certeza que deseja ativar esta conta?</p>
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 10px;">
                    <span id="activateDetails">O utilizador poderá voltar a fazer login no sistema.</span>
                </p>
                <input type="hidden" id="activateStaffId">
                <input type="hidden" id="activateAction">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="activateModalCancel">Cancelar</button>
                <button type="button" class="btn btn-primary" id="activateModalConfirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Eliminar -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> <span id="deleteTitle">Eliminar Staff</span></h3>
                <button class="modal-close" id="deleteModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Tem certeza que deseja eliminar este membro do staff?</p>
                <p style="color: var(--danger); font-size: 14px; margin-top: 10px; font-weight: bold;">
                    ⚠️ ATENÇÃO: Esta ação é irreversível!
                </p>
                <div style="background: var(--danger-light); padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid var(--danger);">
                    <p style="font-size: 13px; color: var(--text-primary); margin-bottom: 5px;">
                        <i class="fas fa-exclamation-circle"></i> <strong>Consequências:</strong>
                    </p>
                    <ul style="font-size: 12px; color: var(--text-secondary); padding-left: 20px;">
                        <li>A conta será marcada como inativa</li>
                        <li>O utilizador não poderá mais fazer login</li>
                        <li>Os dados serão mantidos para auditoria</li>
                        <li>Esta ação é registrada no sistema</li>
                    </ul>
                </div>
                <input type="hidden" id="deleteStaffId">
                <input type="hidden" id="deleteStaffName">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="deleteModalCancel">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteModalConfirm">
                    <i class="fas fa-trash-alt"></i> Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎰 VelvetWin Staff Management - Carregado');
            
            // Inicializar tema
            initTheme();
            
            // Configurar eventos
            setupEvents();
            
            // Iniciar relógio
            startClock();
            
            // Carregar notificações dinâmicas
            loadNotifications();
        });
        
        function initTheme() {
            const savedTheme = localStorage.getItem('velvetwin-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Atualizar checkboxes do tema
            const isDark = savedTheme === 'dark';
            document.querySelectorAll('.theme-toggle input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = isDark;
            });
            
            // Atualizar labels
            document.querySelectorAll('#sidebarThemeLabel, #topbarThemeLabel').forEach(label => {
                label.textContent = isDark ? 'Modo Escuro' : 'Modo Claro';
            });
        }
        
        function setupEvents() {
            // Alternar sidebar
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                });
            }
            
            if (overlay) {
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            }
            
            // Alternar tema
            const themeToggles = document.querySelectorAll('.theme-toggle');
            themeToggles.forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox') return;
                    const checkbox = toggle.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    const isDark = checkbox.checked;
                    const theme = isDark ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('velvetwin-theme', theme);
                    
                    // Atualizar labels
                    document.querySelectorAll('#sidebarThemeLabel, #topbarThemeLabel').forEach(label => {
                        label.textContent = isDark ? 'Modo Escuro' : 'Modo Claro';
                    });
                });
            });
            
            // User dropdown
            const userProfile = document.getElementById('userProfile');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userProfile) {
                userProfile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                });
            }
            
            // Notificações dropdown
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationsModal = document.getElementById('notificationsModal');
            
            if (notificationBtn && notificationsModal) {
                notificationBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationsModal.style.display = notificationsModal.style.display === 'block' ? 'none' : 'block';
                });
            }
            
            // Fechar dropdowns ao clicar fora
            document.addEventListener('click', (e) => {
                // Fechar user dropdown
                if (userDropdown && !userProfile.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.style.display = 'none';
                }
                
                // Fechar notificações dropdown
                if (notificationsModal && !notificationBtn.contains(e.target) && !notificationsModal.contains(e.target)) {
                    notificationsModal.style.display = 'none';
                }
            });
            
            // Marcar notificações como lidas
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
            }
            
            // Limpar todas as notificações
            const clearAllNotificationsBtn = document.getElementById('clearAllNotifications');
            if (clearAllNotificationsBtn) {
                clearAllNotificationsBtn.addEventListener('click', clearAllNotifications);
            }
            
            // Logout buttons
            const logoutBtns = [document.getElementById('logoutBtnSidebar'), 
                               document.getElementById('logoutBtnDropdown')];
            
            logoutBtns.forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (confirm('Tem certeza que deseja sair?')) {
                            window.location.href = '/logout';
                        }
                    });
                }
            });
            
            // Filtros de pesquisa
            const searchInput = document.getElementById('searchInput');
            const roleFilter = document.getElementById('roleFilter');
            const statusFilter = document.getElementById('statusFilter');
            const sortSelect = document.getElementById('sortSelect');
            const orderSelect = document.getElementById('orderSelect');
            const resetFiltersBtn = document.getElementById('resetFiltersBtn');
            
            // Debounce para pesquisa
            let searchTimeout;
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        applyFilters();
                    }, 500);
                });
            }
            
            // Eventos para outros filtros
            [roleFilter, statusFilter, sortSelect, orderSelect].forEach(filter => {
                if (filter) {
                    filter.addEventListener('change', applyFilters);
                }
            });
            
            // Reset filters
            if (resetFiltersBtn) {
                resetFiltersBtn.addEventListener('click', () => {
                    if (searchInput) searchInput.value = '';
                    if (roleFilter) roleFilter.value = 'all';
                    if (statusFilter) statusFilter.value = 'all';
                    if (sortSelect) sortSelect.value = 'name';
                    if (orderSelect) orderSelect.value = 'desc';
                    applyFilters();
                });
            }
            
            // Botões de criar staff
            const createStaffBtns = [document.getElementById('createStaffBtn'), 
                                    document.getElementById('createFirstStaffBtn')];
            
            createStaffBtns.forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        openCreateModal();
                    });
                }
            });
            
            // Botões de edição na tabela
            document.querySelectorAll('.btn-action-edit').forEach(btn => {
                btn.addEventListener('click', () => {
                    const staffId = btn.getAttribute('data-staff-id');
                    const staffName = btn.getAttribute('data-staff-name');
                    const staffEmail = btn.getAttribute('data-staff-email');
                    const staffRole = btn.getAttribute('data-staff-role');
                    const staffDepartment = btn.getAttribute('data-staff-department');
                    const staffActive = btn.getAttribute('data-staff-active') === 'true';
                    
                    openEditModal(staffId, staffName, staffEmail, staffRole, staffDepartment, staffActive);
                });
            });
            
            // Botões de ativar/desativar
            document.querySelectorAll('.btn-action-activate, .btn-action-deactivate').forEach(btn => {
                btn.addEventListener('click', () => {
                    const staffId = btn.getAttribute('data-staff-id');
                    const staffName = btn.getAttribute('data-staff-name');
                    const isActivate = btn.classList.contains('btn-action-activate');
                    
                    openActivateModal(staffId, staffName, isActivate);
                });
            });
            
            // Botões de eliminar
            document.querySelectorAll('.btn-action-delete').forEach(btn => {
                btn.addEventListener('click', () => {
                    const staffId = btn.getAttribute('data-staff-id');
                    const staffName = btn.getAttribute('data-staff-name');
                    
                    openDeleteModal(staffId, staffName);
                });
            });
            
            // Paginação
            document.querySelectorAll('.pagination-btn[data-page]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.getAttribute('data-page');
                    goToPage(page);
                });
            });
            
            // Primeira página
            const firstPageBtn = document.getElementById('firstPage');
            if (firstPageBtn) {
                firstPageBtn.addEventListener('click', () => {
                    goToPage(1);
                });
            }
            
            // Página anterior
            const prevPageBtn = document.getElementById('prevPage');
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    const currentPage = <%= safeCurrentPage %>;
                    goToPage(currentPage - 1);
                });
            }
            
            // Próxima página
            const nextPageBtn = document.getElementById('nextPage');
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    const currentPage = <%= safeCurrentPage %>;
                    goToPage(currentPage + 1);
                });
            }
            
            // Última página
            const lastPageBtn = document.getElementById('lastPage');
            if (lastPageBtn) {
                lastPageBtn.addEventListener('click', () => {
                    const totalPages = <%= safeTotalPages %>;
                    goToPage(totalPages);
                });
            }
            
            // Modais
            setupModalEvents();
        }
        
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const result = await response.json();
                
                if (result.success) {
                    updateNotificationsUI(result.notifications, result.unreadCount);
                }
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
            }
        }
        
        async function markAllNotificationsAsRead() {
            try {
                const response = await fetch('/api/notifications/mark-all-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Atualizar UI
                    document.querySelectorAll('.notification-item.unread').forEach(item => {
                        item.classList.remove('unread');
                    });
                    
                    // Atualizar contador
                    updateNotificationCount(0);
                    
                    showToast('Todas as notificações marcadas como lidas', 'success');
                }
            } catch (error) {
                console.error('Erro ao marcar notificações como lidas:', error);
                showToast('Erro ao marcar notificações como lidas', 'error');
            }
        }
        
        async function clearAllNotifications() {
            if (!confirm('Tem certeza que deseja limpar todas as notificações?\nEsta ação não pode ser desfeita.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/notifications/clear-all', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ confirm: 'true' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Limpar notificações na UI
                    const notificationsBody = document.getElementById('notificationsBody');
                    if (notificationsBody) {
                        notificationsBody.innerHTML = `
                            <div style="padding: 40px 20px; text-align: center; color: var(--text-secondary);">
                                <i class="fas fa-bell-slash" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
                                <p>Nenhuma notificação</p>
                            </div>
                        `;
                    }
                    
                    // Atualizar contador
                    updateNotificationCount(0);
                    
                    showToast(`${result.deletedCount} notificações eliminadas`, 'success');
                } else {
                    showToast(result.error || 'Erro ao limpar notificações', 'error');
                }
            } catch (error) {
                console.error('Erro ao limpar notificações:', error);
                showToast('Erro ao limpar notificações', 'error');
            }
        }
        
        function updateNotificationsUI(notifications, unreadCount) {
            const notificationsBody = document.getElementById('notificationsBody');
            if (!notificationsBody) return;
            
            if (notifications && notifications.length > 0) {
                let notificationsHTML = '';
                
                notifications.forEach(notification => {
                    const typeClass = notification.type || 'info';
                    const isRead = notification.read || false;
                    
                    notificationsHTML += `
                        <div class="notification-item ${isRead ? '' : 'unread'}" 
                             data-id="${notification.id || ''}">
                            <div class="notification-title">
                                <span class="notification-type ${typeClass}">
                                    ${typeClass}
                                </span>
                                ${notification.title || 'Notificação'}
                            </div>
                            <div class="notification-message">${notification.message || ''}</div>
                            <div class="notification-time">
                                ${notification.createdAt ? new Date(notification.createdAt).toLocaleString('pt-PT') : ''}
                            </div>
                        </div>
                    `;
                });
                
                notificationsBody.innerHTML = notificationsHTML;
            } else {
                notificationsBody.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-bell-slash" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
                        <p>Nenhuma notificação</p>
                    </div>
                `;
            }
            
            updateNotificationCount(unreadCount);
        }
        
        function updateNotificationCount(count) {
            const notificationCount = document.querySelector('.notification-count');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            
            if (count > 0) {
                if (!notificationCount) {
                    const bellIcon = document.querySelector('.notification-btn i.fa-bell');
                    if (bellIcon) {
                        const countSpan = document.createElement('span');
                        countSpan.className = 'notification-count show';
                        countSpan.textContent = count > 9 ? '9+' : count;
                        bellIcon.parentNode.appendChild(countSpan);
                    }
                } else {
                    notificationCount.textContent = count > 9 ? '9+' : count;
                }
                
                if (markAllReadBtn) {
                    markAllReadBtn.style.display = 'block';
                }
            } else {
                if (notificationCount) {
                    notificationCount.remove();
                }
                if (markAllReadBtn) {
                    markAllReadBtn.style.display = 'none';
                }
            }
        }
        
        function applyFilters() {
            const search = document.getElementById('searchInput')?.value || '';
            const role = document.getElementById('roleFilter')?.value || 'all';
            const status = document.getElementById('statusFilter')?.value || 'all';
            const sort = document.getElementById('sortSelect')?.value || 'name';
            const order = document.getElementById('orderSelect')?.value || 'desc';
            
            let url = '/staff?';
            if (search) url += `search=${encodeURIComponent(search)}&`;
            if (role !== 'all') url += `role=${role}&`;
            if (status !== 'all') url += `status=${status}&`;
            url += `sort=${sort}&order=${order}&page=1`;
            
            window.location.href = url;
        }
        
        function goToPage(page) {
            const search = document.getElementById('searchInput')?.value || '';
            const role = document.getElementById('roleFilter')?.value || 'all';
            const status = document.getElementById('statusFilter')?.value || 'all';
            const sort = document.getElementById('sortSelect')?.value || 'name';
            const order = document.getElementById('orderSelect')?.value || 'desc';
            
            let url = `/staff?page=${page}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (role !== 'all') url += `&role=${role}`;
            if (status !== 'all') url += `&status=${status}`;
            url += `&sort=${sort}&order=${order}`;
            
            window.location.href = url;
        }
        
        function openCreateModal() {
            const modal = document.getElementById('staffModal');
            const modalTitle = document.getElementById('modalTitle');
            const passwordGroup = document.getElementById('passwordGroup');
            const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
            const form = document.getElementById('staffForm');
            
            modalTitle.textContent = 'Novo Staff';
            passwordGroup.style.display = 'block';
            confirmPasswordGroup.style.display = 'block';
            form.reset();
            document.getElementById('staffId').value = '';
            document.getElementById('isActive').checked = true;
            
            modal.style.display = 'flex';
        }
        
        function openEditModal(staffId, name, email, role, department, isActive) {
            const modal = document.getElementById('staffModal');
            const modalTitle = document.getElementById('modalTitle');
            const passwordGroup = document.getElementById('passwordGroup');
            const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
            
            modalTitle.textContent = 'Editar Staff';
            passwordGroup.style.display = 'none';
            confirmPasswordGroup.style.display = 'none';
            
            document.getElementById('staffId').value = staffId;
            document.getElementById('name').value = name || '';
            document.getElementById('email').value = email || '';
            document.getElementById('role').value = role || '';
            document.getElementById('department').value = department || '';
            document.getElementById('isActive').checked = isActive;
            
            modal.style.display = 'flex';
        }
        
        function openActivateModal(staffId, staffName, isActivate) {
            const modal = document.getElementById('activateModal');
            const title = document.getElementById('activateTitle');
            const message = document.getElementById('activateMessage');
            const details = document.getElementById('activateDetails');
            const icon = document.getElementById('activateIcon');
            
            if (isActivate) {
                title.textContent = 'Ativar Conta';
                message.textContent = `Tem certeza que deseja ativar a conta de ${staffName}?`;
                details.textContent = 'O utilizador poderá voltar a fazer login no sistema.';
                icon.className = 'fas fa-user-check';
            } else {
                title.textContent = 'Desativar Conta';
                message.textContent = `Tem certeza que deseja desativar a conta de ${staffName}?`;
                details.textContent = 'O utilizador não poderá fazer login até que a conta seja reativada.';
                icon.className = 'fas fa-user-slash';
            }
            
            document.getElementById('activateStaffId').value = staffId;
            document.getElementById('activateAction').value = isActivate ? 'activate' : 'deactivate';
            
            modal.style.display = 'flex';
        }
        
        function openDeleteModal(staffId, staffName) {
            const modal = document.getElementById('deleteModal');
            const title = document.getElementById('deleteTitle');
            const message = document.getElementById('deleteMessage');
            
            title.textContent = `Eliminar ${staffName}`;
            message.textContent = `Tem certeza que deseja eliminar permanentemente a conta de ${staffName}?`;
            
            document.getElementById('deleteStaffId').value = staffId;
            document.getElementById('deleteStaffName').value = staffName;
            
            modal.style.display = 'flex';
        }
        
        function setupModalEvents() {
            // Modal de staff (criar/editar)
            const staffModal = document.getElementById('staffModal');
            const staffModalClose = document.getElementById('staffModalClose');
            const staffModalCancel = document.getElementById('staffModalCancel');
            const staffModalSave = document.getElementById('staffModalSave');
            
            if (staffModalClose) {
                staffModalClose.addEventListener('click', () => {
                    staffModal.style.display = 'none';
                });
            }
            
            if (staffModalCancel) {
                staffModalCancel.addEventListener('click', () => {
                    staffModal.style.display = 'none';
                });
            }
            
            if (staffModalSave) {
                staffModalSave.addEventListener('click', saveStaff);
            }
            
            // Modal de ativar/desativar
            const activateModal = document.getElementById('activateModal');
            const activateModalClose = document.getElementById('activateModalClose');
            const activateModalCancel = document.getElementById('activateModalCancel');
            const activateModalConfirm = document.getElementById('activateModalConfirm');
            
            if (activateModalClose) {
                activateModalClose.addEventListener('click', () => {
                    activateModal.style.display = 'none';
                });
            }
            
            if (activateModalCancel) {
                activateModalCancel.addEventListener('click', () => {
                    activateModal.style.display = 'none';
                });
            }
            
            if (activateModalConfirm) {
                activateModalConfirm.addEventListener('click', toggleStaffStatus);
            }
            
            // Modal de eliminar
            const deleteModal = document.getElementById('deleteModal');
            const deleteModalClose = document.getElementById('deleteModalClose');
            const deleteModalCancel = document.getElementById('deleteModalCancel');
            const deleteModalConfirm = document.getElementById('deleteModalConfirm');
            
            if (deleteModalClose) {
                deleteModalClose.addEventListener('click', () => {
                    deleteModal.style.display = 'none';
                });
            }
            
            if (deleteModalCancel) {
                deleteModalCancel.addEventListener('click', () => {
                    deleteModal.style.display = 'none';
                });
            }
            
            if (deleteModalConfirm) {
                deleteModalConfirm.addEventListener('click', deleteStaff);
            }
            
            // Fechar modais ao clicar fora
            window.addEventListener('click', (e) => {
                if (e.target === staffModal) {
                    staffModal.style.display = 'none';
                }
                if (e.target === activateModal) {
                    activateModal.style.display = 'none';
                }
                if (e.target === deleteModal) {
                    deleteModal.style.display = 'none';
                }
            });
        }
        
        async function saveStaff() {
            const form = document.getElementById('staffForm');
            const staffId = document.getElementById('staffId').value;
            const isEdit = !!staffId;
            
            // Validação básica
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const role = document.getElementById('role').value;
            const password = document.getElementById('password')?.value || '';
            const confirmPassword = document.getElementById('confirmPassword')?.value || '';
            
            if (!name || !email || !role) {
                showToast('Por favor, preencha todos os campos obrigatórios.', 'error');
                return;
            }
            
            if (!isEdit && (!password || password.length < 8)) {
                showToast('A password deve ter pelo menos 8 caracteres.', 'error');
                return;
            }
            
            if (!isEdit && password !== confirmPassword) {
                showToast('As passwords não coincidem.', 'error');
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Limpar campos de password se estiver em modo de edição
            if (isEdit) {
                delete data.password;
                delete data.confirmPassword;
            }
            
            data.isActive = document.getElementById('isActive').checked ? 'true' : 'false';
            
            try {
                let response;
                let url = '/api/staff';
                
                if (isEdit) {
                    response = await fetch(`/api/staff/${staffId}/update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('/api/staff/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message || 'Staff guardado com sucesso!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(result.error || 'Erro ao guardar staff.', 'error');
                }
            } catch (error) {
                console.error('Erro ao guardar staff:', error);
                showToast('Erro de comunicação com o servidor.', 'error');
            }
        }
        
        async function toggleStaffStatus() {
            const staffId = document.getElementById('activateStaffId').value;
            const action = document.getElementById('activateAction').value;
            const isActivate = action === 'activate';
            
            try {
                const response = await fetch(`/api/staff/${staffId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        isActive: isActivate ? 'true' : 'false',
                        isOnline: isActivate ? 'false' : 'false'  // Forçar offline se desativar
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message || 'Estado atualizado com sucesso!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(result.error || 'Erro ao atualizar estado.', 'error');
                }
            } catch (error) {
                console.error('Erro ao atualizar estado:', error);
                showToast('Erro de comunicação com o servidor.', 'error');
            } finally {
                document.getElementById('activateModal').style.display = 'none';
            }
        }
        
        async function deleteStaff() {
            const staffId = document.getElementById('deleteStaffId').value;
            const staffName = document.getElementById('deleteStaffName').value;
            
            try {
                const response = await fetch(`/api/staff/${staffId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`${staffName} eliminado com sucesso!`, 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(result.error || 'Erro ao eliminar staff.', 'error');
                }
            } catch (error) {
                console.error('Erro ao eliminar staff:', error);
                showToast('Erro de comunicação com o servidor.', 'error');
            } finally {
                document.getElementById('deleteModal').style.display = 'none';
            }
        }
        
        function showToast(message, type = 'info') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => {
                toast.remove();
            });
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 5000);
        }
        
        function startClock() {
            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('pt-PT', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const serverTimeElement = document.getElementById('serverTime');
                if (serverTimeElement) {
                    serverTimeElement.textContent = timeString;
                }
            }
            
            updateClock();
            setInterval(updateClock, 1000);
        }
        
        // Funções para lidar com erros de avatar
        window.handleAvatarError = function(img, containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                img.style.display = 'none';
                if (!container.querySelector('i')) {
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-user-tie';
                    container.appendChild(icon);
                }
            }
        };
        
        window.handleTableAvatarError = function(img) {
            img.style.display = 'none';
            const container = img.parentElement;
            if (container && !container.querySelector('i')) {
                const icon = document.createElement('i');
                icon.className = 'fas fa-user-tie';
                container.appendChild(icon);
            }
        };
    </script>
</body>
</html>