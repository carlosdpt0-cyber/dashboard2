<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B7Uno Casino | Logs do Sistema</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/logs.css">
    <style>
        /* Estilos adicionais se necessário */
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h2>B7Uno Casino</h2>
                <div class="user-mini-info">
                    <span id="sidebarStaffName"><%= user.name %></span>
                    <small id="sidebarStaffRole"><%= user.role %></small>
                </div>
            </div>
            
            <ul class="menu">
                <li><a href="/dashboard">
                    <i class="fas fa-home"></i><span> Dashboard</span>
                </a></li>
                <li><a href="/players">
                    <i class="fas fa-users"></i><span> Jogadores</span>
                </a></li>
                <li><a href="/withdrawals">
                    <i class="fas fa-money-bill-wave"></i><span> Levantamentos</span>
                </a></li>
                <li><a href="/payments">
                    <i class="fas fa-credit-card"></i><span> Pagamentos</span>
                </a></li>
                <li><a href="/support">
                    <i class="fas fa-headset"></i><span> Suporte</span>
                </a></li>
                <li><a href="/staff">
                    <i class="fas fa-user-tie"></i><span> Staff</span>
                </a></li>
                <li><a href="/email">
                    <i class="fas fa-envelope"></i><span> Email</span>
                </a></li>
                <li><a href="/logs" class="active">
                    <i class="fas fa-clipboard-list"></i><span> Logs</span>
                    <% if (unreadLogs && unreadLogs > 0) { %>
                        <span class="badge"><%= unreadLogs %></span>
                    <% } %>
                </a></li>
                <li><a href="/settings">
                    <i class="fas fa-cog"></i><span> Definições</span>
                </a></li>
                
                <!-- Logout -->
                <li>
                    <a href="#" onclick="logoutUser()" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i><span> Sair</span>
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-footer" style="padding: 15px; border-top: 1px solid var(--border-color);">
                <div class="server-time" id="serverTime" style="font-size: 12px; color: var(--text-secondary); text-align: center;">--:--:--</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Topbar -->
            <div class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="breadcrumb" id="breadcrumb">
                        Logs do Sistema
                    </div>
                </div>
                
                <div class="topbar-right">
                    <!-- Theme Toggle -->
                    <div class="theme-toggle" id="topbarThemeToggle">
                        <input type="checkbox" id="topbarThemeCheckbox">
                        <div class="toggle-switch"></div>
                        <span class="theme-label" id="topbarThemeLabel">Modo Escuro</span>
                    </div>
                    
                    <div class="user-profile" id="userProfile">
                        <div class="user-avatar" id="userAvatar">
                            <%= user.name.split(' ').map(n => n[0]).join('').toUpperCase() %>
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="topbarStaffName"><%= user.name %></div>
                            <div class="user-role" id="topbarStaffRole"><%= user.role %></div>
                        </div>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="user-dropdown-header">
                                <div class="user-avatar">
                                    <%= user.name.split(' ').map(n => n[0]).join('').toUpperCase() %>
                                </div>
                                <div class="user-info">
                                    <div class="user-name"><%= user.name %></div>
                                    <div class="user-email"><%= user.email || 'email@exemplo.com' %></div>
                                </div>
                            </div>
                            <ul class="user-dropdown-menu">
                                <li><a href="/profile">
                                    <i class="fas fa-user"></i> Perfil
                                </a></li>
                                <li><a href="/settings">
                                    <i class="fas fa-cog"></i> Definições
                                </a></li>
                                <li><a href="#" onclick="logoutUser()">
                                    <i class="fas fa-sign-out-alt"></i> Sair
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Header -->
                <div class="logs-header">
                    <h1>
                        <i class="fas fa-clipboard-list"></i> Logs do Sistema
                    </h1>
                    <p>
                        Registo completo de todas as ações realizadas no sistema. Monitorize atividades de administradores, jogadores e eventos do sistema.
                    </p>
                </div>

                <!-- Auto Refresh -->
                <div class="auto-refresh-toggle" id="autoRefreshToggle">
                    <label for="autoRefreshCheckbox">
                        <i class="fas fa-sync-alt"></i> Atualização Automática
                        <span class="real-time-badge" id="realTimeBadge">
                            <i class="fas fa-circle"></i> TEMPO REAL
                        </span>
                    </label>
                    <div class="toggle-switch-small" id="autoRefreshSwitch"></div>
                </div>

                <!-- Stats -->
                <div class="logs-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total de Logs</div>
                        <div class="stat-value" id="totalLogs">0</div>
                        <div class="stat-subtext" id="logPeriod">Últimos 30 dias</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Logs Hoje</div>
                        <div class="stat-value" id="todayLogs">0</div>
                        <div class="stat-subtext" id="todayPeriod">Até agora</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Administradores Ativos</div>
                        <div class="stat-value" id="activeAdmins">0</div>
                        <div class="stat-subtext">Ativos nas últimas 2 horas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Taxa de Atividade</div>
                        <div class="stat-value" id="activityRate">0/min</div>
                        <div class="stat-subtext">Média por minuto</div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="filters-container">
                    <div class="filter-group">
                        <label><i class="fas fa-user"></i> Utilizador</label>
                        <select class="form-control" id="filterUser">
                            <option value="">Todos os utilizadores</option>
                            <!-- Será preenchido dinamicamente -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-filter"></i> Tipo de Ação</label>
                        <select class="form-control" id="filterAction">
                            <option value="">Todos os tipos</option>
                            <option value="login">Login</option>
                            <option value="logout">Logout</option>
                            <option value="create">Criar</option>
                            <option value="update">Atualizar</option>
                            <option value="delete">Eliminar</option>
                            <option value="security">Segurança</option>
                            <option value="system">Sistema</option>
                            <option value="deposit">Depósito</option>
                            <option value="withdrawal">Levantamento</option>
                            <option value="bonus">Bónus</option>
                            <option value="game">Jogo</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-layer-group"></i> Módulo</label>
                        <select class="form-control" id="filterModule">
                            <option value="">Todos os módulos</option>
                            <option value="auth">Autenticação</option>
                            <option value="players">Jogadores</option>
                            <option value="withdrawals">Levantamentos</option>
                            <option value="deposits">Depósitos</option>
                            <option value="payments">Pagamentos</option>
                            <option value="staff">Staff</option>
                            <option value="settings">Definições</option>
                            <option value="system">Sistema</option>
                            <option value="games">Jogos</option>
                            <option value="bonuses">Bónus</option>
                            <option value="reports">Relatórios</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-calendar"></i> Data Início</label>
                        <input type="date" class="form-control" id="filterDateFrom">
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-calendar"></i> Data Fim</label>
                        <input type="date" class="form-control" id="filterDateTo">
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-search"></i> Pesquisa</label>
                        <input type="text" class="form-control" id="filterSearch" placeholder="Pesquisar por mensagem, IP...">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilters()">
                            <i class="fas fa-redo"></i> Limpar
                        </button>
                    </div>
                </div>

                <!-- Botões de Exportação -->
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="exportLogs('csv')">
                        <i class="fas fa-file-csv"></i> Exportar CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportLogs('json')">
                        <i class="fas fa-file-code"></i> Exportar JSON
                    </button>
                    <button class="btn btn-secondary" onclick="exportLogs('pdf')">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                    <button class="btn btn-danger" onclick="confirmClearLogs()">
                        <i class="fas fa-trash"></i> Limpar Logs Antigos
                    </button>
                </div>

                <!-- Tabela de Logs -->
                <div class="logs-table-container">
                    <div class="table-header">
                        <h3>
                            <i class="fas fa-history"></i> Histórico de Atividades
                            <span class="pagination-info" id="paginationInfo">Carregando...</span>
                        </h3>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-secondary" onclick="refreshLogs()">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="timestamp" onclick="sortTable('timestamp')">
                                        Data/Hora
                                    </th>
                                    <th class="sortable" data-sort="user" onclick="sortTable('user')">
                                        Utilizador
                                    </th>
                                    <th class="sortable" data-sort="action" onclick="sortTable('action')">
                                        Ação
                                    </th>
                                    <th class="sortable" data-sort="module" onclick="sortTable('module')">
                                        Módulo
                                    </th>
                                    <th>Mensagem</th>
                                    <th class="sortable" data-sort="ip" onclick="sortTable('ip')">
                                        IP
                                    </th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <!-- Logs serão carregados aqui dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginação -->
                    <div class="pagination" id="pagination">
                        <!-- Paginação será gerada dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Overlay para mobile -->
        <div class="overlay" id="overlay"></div>
        
        <!-- Modal de Detalhes do Log -->
        <div class="modal" id="logDetailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>
                        <i class="fas fa-search"></i> Detalhes do Log
                    </h3>
                    <button class="modal-close" onclick="closeLogDetails()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="logDetailsContent">
                        <!-- Conteúdo será carregado dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal de Confirmação -->
        <div class="modal" id="confirmModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-exclamation-circle"></i> Confirmação</h3>
                    <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage">Tem a certeza que deseja prosseguir?</p>
                </div>
                <div class="modal-footer" style="padding: 20px; border-top: 1px solid var(--border-color); text-align: right;">
                    <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancelar</button>
                    <button class="btn btn-danger" id="confirmActionBtn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ============ VARIÁVEIS GLOBAIS ============
        let currentLogs = [];
        let filteredLogs = [];
        let currentPage = 1;
        let logsPerPage = 20;
        let totalPages = 1;
        let currentSort = { field: 'timestamp', direction: 'desc' };
        let currentFilters = {};
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;
        let isLoading = false;

        // ============ FUNÇÕES DE TEMA ============
        
        function initTheme() {
            const savedTheme = localStorage.getItem('b7uno-theme') || 'dark';
            const root = document.documentElement;
            root.setAttribute('data-theme', savedTheme);
            updateThemeUI(savedTheme);
        }
        
        function updateThemeUI(theme) {
            const topbarLabel = document.getElementById('topbarThemeLabel');
            const topbarToggle = document.getElementById('topbarThemeToggle');
            
            if (theme === 'light') {
                topbarLabel.textContent = 'Modo Claro';
                topbarToggle.setAttribute('data-theme', 'light');
            } else {
                topbarLabel.textContent = 'Modo Escuro';
                topbarToggle.setAttribute('data-theme', 'dark');
            }
        }
        
        function toggleTheme() {
            const root = document.documentElement;
            const currentTheme = root.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            root.setAttribute('data-theme', newTheme);
            localStorage.setItem('b7uno-theme', newTheme);
            updateThemeUI(newTheme);
            showToast(`Modo ${newTheme === 'light' ? 'Claro' : 'Escuro'} ativado`, 'info');
        }
        
        // ============ SIDEBAR ============
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const isMobile = window.innerWidth <= 1024;
            
            if (isMobile) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }
        
        // ============ USER DROPDOWN ============
        
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
            
            // Fechar dropdown ao clicar fora
            if (dropdown.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', closeUserDropdownOnClickOutside);
                }, 10);
            } else {
                document.removeEventListener('click', closeUserDropdownOnClickOutside);
            }
        }
        
        function closeUserDropdownOnClickOutside(event) {
            const dropdown = document.getElementById('userDropdown');
            const userProfile = document.getElementById('userProfile');
            
            if (!userProfile.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
                document.removeEventListener('click', closeUserDropdownOnClickOutside);
            }
        }
        
        function closeUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('active');
            document.removeEventListener('click', closeUserDropdownOnClickOutside);
        }
        
        // ============ CARREGAMENTO DE LOGS ============
        
        async function loadLogs() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            
            try {
                const queryParams = new URLSearchParams({
                    page: currentPage,
                    limit: logsPerPage,
                    sort: currentSort.field,
                    order: currentSort.direction
                });
                
                // Adicionar filtros à query
                Object.keys(currentFilters).forEach(key => {
                    if (currentFilters[key]) {
                        queryParams.append(key, currentFilters[key]);
                    }
                });
                
                const response = await fetch(`/api/logs?${queryParams}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        currentLogs = data.logs || [];
                        filteredLogs = data.logs || [];
                        totalPages = data.pages || 1;
                        currentPage = data.page || 1;
                        
                        renderLogs();
                        renderPagination();
                        updateStats(data.stats);
                        
                        // Marcar logs como lidos
                        markLogsAsRead();
                    } else {
                        throw new Error(data.message || 'Erro ao carregar logs');
                    }
                } else {
                    throw new Error('Erro na resposta do servidor');
                }
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
                showToast('Erro ao carregar logs: ' + error.message, 'error');
                renderEmptyState();
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }
        
        function showLoading(show) {
            const tableBody = document.getElementById('logsTableBody');
            const paginationInfo = document.getElementById('paginationInfo');
            
            if (show) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 10px; color: var(--text-secondary);">A carregar logs...</p>
                        </td>
                    </tr>
                `;
                paginationInfo.textContent = 'A carregando...';
            }
        }
        
        function renderLogs() {
            const tableBody = document.getElementById('logsTableBody');
            const paginationInfo = document.getElementById('paginationInfo');
            
            if (!filteredLogs || filteredLogs.length === 0) {
                renderEmptyState();
                paginationInfo.textContent = '0 logs encontrados';
                return;
            }
            
            // Calcular índices para a página atual
            const startIndex = (currentPage - 1) * logsPerPage;
            const endIndex = startIndex + logsPerPage;
            const pageLogs = filteredLogs.slice(startIndex, endIndex);
            
            tableBody.innerHTML = pageLogs.map(log => `
                <tr>
                    <td>
                        <div>${formatDateTime(log.timestamp)}</div>
                        <div class="time-ago">${timeAgo(log.timestamp)}</div>
                    </td>
                    <td>
                        <div class="log-user">
                            <div class="user-avatar-small">
                                ${log.user && log.user.name ? log.user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'S'}
                            </div>
                            <div>
                                <strong>${log.user?.name || 'Sistema'}</strong>
                                <div style="font-size: 11px; color: var(--text-secondary);">
                                    ${log.user?.role || 'Sistema'}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="log-type-badge type-${log.action}">
                            ${getActionLabel(log.action)}
                        </span>
                    </td>
                    <td>
                        <span style="font-weight: 500;">${getModuleLabel(log.module)}</span>
                    </td>
                    <td>
                        <div class="log-message">${escapeHtml(log.message || 'Sem mensagem')}</div>
                        ${log.details ? `
                            <div class="log-details">
                                <small>${escapeHtml(log.details)}</small>
                            </div>
                        ` : ''}
                        <div class="log-meta">
                            <span><i class="fas fa-desktop"></i> ${log.userAgent ? escapeHtml(log.userAgent.substring(0, 30) + '...') : 'N/A'}</span>
                        </div>
                    </td>
                    <td>
                        <code style="font-size: 12px;">${log.ip || 'N/A'}</code>
                        ${log.location ? `
                            <div class="log-details">
                                <small><i class="fas fa-map-marker-alt"></i> ${escapeHtml(log.location)}</small>
                            </div>
                        ` : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewLogDetails('${log._id || log.id}')" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            const total = filteredLogs.length;
            const showingStart = startIndex + 1;
            const showingEnd = Math.min(endIndex, total);
            
            paginationInfo.textContent = `A mostrar ${showingStart}-${showingEnd} de ${total} logs`;
        }
        
        function renderEmptyState() {
            const tableBody = document.getElementById('logsTableBody');
            
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 60px 20px;">
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h3>Nenhum log encontrado</h3>
                            <p>Não foram encontrados logs com os filtros atuais.</p>
                            <button class="btn btn-primary" onclick="resetFilters()" style="margin-top: 15px;">
                                <i class="fas fa-redo"></i> Limpar Filtros
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // ============ FILTROS ============
        
        function applyFilters() {
            currentFilters = {
                user: document.getElementById('filterUser').value,
                action: document.getElementById('filterAction').value,
                module: document.getElementById('filterModule').value,
                dateFrom: document.getElementById('filterDateFrom').value,
                dateTo: document.getElementById('filterDateTo').value,
                search: document.getElementById('filterSearch').value
            };
            
            currentPage = 1;
            loadLogs();
            
            // Salvar filtros no localStorage
            localStorage.setItem('b7uno-log-filters', JSON.stringify(currentFilters));
            
            showToast('Filtros aplicados', 'info');
        }
        
        function resetFilters() {
            document.getElementById('filterUser').value = '';
            document.getElementById('filterAction').value = '';
            document.getElementById('filterModule').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterSearch').value = '';
            
            currentFilters = {};
            currentPage = 1;
            
            loadLogs();
            localStorage.removeItem('b7uno-log-filters');
            
            showToast('Filtros limpos', 'info');
        }
        
        function loadSavedFilters() {
            const savedFilters = localStorage.getItem('b7uno-log-filters');
            if (savedFilters) {
                try {
                    currentFilters = JSON.parse(savedFilters);
                    
                    // Restaurar valores dos inputs
                    if (currentFilters.user) {
                        document.getElementById('filterUser').value = currentFilters.user;
                    }
                    if (currentFilters.action) {
                        document.getElementById('filterAction').value = currentFilters.action;
                    }
                    if (currentFilters.module) {
                        document.getElementById('filterModule').value = currentFilters.module;
                    }
                    if (currentFilters.dateFrom) {
                        document.getElementById('filterDateFrom').value = currentFilters.dateFrom;
                    }
                    if (currentFilters.dateTo) {
                        document.getElementById('filterDateTo').value = currentFilters.dateTo;
                    }
                    if (currentFilters.search) {
                        document.getElementById('filterSearch').value = currentFilters.search;
                    }
                } catch (error) {
                    console.error('Erro ao carregar filtros:', error);
                }
            }
        }
        
        // ============ ORDENAÇÃO ============
        
        function sortTable(field) {
            if (currentSort.field === field) {
                // Alternar direção
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // Nova ordenação
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            // Atualizar indicadores visuais
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === field) {
                    th.classList.add(`sort-${currentSort.direction}`);
                }
            });
            
            // Ordenar logs localmente
            if (filteredLogs.length > 0) {
                filteredLogs.sort((a, b) => {
                    let aValue = a[field];
                    let bValue = b[field];
                    
                    // Tratamento especial para campos aninhados
                    if (field === 'user') {
                        aValue = a.user?.name || '';
                        bValue = b.user?.name || '';
                    }
                    
                    if (field === 'timestamp') {
                        aValue = new Date(a.timestamp);
                        bValue = new Date(b.timestamp);
                    }
                    
                    if (field === 'ip') {
                        aValue = a.ip || '';
                        bValue = b.ip || '';
                    }
                    
                    if (aValue < bValue) {
                        return currentSort.direction === 'asc' ? -1 : 1;
                    }
                    if (aValue > bValue) {
                        return currentSort.direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
                
                renderLogs();
            } else {
                // Recarregar do servidor
                loadLogs();
            }
        }
        
        // ============ PAGINAÇÃO ============
        
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Botão anterior
            html += `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Números de página
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>
                        ${i}
                    </button>
                `;
            }
            
            // Botão próximo
            html += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            pagination.innerHTML = html;
        }
        
        function changePage(page) {
            if (page < 1 || page > totalPages || page === currentPage) {
                return;
            }
            
            currentPage = page;
            loadLogs();
            
            // Scroll para o topo da tabela
            document.querySelector('.logs-table-container').scrollIntoView({
                behavior: 'smooth'
            });
        }
        
        // ============ DETALHES DO LOG ============
        
        async function viewLogDetails(logId) {
            try {
                const response = await fetch(`/api/logs/${logId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        renderLogDetails(data.log);
                        openLogDetails();
                    } else {
                        throw new Error(data.message || 'Erro ao carregar detalhes');
                    }
                } else {
                    throw new Error('Erro na resposta do servidor');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do log:', error);
                showToast('Erro ao carregar detalhes: ' + error.message, 'error');
            }
        }
        
        function renderLogDetails(log) {
            const content = document.getElementById('logDetailsContent');
            
            content.innerHTML = `
                <div class="log-detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">ID do Log</div>
                        <div class="detail-value">${log._id || log.id}</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Data/Hora</div>
                        <div class="detail-value">
                            ${formatDateTime(log.timestamp)}
                            <br>
                            <small class="time-ago">${timeAgo(log.timestamp)}</small>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Utilizador</div>
                        <div class="detail-value">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <div class="user-avatar-small">
                                    ${log.user?.name ? log.user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'S'}
                                </div>
                                <div>
                                    <strong>${escapeHtml(log.user?.name || 'Sistema')}</strong>
                                    ${log.user?.email ? `
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            ${escapeHtml(log.user.email)}
                                        </div>
                                    ` : ''}
                                    <div style="font-size: 11px; color: var(--text-tertiary);">
                                        ${escapeHtml(log.user?.role || 'Sistema')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Ação</div>
                        <div class="detail-value">
                            <span class="log-type-badge type-${log.action}">
                                ${getActionLabel(log.action)}
                            </span>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Módulo</div>
                        <div class="detail-value">
                            <span style="font-weight: 500;">${getModuleLabel(log.module)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Mensagem</div>
                    <div class="detail-value">
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            ${escapeHtml(log.message || 'Sem mensagem')}
                        </div>
                    </div>
                </div>
                
                ${log.details ? `
                    <div class="detail-item">
                        <div class="detail-label">Detalhes Adicionais</div>
                        <div class="detail-value">
                            <pre style="max-height: 200px; overflow: auto; background: var(--bg-tertiary); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color);">${typeof log.details === 'string' ? escapeHtml(log.details) : JSON.stringify(log.details, null, 2)}</pre>
                        </div>
                    </div>
                ` : ''}
                
                <div class="log-detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Endereço IP</div>
                        <div class="detail-value">
                            <code>${log.ip || 'N/A'}</code>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Localização</div>
                        <div class="detail-value">
                            ${log.location ? escapeHtml(log.location) : 'N/A'}
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">User Agent</div>
                        <div class="detail-value">
                            <small>${log.userAgent ? escapeHtml(log.userAgent) : 'N/A'}</small>
                        </div>
                    </div>
                    
                    ${log.sessionId ? `
                        <div class="detail-item">
                            <div class="detail-label">Sessão ID</div>
                            <div class="detail-value">
                                <code style="font-size: 11px;">${log.sessionId}</code>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                ${log.metadata ? `
                    <div class="detail-item">
                        <div class="detail-label">Metadados</div>
                        <div class="detail-value">
                            <pre style="max-height: 200px; overflow: auto; background: var(--bg-tertiary); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color);">${JSON.stringify(log.metadata, null, 2)}</pre>
                        </div>
                    </div>
                ` : ''}
                
                <div class="detail-item">
                    <div class="detail-label">Ações</div>
                    <div class="detail-value">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="copyLogDetails()">
                                <i class="fas fa-copy"></i> Copiar Detalhes
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function openLogDetails() {
            document.getElementById('logDetailsModal').classList.add('active');
        }
        
        function closeLogDetails() {
            document.getElementById('logDetailsModal').classList.remove('active');
        }
        
        // ============ FUNÇÕES UTILITÁRIAS ============
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDateTime(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('pt-PT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                return 'Data inválida';
            }
        }
        
        function timeAgo(timestamp) {
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) {
                    return 'agora mesmo';
                } else if (diffMins < 60) {
                    return `há ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
                } else if (diffHours < 24) {
                    return `há ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
                } else if (diffDays === 1) {
                    return 'ontem';
                } else if (diffDays < 7) {
                    return `há ${diffDays} dia${diffDays > 1 ? 's' : ''}`;
                } else if (diffDays < 30) {
                    const weeks = Math.floor(diffDays / 7);
                    return `há ${weeks} semana${weeks > 1 ? 's' : ''}`;
                } else {
                    const months = Math.floor(diffDays / 30);
                    return `há ${months} mês${months > 1 ? 'es' : ''}`;
                }
            } catch (e) {
                return 'tempo desconhecido';
            }
        }
        
        function getActionLabel(action) {
            const actions = {
                'login': 'Login',
                'logout': 'Logout',
                'create': 'Criar',
                'update': 'Atualizar',
                'delete': 'Eliminar',
                'security': 'Segurança',
                'system': 'Sistema',
                'deposit': 'Depósito',
                'withdrawal': 'Levantamento',
                'bonus': 'Bónus',
                'game': 'Jogo'
            };
            return actions[action] || action;
        }
        
        function getModuleLabel(module) {
            const modules = {
                'auth': 'Autenticação',
                'players': 'Jogadores',
                'withdrawals': 'Levantamentos',
                'deposits': 'Depósitos',
                'payments': 'Pagamentos',
                'staff': 'Staff',
                'settings': 'Definições',
                'system': 'Sistema',
                'games': 'Jogos',
                'bonuses': 'Bónus',
                'reports': 'Relatórios'
            };
            return modules[module] || module;
        }
        
        function updateStats(stats) {
            if (stats) {
                document.getElementById('totalLogs').textContent = stats.total?.toLocaleString('pt-PT') || '0';
                document.getElementById('todayLogs').textContent = stats.today?.toLocaleString('pt-PT') || '0';
                document.getElementById('activeAdmins').textContent = stats.activeAdmins?.toLocaleString('pt-PT') || '0';
                document.getElementById('activityRate').textContent = stats.activityRate || '0/min';
            }
        }
        
        function markLogsAsRead() {
            // Marcar logs como lidos no servidor
            fetch('/api/logs/mark-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(() => {
                // Remover badge
                const badge = document.querySelector('.menu li a[href="/logs"] .badge');
                if (badge) {
                    badge.style.display = 'none';
                }
            }).catch(err => console.error('Erro ao marcar logs como lidos:', err));
        }
        
        // ============ ATUALIZAÇÃO AUTOMÁTICA ============
        
        function toggleAutoRefresh() {
            const switchElement = document.getElementById('autoRefreshSwitch');
            const badge = document.getElementById('realTimeBadge');
            
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                switchElement.classList.add('active');
                badge.style.display = 'inline-flex';
                startAutoRefresh();
                showToast('Atualização automática ativada', 'success');
            } else {
                switchElement.classList.remove('active');
                badge.style.display = 'none';
                stopAutoRefresh();
                showToast('Atualização automática desativada', 'warning');
            }
        }
        
        function startAutoRefresh() {
            // Atualizar a cada 30 segundos
            autoRefreshInterval = setInterval(() => {
                if (!isLoading) {
                    loadLogs();
                }
            }, 30000);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // ============ EXPORTAÇÃO ============
        
        async function exportLogs(format) {
            try {
                // Construir query string com filtros
                const params = new URLSearchParams();
                
                // Adicionar parâmetros de filtro
                if (currentFilters.user) params.append('user', currentFilters.user);
                if (currentFilters.action) params.append('action', currentFilters.action);
                if (currentFilters.module) params.append('module', currentFilters.module);
                if (currentFilters.dateFrom) params.append('dateFrom', currentFilters.dateFrom);
                if (currentFilters.dateTo) params.append('dateTo', currentFilters.dateTo);
                if (currentFilters.search) params.append('search', currentFilters.search);
                
                params.append('format', format);
                
                showToast(`A preparar exportação em ${format.toUpperCase()}...`, 'info');
                
                // Abrir numa nova janela/tab para download
                const exportUrl = `/api/logs/export?${params.toString()}`;
                window.open(exportUrl, '_blank');
                
                // Mostrar mensagem após um pequeno delay
                setTimeout(() => {
                    showToast(`Exportação em ${format.toUpperCase()} iniciada`, 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Erro na exportação:', error);
                showToast('Erro ao exportar logs', 'error');
            }
        }
        
        function copyLogDetails() {
            const content = document.getElementById('logDetailsContent');
            const text = content.innerText;
            
            navigator.clipboard.writeText(text)
                .then(() => showToast('Detalhes copiados para a área de transferência', 'success'))
                .catch(() => showToast('Erro ao copiar detalhes', 'error'));
        }
        
        // ============ LIMPEZA DE LOGS ============
        
        function confirmClearLogs() {
            showConfirmModal('Tem a certeza que deseja limpar logs com mais de 90 dias? Esta ação não pode ser desfeita.', () => {
                clearOldLogs();
            });
        }
        
        async function clearOldLogs() {
            try {
                const response = await fetch('/api/logs/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ days: 90 })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`${data.deletedCount || 0} logs antigos foram removidos`, 'success');
                    // Recarregar logs após limpeza
                    loadLogs();
                } else {
                    showToast('Erro ao limpar logs: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao limpar logs:', error);
                showToast('Erro de conexão ao tentar limpar logs', 'error');
            }
        }
        
        function refreshLogs() {
            if (!isLoading) {
                loadLogs();
                showToast('Logs atualizados', 'info');
            }
        }
        
        // ============ MODAL DE CONFIRMAÇÃO ============
        
        let confirmCallback = null;
        
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            confirmCallback = null;
        }
        
        // Configurar botão de confirmação
        document.getElementById('confirmActionBtn').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        });
        
        // ============ TOAST SYSTEM ============
        
        function showToast(message, type = 'info') {
            // Remover toasts existentes
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Animação de entrada
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // Remover após 4 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // ============ SERVER TIME ============
        
        function updateServerTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-PT');
            const dateString = now.toLocaleDateString('pt-PT', {
                weekday: 'short',
                day: '2-digit',
                month: 'short'
            });
            
            const serverTimeElement = document.getElementById('serverTime');
            if (serverTimeElement) {
                serverTimeElement.innerHTML = `${dateString} ${timeString}`;
            }
        }
        
        // ============ LOGOUT ============
        
        function logoutUser() {
            showConfirmModal('Tem a certeza que deseja sair?', () => {
                window.location.href = '/logout';
            });
        }
        
        // ============ INITIALIZATION ============
        
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            loadSavedFilters();
            loadLogs();
            
            // Configurar menu toggle
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle) {
                menuToggle.addEventListener('click', toggleSidebar);
            }
            
            // Configurar fechamento da sidebar no mobile
            const overlay = document.getElementById('overlay');
            if (overlay) {
                overlay.addEventListener('click', closeSidebar);
            }
            
            // Configurar user dropdown
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                userProfile.addEventListener('click', toggleUserDropdown);
            }
            
            // Configurar theme toggle
            const themeToggle = document.getElementById('topbarThemeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // Configurar auto refresh toggle
            const autoRefreshSwitch = document.getElementById('autoRefreshSwitch');
            if (autoRefreshSwitch) {
                autoRefreshSwitch.addEventListener('click', toggleAutoRefresh);
                // Ativar por padrão
                autoRefreshSwitch.classList.add('active');
            }
            
            // Permitir fechar modais com ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeLogDetails();
                    closeConfirmModal();
                    closeSidebar();
                    closeUserDropdown();
                }
            });
            
            // Iniciar relógio
            updateServerTime();
            setInterval(updateServerTime, 1000);
            
            // Iniciar atualização automática
            startAutoRefresh();
            
            // Carregar lista de utilizadores para filtro
            loadUsersForFilter();
        });
        
        async function loadUsersForFilter() {
            try {
                const response = await fetch('/api/logs/users');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        const users = data.users || [];
                        const select = document.getElementById('filterUser');
                        
                        users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user._id || user.id;
                            option.textContent = `${user.name} (${user.role})`;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar utilizadores:', error);
            }
        }
    </script>
</body>
</html>