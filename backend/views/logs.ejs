<!DOCTYPE html>
<html lang="pt-PT">
<head>
<%
// ===== VARIÁVEIS SEGURAS =====
const safeUser = user || {
    id: 'unknown',
    name: 'Utilizador',
    email: '',
    role: 'viewer',
    photo: null,
    acceptedConfidentiality: false
};

// Preparar logs para renderização
let safeLogs = logs || [];
let safeStats = stats || {
    total: 0,
    today: 0,
    byAction: [],
    byModule: [],
    unreadLogs: 0
};

// Filtrar logs para não mostrar admin nos usuários de filtro
const usersWithLogs = users || [];

// Role mapping para display
const roleLabels = {
    'admin': 'Administrador',
    'support_manager': 'Gestor de Suporte',
    'support': 'Suporte',
    'finance': 'Financeiro',
    'moderator': 'Moderador',
    'viewer': 'Visualizador'
};

// Action mapping para display
const actionLabels = {
    'login': 'Login',
    'logout': 'Logout',
    'create': 'Criar',
    'update': 'Atualizar',
    'delete': 'Eliminar',
    'view': 'Visualizar',
    'approve': 'Aprovar',
    'reject': 'Rejeitar',
    'system': 'Sistema'
};

// Module mapping para display
const moduleLabels = {
    'auth': 'Autenticação',
    'players': 'Jogadores',
    'withdrawals': 'Levantamentos',
    'payments': 'Pagamentos',
    'staff': 'Staff',
    'support': 'Suporte',
    'settings': 'Definições',
    'system': 'Sistema',
    'email': 'Email',
    'dashboard': 'Dashboard'
};

// Permissões
const canManageLogs = safeUser.role === 'admin' || safeUser.permissions?.includes('manage_settings') || false;

// Obter parâmetros de ordenação
const sortParam = typeof sort !== 'undefined' ? sort : 'timestamp';
const orderParam = typeof order !== 'undefined' ? order : 'desc';

// Filtrar logs para remover duplicação da foto
let displayedLogs = 0;
%>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VelvetWin | Logs do Sistema</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/logs.css">
    <style>
        /* Estilos para avatares */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-primary);
            color: white;
            font-weight: bold;
            font-size: 14px;
            position: relative;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .user-mini-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-primary);
            color: white;
            font-size: 16px;
        }
        
        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        /* Estilos adicionais */
        .log-type-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }
        
        .type-login { background: rgba(40, 167, 69, 0.1); color: #28a745; border: 1px solid rgba(40, 167, 69, 0.3); }
        .type-logout { background: rgba(255, 193, 7, 0.1); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.3); }
        .type-create { background: rgba(23, 162, 184, 0.1); color: #17a2b8; border: 1px solid rgba(23, 162, 184, 0.3); }
        .type-update { background: rgba(0, 123, 255, 0.1); color: #007bff; border: 1px solid rgba(0, 123, 255, 0.3); }
        .type-delete { background: rgba(220, 53, 69, 0.1); color: #dc3545; border: 1px solid rgba(220, 53, 69, 0.3); }
        .type-system { background: rgba(108, 117, 125, 0.1); color: #6c757d; border: 1px solid rgba(108, 117, 125, 0.3); }
        .type-approve { background: rgba(40, 167, 69, 0.1); color: #28a745; border: 1px solid rgba(40, 167, 69, 0.3); }
        .type-reject { background: rgba(220, 53, 69, 0.1); color: #dc3545; border: 1px solid rgba(220, 53, 69, 0.3); }
        .type-view { background: rgba(111, 66, 193, 0.1); color: #6f42c1; border: 1px solid rgba(111, 66, 193, 0.3); }

        .time-ago {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .log-user {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .log-message {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 4px;
        }
        
        .log-details {
            background: var(--bg-tertiary);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            word-break: break-word;
        }
        
        .log-meta {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 5px;
        }
        
        .log-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 15px;
        }
        
        .sortable:hover {
            background: var(--hover-bg);
        }
        
        .sortable.sort-asc::after {
            content: ' ▲';
            font-size: 10px;
            color: var(--accent-primary);
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .sortable.sort-desc::after {
            content: ' ▼';
            font-size: 10px;
            color: var(--accent-primary);
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 400px;
        }
        
        .toast.success {
            border-left: 4px solid #28a745;
        }
        
        .toast.error {
            border-left: 4px solid #dc3545;
        }
        
        .toast.warning {
            border-left: 4px solid #ffc107;
        }
        
        .toast.info {
            border-left: 4px solid var(--accent-primary);
        }
        
        .toast i {
            font-size: 20px;
        }
        
        .toast.success i { color: #28a745; }
        .toast.error i { color: #dc3545; }
        .toast.warning i { color: #ffc107; }
        .toast.info i { color: var(--accent-primary); }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .modal-close:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Detalhes do log */
        .log-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            margin-bottom: 15px;
        }
        
        .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 14px;
            color: var(--text-primary);
            word-break: break-word;
        }
        
        /* Auto refresh */
        .auto-refresh-toggle {
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .auto-refresh-toggle label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .real-time-badge {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .real-time-badge i {
            font-size: 6px;
        }
        
        .toggle-switch-small {
            width: 50px;
            height: 24px;
            background: var(--border-color);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .toggle-switch-small.active {
            background: var(--accent-primary);
        }
        
        .toggle-switch-small::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-switch-small.active::after {
            transform: translateX(26px);
        }
        
        /* Botões de exportação */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        /* Paginação */
        .pagination {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .pagination button {
            min-width: 36px;
            height: 36px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--hover-bg);
            border-color: var(--accent-primary);
        }
        
        .pagination button.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin-left: 15px;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .filters-container {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .logs-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .log-detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 576px) {
            .logs-stats {
                grid-template-columns: 1fr;
            }
            
            .pagination button {
                min-width: 30px;
                height: 30px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h2>VelvetWin <span class="admin-badge">ADMIN</span></h2>
                <div class="user-mini-info">
                    <div class="user-mini-avatar" id="sidebarAvatar">
                        <% if (safeUser.photo) { %>
                            <img src="/profile-photos/<%= safeUser.photo %>?t=<%= Date.now() %>" 
                                 alt="<%= safeUser.name %>"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <i class="fas fa-user-tie" style="display:none;"></i>
                        <% } else { %>
                            <i class="fas fa-user-tie"></i>
                        <% } %>
                    </div>
                    <div class="user-mini-details">
                        <span id="sidebarStaffName"><%= safeUser.name %></span>
                        <small id="sidebarStaffRole"><%= safeUser.role.toUpperCase() %></small>
                    </div>
                </div>
            </div>
            
            <ul class="menu">
                <li><a href="/dashboard">
                    <i class="fas fa-home"></i><span> Dashboard</span>
                </a></li>
                <li><a href="/players">
                    <i class="fas fa-users"></i><span> Jogadores</span>
                </a></li>
                <li><a href="/withdrawals">
                    <i class="fas fa-money-bill-wave"></i><span> Levantamentos</span>
                </a></li>
                <li><a href="/payments">
                    <i class="fas fa-credit-card"></i><span> Pagamentos</span>
                </a></li>
                <li><a href="/support">
                    <i class="fas fa-headset"></i><span> Suporte</span>
                </a></li>
                <li><a href="/staff">
                    <i class="fas fa-user-tie"></i><span> Staff</span>
                </a></li>
                <li><a href="/email">
                    <i class="fas fa-envelope"></i><span> Email</span>
                </a></li>
                <li><a href="/logs" class="active">
                    <i class="fas fa-clipboard-list"></i><span> Logs</span>
                    <% if (safeStats.unreadLogs && safeStats.unreadLogs > 0) { %>
                        <span class="badge"><%= safeStats.unreadLogs %></span>
                    <% } %>
                </a></li>
                <li><a href="/settings">
                    <i class="fas fa-cog"></i><span> Definições</span>
                </a></li>
            </ul>
            
            <div class="sidebar-footer">
                <div class="system-status">
                    <div class="status-indicator"></div>
                    <span>Sistema Online</span>
                </div>
                <div class="server-time" id="serverTime">--:--:--</div>
            </div>
        </div>

        <!-- Overlay para mobile -->
        <div class="overlay" id="overlay"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Topbar -->
            <div class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="breadcrumb" id="breadcrumb">
                        Logs do Sistema
                    </div>
                </div>
                
                <div class="topbar-right">
                    <!-- Theme Toggle -->
                    <div class="theme-toggle" id="topbarThemeToggle">
                        <input type="checkbox" id="topbarThemeCheckbox">
                        <div class="toggle-switch"></div>
                        <span class="theme-label" id="topbarThemeLabel">Modo Escuro</span>
                    </div>
                    
                    <!-- Notificações -->
                    <div class="notifications">
                        <button class="notification-btn" id="notificationBtn">
                            <i class="fas fa-bell"></i>
                            <% if (notifications && notifications.unreadCount > 0) { %>
                                <span class="notification-count show"><%= notifications.unreadCount > 9 ? '9+' : notifications.unreadCount %></span>
                            <% } %>
                        </button>
                    </div>
                    
                    <!-- User Profile -->
                    <div class="user-profile" id="userProfile">
                        <div class="user-avatar" id="userAvatar">
                            <% if (safeUser.photo) { %>
                                <img src="/profile-photos/<%= safeUser.photo %>?t=<%= Date.now() %>" 
                                     alt="<%= safeUser.name %>"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <span id="userInitials" style="display:none;"><%= safeUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) %></span>
                            <% } else { %>
                                <span id="userInitials"><%= safeUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) %></span>
                            <% } %>
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="topbarStaffName"><%= safeUser.name %></div>
                            <div class="user-role" id="topbarStaffRole"><%= safeUser.role.toUpperCase() %></div>
                        </div>
                        <i class="fas fa-chevron-down" style="font-size: 12px; color: var(--text-secondary);"></i>
                    </div>
                </div>
            </div>

            <!-- User Dropdown -->
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-header">
                    <div class="user-info">
                        <div class="user-avatar" id="dropdownAvatar">
                            <% if (safeUser.photo) { %>
                                <img src="/profile-photos/<%= safeUser.photo %>?t=<%= Date.now() %>" 
                                     alt="<%= safeUser.name %>"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <span style="display:none;"><%= safeUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) %></span>
                            <% } else { %>
                                <span><%= safeUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) %></span>
                            <% } %>
                        </div>
                        <div>
                            <div class="user-name"><%= safeUser.name %></div>
                            <div class="user-role"><%= safeUser.role.toUpperCase() %></div>
                            <div class="user-email" style="font-size: 11px; color: var(--text-secondary);">
                                <%= safeUser.email %>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dropdown-body">
                    <a href="/profile" class="dropdown-item">
                        <i class="fas fa-user"></i>
                        <span>Meu Perfil</span>
                    </a>
                    <a href="/settings" class="dropdown-item">
                        <i class="fas fa-cog"></i>
                        <span>Definições</span>
                    </a>
                    <a href="/logs" class="dropdown-item">
                        <i class="fas fa-history"></i>
                        <span>Histórico</span>
                    </a>
                </div>
                <div class="dropdown-footer">
                    <button class="btn btn-secondary" id="logoutBtnDropdown">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Header -->
                <div class="logs-header">
                    <h1>
                        <i class="fas fa-clipboard-list"></i> Logs do Sistema
                    </h1>
                    <p>
                        Registo completo de todas as ações realizadas no sistema. Monitorize atividades de administradores, jogadores e eventos do sistema.
                    </p>
                </div>

                <!-- Auto Refresh -->
                <div class="auto-refresh-toggle" id="autoRefreshToggle">
                    <label for="autoRefreshCheckbox">
                        <i class="fas fa-sync-alt"></i> Atualização Automática
                        <span class="real-time-badge" id="realTimeBadge">
                            <i class="fas fa-circle"></i> TEMPO REAL
                        </span>
                    </label>
                    <div class="toggle-switch-small" id="autoRefreshSwitch"></div>
                </div>

                <!-- Stats -->
                <div class="logs-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total de Logs</div>
                        <div class="stat-value" id="totalLogs"><%= safeStats.total %></div>
                        <div class="stat-subtext" id="logPeriod">Últimos 30 dias</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Logs Hoje</div>
                        <div class="stat-value" id="todayLogs"><%= safeStats.today %></div>
                        <div class="stat-subtext" id="todayPeriod">Até agora</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Utilizadores Ativos</div>
                        <div class="stat-value" id="activeAdmins">0</div>
                        <div class="stat-subtext">Ativos nas últimas 2 horas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Taxa de Atividade</div>
                        <div class="stat-value" id="activityRate">0/min</div>
                        <div class="stat-subtext">Média por minuto</div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="filters-container">
                    <div class="filter-group">
                        <label><i class="fas fa-user"></i> Utilizador</label>
                        <select class="form-control" id="filterUser">
                            <option value="">Todos os utilizadores</option>
                            <% usersWithLogs.forEach(user => { 
                                try {
                                    const userData = JSON.parse(user.user || '{}');
                                    if (userData.name) { %>
                                        <option value="<%= user.userId %>"><%= userData.name %> (<%= userData.role || 'N/A' %>)</option>
                                    <% }
                                } catch (e) { 
                                    // Ignorar erros de parse
                                }
                            }); %>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-filter"></i> Tipo de Ação</label>
                        <select class="form-control" id="filterAction">
                            <option value="">Todos os tipos</option>
                            <option value="login">Login</option>
                            <option value="logout">Logout</option>
                            <option value="create">Criar</option>
                            <option value="update">Atualizar</option>
                            <option value="delete">Eliminar</option>
                            <option value="view">Visualizar</option>
                            <option value="approve">Aprovar</option>
                            <option value="reject">Rejeitar</option>
                            <option value="system">Sistema</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-layer-group"></i> Módulo</label>
                        <select class="form-control" id="filterModule">
                            <option value="">Todos os módulos</option>
                            <option value="auth">Autenticação</option>
                            <option value="players">Jogadores</option>
                            <option value="withdrawals">Levantamentos</option>
                            <option value="payments">Pagamentos</option>
                            <option value="staff">Staff</option>
                            <option value="support">Suporte</option>
                            <option value="settings">Definições</option>
                            <option value="system">Sistema</option>
                            <option value="email">Email</option>
                            <option value="dashboard">Dashboard</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-calendar"></i> Data Início</label>
                        <input type="date" class="form-control" id="filterDateFrom">
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-calendar"></i> Data Fim</label>
                        <input type="date" class="form-control" id="filterDateTo">
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-search"></i> Pesquisa</label>
                        <input type="text" class="form-control" id="filterSearch" placeholder="Pesquisar por mensagem, IP...">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilters()">
                            <i class="fas fa-redo"></i> Limpar
                        </button>
                    </div>
                </div>

                <!-- Botões de Exportação -->
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="exportLogs('csv')">
                        <i class="fas fa-file-csv"></i> Exportar CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportLogs('json')">
                        <i class="fas fa-file-code"></i> Exportar JSON
                    </button>
                    <% if (canManageLogs) { %>
                        <button class="btn btn-danger" onclick="confirmClearLogs()">
                            <i class="fas fa-trash"></i> Limpar Logs Antigos
                        </button>
                    <% } %>
                </div>

                <!-- Tabela de Logs -->
                <div class="logs-table-container">
                    <div class="table-header">
                        <h3>
                            <i class="fas fa-history"></i> Histórico de Atividades
                            <span class="pagination-info" id="paginationInfo">Mostrando <span id="displayedLogsCount"><%= safeLogs.length %></span> logs</span>
                        </h3>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-secondary" onclick="refreshLogs()">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sortable <%= sortParam === 'timestamp' ? 'sort-' + orderParam : '' %>" 
                                        data-sort="timestamp" onclick="sortTable('timestamp')">
                                        Data/Hora
                                    </th>
                                    <th class="sortable <%= sortParam === 'user' ? 'sort-' + orderParam : '' %>" 
                                        data-sort="user" onclick="sortTable('user')">
                                        Utilizador
                                    </th>
                                    <th class="sortable <%= sortParam === 'action' ? 'sort-' + orderParam : '' %>" 
                                        data-sort="action" onclick="sortTable('action')">
                                        Ação
                                    </th>
                                    <th class="sortable <%= sortParam === 'module' ? 'sort-' + orderParam : '' %>" 
                                        data-sort="module" onclick="sortTable('module')">
                                        Módulo
                                    </th>
                                    <th>Mensagem</th>
                                    <th class="sortable <%= sortParam === 'ip' ? 'sort-' + orderParam : '' %>" 
                                        data-sort="ip" onclick="sortTable('ip')">
                                        IP
                                    </th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <% if (safeLogs && safeLogs.length > 0) { 
                                    let logCount = 0;
                                    safeLogs.forEach(log => { 
                                        let userData = {};
                                        try {
                                            userData = JSON.parse(log.user || '{}');
                                        } catch (e) {
                                            userData = {};
                                        }
                                        
                                        logCount++;
                                %>
                                        <tr>
                                            <td>
                                                <div><%= new Date(log.timestamp).toLocaleString('pt-PT') %></div>
                                                <div class="time-ago"><%= timeAgo(log.timestamp) %></div>
                                            </td>
                                            <td>
                                                <div class="log-user">
                                                    <div class="user-avatar-small">
                                                        <%= userData.name ? userData.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'S' %>
                                                    </div>
                                                    <div>
                                                        <strong><%= userData.name || 'Sistema' %></strong>
                                                        <div style="font-size: 11px; color: var(--text-secondary);">
                                                            <%= userData.role ? roleLabels[userData.role] || userData.role : 'Sistema' %>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="log-type-badge type-<%= log.action %>">
                                                    <%= actionLabels[log.action] || log.action %>
                                                </span>
                                            </td>
                                            <td>
                                                <span style="font-weight: 500;"><%= moduleLabels[log.module] || log.module %></span>
                                            </td>
                                            <td>
                                                <div class="log-message"><%= log.message || 'Sem mensagem' %></div>
                                                <% if (log.details) { %>
                                                    <div class="log-details">
                                                        <small><%= log.details.substring(0, 100) + (log.details.length > 100 ? '...' : '') %></small>
                                                    </div>
                                                <% } %>
                                                <div class="log-meta">
                                                    <% if (log.userAgent) { %>
                                                        <span><i class="fas fa-desktop"></i> <%= log.userAgent.substring(0, 30) + (log.userAgent.length > 30 ? '...' : '') %></span>
                                                    <% } %>
                                                </div>
                                            </td>
                                            <td>
                                                <code style="font-size: 12px;"><%= log.ip || 'N/A' %></code>
                                                <% if (log.location) { %>
                                                    <div class="log-details">
                                                        <small><i class="fas fa-map-marker-alt"></i> <%= log.location %></small>
                                                    </div>
                                                <% } %>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-secondary" onclick="viewLogDetails('<%= log.id %>')" title="Ver detalhes">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    <% }); 
                                    displayedLogs = logCount;
                                    %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 60px 20px;">
                                            <div class="empty-state">
                                                <i class="fas fa-clipboard-list"></i>
                                                <h3>Nenhum log encontrado</h3>
                                                <p>Não foram encontrados logs com os filtros atuais.</p>
                                            </div>
                                        </td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginação -->
                    <% if (totalPages > 1) { %>
                        <div class="pagination" id="pagination">
                            <button onclick="changePage(<%= currentPage - 1 %>)" <%= currentPage === 1 ? 'disabled' : '' %>>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <% 
                                let startPage = Math.max(1, currentPage - 2);
                                let endPage = Math.min(totalPages, startPage + 4);
                                if (endPage - startPage < 4) {
                                    startPage = Math.max(1, endPage - 4);
                                }
                                
                                for (let i = startPage; i <= endPage; i++) { 
                            %>
                                <button onclick="changePage(<%= i %>)" <%= i === currentPage ? 'class="active"' : '' %>>
                                    <%= i %>
                                </button>
                            <% } %>
                            <button onclick="changePage(<%= currentPage + 1 %>)" <%= currentPage === totalPages ? 'disabled' : '' %>>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
        
        <!-- Modal de Detalhes do Log -->
        <div class="modal" id="logDetailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>
                        <i class="fas fa-search"></i> Detalhes do Log
                    </h3>
                    <button class="modal-close" onclick="closeLogDetails()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="logDetailsContent">
                        <!-- Conteúdo será carregado dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal de Confirmação -->
        <div class="modal" id="confirmModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-exclamation-circle"></i> Confirmação</h3>
                    <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage">Tem a certeza que deseja prosseguir?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancelar</button>
                    <button class="btn btn-danger" id="confirmActionBtn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ============ VARIÁVEIS GLOBAIS ============
        let currentPage = <%= currentPage || 1 %>;
        let totalPages = <%= totalPages || 1 %>;
        let logsPerPage = <%= limit || 50 %>;
        let currentSort = { field: '<%= sortParam %>', direction: '<%= orderParam %>' };
        let currentFilters = {};
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;
        let isLoading = false;
        let confirmCallback = null;

        // ============ INICIALIZAÇÃO ============
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            loadSavedFilters();
            setupEventListeners();
            startClock();
            
            // Iniciar atualização automática
            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
            
            // Marcar logs como lidos
            markLogsAsRead();
            
            // Aplicar classes de ordenação
            applySortClasses();
            
            // Atualizar contador de logs exibidos
            updateDisplayedLogsCount();
        });
        
        // ============ FUNÇÕES DE TEMA ============
        function initTheme() {
            const savedTheme = localStorage.getItem('velvetwin-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeUI(savedTheme);
        }
        
        function updateThemeUI(theme) {
            const label = document.getElementById('topbarThemeLabel');
            const checkbox = document.getElementById('topbarThemeCheckbox');
            
            if (theme === 'light') {
                label.textContent = 'Modo Claro';
                if (checkbox) checkbox.checked = false;
            } else {
                label.textContent = 'Modo Escuro';
                if (checkbox) checkbox.checked = true;
            }
        }
        
        // ============ CONFIGURAÇÃO DE EVENTOS ============
        function setupEventListeners() {
            // Menu toggle
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                });
            }
            
            // Overlay para fechar sidebar no mobile
            if (overlay) {
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            }
            
            // Toggle de tema
            const themeToggle = document.getElementById('topbarThemeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // User dropdown
            const userProfile = document.getElementById('userProfile');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userProfile) {
                userProfile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                });
            }
            
            // Fechar dropdowns ao clicar fora
            document.addEventListener('click', (e) => {
                // Fechar user dropdown
                if (userDropdown && !userProfile.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.style.display = 'none';
                }
            });
            
            // Auto refresh toggle
            const autoRefreshSwitch = document.getElementById('autoRefreshSwitch');
            if (autoRefreshSwitch) {
                autoRefreshSwitch.addEventListener('click', toggleAutoRefresh);
            }
            
            // Botões de logout
            document.querySelectorAll('#logoutBtn, #logoutBtnDropdown').forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        logoutUser();
                    });
                }
            });
            
            // Botão de confirmação do modal
            document.getElementById('confirmActionBtn').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                closeConfirmModal();
            });
            
            // Permitir fechar modais com ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeLogDetails();
                    closeConfirmModal();
                }
            });
            
            // Adicionar event listeners para filtros (tecla Enter)
            document.getElementById('filterSearch')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
        }
        
        // ============ FUNÇÕES DO LOGS ============
        function applyFilters() {
            currentFilters = {
                user: document.getElementById('filterUser').value,
                action: document.getElementById('filterAction').value,
                module: document.getElementById('filterModule').value,
                dateFrom: document.getElementById('filterDateFrom').value,
                dateTo: document.getElementById('filterDateTo').value,
                search: document.getElementById('filterSearch').value
            };
            
            // Redirecionar com filtros
            let url = `/logs?page=1`;
            
            Object.keys(currentFilters).forEach(key => {
                if (currentFilters[key]) {
                    url += `&${key}=${encodeURIComponent(currentFilters[key])}`;
                }
            });
            
            url += `&sort=${currentSort.field}&order=${currentSort.direction}`;
            
            window.location.href = url;
        }
        
        function resetFilters() {
            document.getElementById('filterUser').value = '';
            document.getElementById('filterAction').value = '';
            document.getElementById('filterModule').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterSearch').value = '';
            
            window.location.href = `/logs?page=1&sort=${currentSort.field}&order=${currentSort.direction}`;
        }
        
        function loadSavedFilters() {
            // Carregar filtros da URL se existirem
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.has('user')) {
                document.getElementById('filterUser').value = urlParams.get('user');
            }
            if (urlParams.has('action')) {
                document.getElementById('filterAction').value = urlParams.get('action');
            }
            if (urlParams.has('module')) {
                document.getElementById('filterModule').value = urlParams.get('module');
            }
            if (urlParams.has('dateFrom')) {
                document.getElementById('filterDateFrom').value = urlParams.get('dateFrom');
            }
            if (urlParams.has('dateTo')) {
                document.getElementById('filterDateTo').value = urlParams.get('dateTo');
            }
            if (urlParams.has('search')) {
                document.getElementById('filterSearch').value = urlParams.get('search');
            }
        }
        
        function sortTable(field) {
            currentSort.direction = currentSort.field === field && currentSort.direction === 'desc' ? 'asc' : 'desc';
            currentSort.field = field;
            
            let url = `/logs?page=${currentPage}&sort=${field}&order=${currentSort.direction}`;
            
            // Preservar filtros
            Object.keys(currentFilters).forEach(key => {
                if (currentFilters[key]) {
                    url += `&${key}=${encodeURIComponent(currentFilters[key])}`;
                }
            });
            
            window.location.href = url;
        }
        
        function applySortClasses() {
            const sortableElements = document.querySelectorAll('.sortable');
            sortableElements.forEach(el => {
                el.classList.remove('sort-asc', 'sort-desc');
                if (el.dataset.sort === currentSort.field) {
                    el.classList.add('sort-' + currentSort.direction);
                }
            });
        }
        
        function changePage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            
            let url = `/logs?page=${page}&sort=${currentSort.field}&order=${currentSort.direction}`;
            
            // Preservar filtros
            Object.keys(currentFilters).forEach(key => {
                if (currentFilters[key]) {
                    url += `&${key}=${encodeURIComponent(currentFilters[key])}`;
                }
            });
            
            window.location.href = url;
        }
        
        function updateDisplayedLogsCount() {
            const logRows = document.querySelectorAll('#logsTableBody tr');
            const countElement = document.getElementById('displayedLogsCount');
            if (countElement && logRows.length > 0) {
                // Contar apenas linhas que não são o estado vazio
                const actualRows = Array.from(logRows).filter(row => 
                    !row.querySelector('.empty-state')
                ).length;
                countElement.textContent = actualRows;
            }
        }
        
        async function viewLogDetails(logId) {
            try {
                const response = await fetch(`/api/logs/${logId}`);
                const data = await response.json();
                
                if (data.success) {
                    renderLogDetails(data.log);
                    openLogDetails();
                } else {
                    showToast('Erro ao carregar detalhes', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro de conexão', 'error');
            }
        }
        
        function renderLogDetails(log) {
            const content = document.getElementById('logDetailsContent');
            let userData = {};
            
            try {
                userData = JSON.parse(log.user || '{}');
            } catch (e) {
                userData = {};
            }
            
            content.innerHTML = `
                <div class="log-detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">ID do Log</div>
                        <div class="detail-value">${log.id}</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Data/Hora</div>
                        <div class="detail-value">
                            ${new Date(log.timestamp).toLocaleString('pt-PT')}
                            <div class="time-ago">${timeAgo(log.timestamp)}</div>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Utilizador</div>
                        <div class="detail-value">
                            <div class="log-user">
                                <div class="user-avatar-small">
                                    ${userData.name ? userData.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'S'}
                                </div>
                                <div>
                                    <strong>${userData.name || 'Sistema'}</strong>
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        ${userData.email || ''}
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-tertiary);">
                                        ${userData.role ? roleLabels[userData.role] || userData.role : 'Sistema'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Ação</div>
                        <div class="detail-value">
                            <span class="log-type-badge type-${log.action}">
                                ${actionLabels[log.action] || log.action}
                            </span>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Módulo</div>
                        <div class="detail-value">
                            <span style="font-weight: 500;">${moduleLabels[log.module] || log.module}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Mensagem</div>
                    <div class="detail-value">
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            ${escapeHtml(log.message || 'Sem mensagem')}
                        </div>
                    </div>
                </div>
                
                ${log.details ? `
                    <div class="detail-item">
                        <div class="detail-label">Detalhes</div>
                        <div class="detail-value">
                            <pre style="max-height: 200px; overflow: auto; background: var(--bg-tertiary); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color);">
${escapeHtml(log.details)}
                            </pre>
                        </div>
                    </div>
                ` : ''}
                
                <div class="log-detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Endereço IP</div>
                        <div class="detail-value">
                            <code>${log.ip || 'N/A'}</code>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Localização</div>
                        <div class="detail-value">
                            ${log.location || 'N/A'}
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">User Agent</div>
                        <div class="detail-value">
                            <small>${log.userAgent || 'N/A'}</small>
                        </div>
                    </div>
                    
                    ${log.sessionId ? `
                        <div class="detail-item">
                            <div class="detail-label">Sessão ID</div>
                            <div class="detail-value">
                                <code style="font-size: 11px;">${log.sessionId}</code>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                ${log.metadata ? `
                    <div class="detail-item">
                        <div class="detail-label">Metadados</div>
                        <div class="detail-value">
                            <pre style="max-height: 200px; overflow: auto; background: var(--bg-tertiary); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color);">
${JSON.stringify(JSON.parse(log.metadata), null, 2)}
                            </pre>
                        </div>
                    </div>
                ` : ''}
                
                <div class="detail-item">
                    <div class="detail-label">Ações</div>
                    <div class="detail-value">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="copyLogDetails()">
                                <i class="fas fa-copy"></i> Copiar Detalhes
                            </button>
                            <button class="btn btn-warning" onclick="flagLog('${log.id}')">
                                <i class="fas fa-flag"></i> Reportar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function openLogDetails() {
            document.getElementById('logDetailsModal').classList.add('active');
        }
        
        function closeLogDetails() {
            document.getElementById('logDetailsModal').classList.remove('active');
        }
        
        function copyLogDetails() {
            const content = document.getElementById('logDetailsContent');
            const text = content.innerText;
            
            navigator.clipboard.writeText(text)
                .then(() => showToast('Detalhes copiados para a área de transferência', 'success'))
                .catch(() => showToast('Erro ao copiar detalhes', 'error'));
        }
        
        async function flagLog(logId) {
            const reason = prompt('Por favor, indique o motivo do report:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/logs/${logId}/flag`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Log reportado para análise', 'success');
                } else {
                    showToast('Erro ao reportar log', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro de conexão', 'error');
            }
        }
        
        // ============ EXPORTAÇÃO ============
        async function exportLogs(format) {
            try {
                // Construir query string com filtros
                const params = new URLSearchParams();
                
                // Adicionar parâmetros de filtro atuais
                Object.keys(currentFilters).forEach(key => {
                    if (currentFilters[key]) {
                        params.append(key, currentFilters[key]);
                    }
                });
                
                params.append('format', format);
                
                showToast(`A preparar exportação em ${format.toUpperCase()}...`, 'info');
                
                // Criar URL com autenticação
                const exportUrl = `/api/logs/export?${params.toString()}`;
                
                // Criar link temporário para download
                const link = document.createElement('a');
                link.href = exportUrl;
                link.download = `logs_export_${new Date().toISOString().split('T')[0]}.${format}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('Erro na exportação:', error);
                showToast('Erro ao exportar logs', 'error');
            }
        }
        
        // ============ LIMPEZA DE LOGS ============
        function confirmClearLogs() {
            showConfirmModal('Tem a certeza que deseja limpar logs com mais de 90 dias? Esta ação não pode ser desfeita.', () => {
                clearOldLogs();
            });
        }
        
        async function clearOldLogs() {
            try {
                const response = await fetch('/api/logs/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`${data.deletedCount || 0} logs antigos foram removidos`, 'success');
                    // Recarregar página após 1.5 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast('Erro ao limpar logs: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao limpar logs:', error);
                showToast('Erro de conexão ao tentar limpar logs', 'error');
            }
        }
        
        // ============ ATUALIZAÇÃO AUTOMÁTICA ============
        function toggleAutoRefresh() {
            const switchElement = document.getElementById('autoRefreshSwitch');
            const badge = document.getElementById('realTimeBadge');
            
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                switchElement.classList.add('active');
                badge.style.display = 'inline-flex';
                startAutoRefresh();
                showToast('Atualização automática ativada', 'success');
            } else {
                switchElement.classList.remove('active');
                badge.style.display = 'none';
                stopAutoRefresh();
                showToast('Atualização automática desativada', 'warning');
            }
        }
        
        function startAutoRefresh() {
            // Atualizar a cada 30 segundos
            autoRefreshInterval = setInterval(() => {
                refreshLogs();
            }, 30000);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        function refreshLogs() {
            window.location.reload();
        }
        
        // ============ MODAL DE CONFIRMAÇÃO ============
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            confirmCallback = null;
        }
        
        // ============ UTILITÁRIOS ============
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function timeAgo(timestamp) {
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) {
                    return 'agora mesmo';
                } else if (diffMins < 60) {
                    return `há ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
                } else if (diffHours < 24) {
                    return `há ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
                } else if (diffDays === 1) {
                    return 'ontem';
                } else if (diffDays < 7) {
                    return `há ${diffDays} dia${diffDays > 1 ? 's' : ''}`;
                } else if (diffDays < 30) {
                    const weeks = Math.floor(diffDays / 7);
                    return `há ${weeks} semana${weeks > 1 ? 's' : ''}`;
                } else {
                    const months = Math.floor(diffDays / 30);
                    return `há ${months} mês${months > 1 ? 'es' : ''}`;
                }
            } catch (e) {
                return 'tempo desconhecido';
            }
        }
        
        async function markLogsAsRead() {
            try {
                await fetch('/api/logs/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                // Remover badge de logs não lidos
                const badge = document.querySelector('.menu li a[href="/logs"] .badge');
                if (badge) {
                    badge.remove();
                }
            } catch (error) {
                console.error('Erro ao marcar logs como lidos:', error);
            }
        }
        
        // ============ TOAST SYSTEM ============
        function showToast(message, type = 'info') {
            // Remover toasts existentes
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Animação de entrada
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // Remover após 4 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // ============ SERVER TIME ============
        function startClock() {
            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('pt-PT', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const serverTimeElement = document.getElementById('serverTime');
                if (serverTimeElement) {
                    serverTimeElement.textContent = timeString;
                }
            }
            
            updateClock();
            setInterval(updateClock, 1000);
        }
        
        // ============ LOGOUT ============
        function logoutUser() {
            showConfirmModal('Tem a certeza que deseja sair?', () => {
                window.location.href = '/logout';
            });
        }
        
        // ============ TEMA ============
        function toggleTheme() {
            const root = document.documentElement;
            const currentTheme = root.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            root.setAttribute('data-theme', newTheme);
            localStorage.setItem('velvetwin-theme', newTheme);
            updateThemeUI(newTheme);
            showToast(`Modo ${newTheme === 'light' ? 'Claro' : 'Escuro'} ativado`, 'info');
        }
        
        // ============ HANDLE AVATAR ERROR (SIMPLIFICADO) ============
        // Esta função não é mais necessária porque usamos onerror inline
    </script>
</body>
</html>